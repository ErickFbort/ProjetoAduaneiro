{% extends "base.html" %}

{% block title %}Sistema Aduaneiro - Home{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div id="home" class="content-section active">
        <!-- Header de Boas-vindas -->
        <div class="welcome-header animate-on-scroll fade-in-up">
            <div class="welcome-content">
                <h1 class="welcome-title">
                    <i class="fas fa-home"></i>
                    Bem-vindo(a), {{ user.name }}!
                </h1>
                <p class="welcome-subtitle">Gerencie seus processos aduaneiros de forma prática e segura</p>
                <div class="welcome-info">
                    <span class="user-role pulse">{{ user.group }}</span>
                    <span class="last-login">Último acesso: <span id="current-time"></span></span>
                </div>
            </div>
            <div class="welcome-actions">
                <!-- Notificações -->
                <div class="notification-bell-container">
                    <button class="notification-bell" id="notificationBell" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">2</span>
                    </button>
                </div>
                
                <button class="btn btn-primary scale-in delay-2" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
        </div>

        <!-- Ações Rápidas Personalizáveis -->
        <div class="quick-actions-main animate-on-scroll fade-in-up delay-1">
            <div class="quick-actions-header">
                <h2><i class="fas fa-star"></i> Acesso Rápido</h2>
                
                <!-- Abas para layout com separação Aéreo/Marítimo - Centralizadas -->
                <div id="favorites-tabs-container" style="display: none;">
                    <div class="favorites-tabs">
                        <button class="favorites-tab active" onclick="switchFavoritesTab('aereo')" id="favorites-tab-aereo">
                            <i class="fas fa-plane"></i> Aéreo
                        </button>
                        <button class="favorites-tab" onclick="switchFavoritesTab('maritimo')" id="favorites-tab-maritimo">
                            <i class="fas fa-ship"></i> Marítimo
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-outline-primary btn-sm" onclick="openFavoritesModal()" title="Personalizar favoritos" id="personalizarBtn">
                    <i class="fas fa-cog"></i> Personalizar
                </button>
            </div>
            
            <div class="quick-actions-grid-main" id="favorite-actions">
                <!-- Ações favoritas serão carregadas dinamicamente -->
            </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="stats-grid">
            <div class="stat-card animate-on-scroll fade-in-left delay-1 stat-progress">
                <div class="stat-icon">
                    <i class="fas fa-users pulse"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-users">-</h3>
                    <p>Usuários Ativos</p>
                </div>
            </div>
            <div class="stat-card animate-on-scroll fade-in-left delay-2 stat-progress">
                <div class="stat-icon">
                    <i class="fas fa-truck pulse"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-vehicles">-</h3>
                    <p>Veículos Cadastrados</p>
                </div>
            </div>
            <div class="stat-card animate-on-scroll fade-in-right delay-3 stat-progress">
                <div class="stat-icon">
                    <i class="fas fa-building pulse"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-entities">-</h3>
                    <p>Entidades Cadastradas</p>
                </div>
            </div>
            <div class="stat-card animate-on-scroll fade-in-right delay-4 stat-progress">
                <div class="stat-icon">
                    <i class="fas fa-chart-line pulse"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-processes">-</h3>
                    <p>Processos em Andamento</p>
                </div>
            </div>
        </div>

        <!-- Grid Principal -->
        <div class="home-grid">
            <!-- Seção de Novidades e Comunicados -->
            <div class="news-section animate-on-scroll slide-in-bottom delay-2">
                <div class="section-header">
                    <h2><i class="fas fa-newspaper"></i> Novidades e Comunicados</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline-primary btn-sm scale-in delay-3" onclick="refreshNews()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                        <button class="btn btn-outline-warning btn-sm scale-in delay-4" onclick="forceRefreshLinkedIn()" title="Forçar atualização do LinkedIn (limpar cache)">
                            <i class="fas fa-refresh"></i> Forçar LinkedIn
                        </button>
                    </div>
                </div>
                <div class="news-content">
                    <div class="news-tabs">
                        <button class="tab-btn" onclick="switchNewsTab('paclog')">
                            <i class="fas fa-globe"></i> Pac Log
                        </button>
                        <button class="tab-btn active" onclick="switchNewsTab('linkedin')">
                            <i class="fab fa-linkedin"></i> LinkedIn
                        </button>
                        <button class="tab-btn" onclick="switchNewsTab('sistema')">
                            <i class="fas fa-cog"></i> Atualizações do Sistema
                        </button>
                    </div>
                    <div class="news-list" id="news-content">
                        <!-- Conteúdo será carregado via JavaScript -->
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando novidades...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Terminais Aéreos (TECA) -->
            <div class="terminals-section animate-on-scroll fade-in-right delay-3">
                <div class="section-header">
                    <h2><i class="fas fa-plane"></i> Operações por Terminal Aéreo</h2>
                    <div class="section-actions">
                        <button class="btn btn-outline-primary btn-sm scale-in delay-4" onclick="refreshTerminals()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="terminals-grid">
                    <div class="terminal-card animate-on-scroll fade-in-up delay-1">
                        <div class="terminal-header">
                            <h3><i class="fas fa-map-marker-alt pulse"></i> CWB - Curitiba</h3>
                            <span class="terminal-status active">Ativo</span>
                        </div>
                        <div class="terminal-info">
                            <p><strong>Telefone:</strong> +55 47 3515.0802</p>
                            <p><strong>Operações:</strong> Import/Export</p>
                            <p><strong>Status:</strong> <span class="status-badge success">Operacional</span></p>
                        </div>
                        <div class="terminal-actions">
                            <button class="btn btn-sm btn-outline-primary scale-in delay-2" onclick="viewTerminalDetails('CWB')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>

                    <div class="terminal-card animate-on-scroll fade-in-up delay-2">
                        <div class="terminal-header">
                            <h3><i class="fas fa-map-marker-alt pulse"></i> GYN - Goiânia</h3>
                            <span class="terminal-status active">Ativo</span>
                        </div>
                        <div class="terminal-info">
                            <p><strong>Telefone:</strong> +55 47 3515.0801</p>
                            <p><strong>Operações:</strong> Import/Export</p>
                            <p><strong>Status:</strong> <span class="status-badge success">Operacional</span></p>
                        </div>
                        <div class="terminal-actions">
                            <button class="btn btn-sm btn-outline-primary scale-in delay-3" onclick="viewTerminalDetails('GYN')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>

                    <div class="terminal-card animate-on-scroll fade-in-up delay-3">
                        <div class="terminal-header">
                            <h3><i class="fas fa-map-marker-alt pulse"></i> REC - Recife</h3>
                            <span class="terminal-status active">Ativo</span>
                        </div>
                        <div class="terminal-info">
                            <p><strong>Telefone:</strong> +55 47 3515-0803</p>
                            <p><strong>Operações:</strong> Import/Export</p>
                            <p><strong>Status:</strong> <span class="status-badge success">Operacional</span></p>
                        </div>
                        <div class="terminal-actions">
                            <button class="btn btn-sm btn-outline-primary scale-in delay-4" onclick="viewTerminalDetails('REC')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>

                    <div class="terminal-card animate-on-scroll fade-in-up delay-4">
                        <div class="terminal-header">
                            <h3><i class="fas fa-map-marker-alt pulse"></i> VIX - Vitória</h3>
                            <span class="terminal-status active">Ativo</span>
                        </div>
                        <div class="terminal-info">
                            <p><strong>Telefone:</strong> +55 47 3515.0805</p>
                            <p><strong>Operações:</strong> Import/Export</p>
                            <p><strong>Status:</strong> <span class="status-badge success">Operacional</span></p>
                        </div>
                        <div class="terminal-actions">
                            <button class="btn btn-sm btn-outline-primary scale-in delay-5" onclick="viewTerminalDetails('VIX')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>

                    <div class="terminal-card animate-on-scroll fade-in-up delay-5">
                        <div class="terminal-header">
                            <h3><i class="fas fa-map-marker-alt pulse"></i> NVT - Navegantes</h3>
                            <span class="terminal-status active">Ativo</span>
                        </div>
                        <div class="terminal-info">
                            <p><strong>Telefone:</strong> +55 47 3515.0804</p>
                            <p><strong>Operações:</strong> Import/Export</p>
                            <p><strong>Status:</strong> <span class="status-badge success">Operacional</span></p>
                        </div>
                        <div class="terminal-actions">
                            <button class="btn btn-sm btn-outline-primary scale-in delay-6" onclick="viewTerminalDetails('NVT')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<!-- Modal para Detalhes do Terminal -->
<div class="modal fade" id="terminalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="terminalModalTitle">Detalhes do Terminal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="terminalModalBody">
                <!-- Conteúdo será carregado via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Personalizar Favoritos -->
<div class="modal fade" id="favoritesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
                   <div class="modal-header">
                       <h5 class="modal-title">
                           <i class="fas fa-star"></i> Personalizar Acesso Rápido
                       </h5>
                       <div class="d-flex align-items-center gap-2">
                           <button type="button" class="btn btn-success btn-sm" onclick="saveFavorites()" title="Salvar configuração">
                               <i class="fas fa-save"></i> Salvar
                           </button>
                           <button type="button" class="btn btn-secondary btn-sm" onclick="cancelFavorites()" title="Cancelar alterações">
                               <i class="fas fa-times"></i> Cancelar
                           </button>
                           <button type="button" class="btn-close" onclick="cancelFavorites()"></button>
                       </div>
                   </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Gerencie seus favoritos e personalize o acesso rápido do sistema.</p>
                
                <!-- Abas para Favoritos, Pers Aéreo, Pers Marítimo e Layout -->
                <ul class="nav nav-tabs mb-4" id="favoritesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="favorites-tab" data-bs-toggle="tab" data-bs-target="#favorites-pane" type="button" role="tab">
                            <i class="fas fa-star"></i> Favoritos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="personalize-aereo-tab" data-bs-toggle="tab" data-bs-target="#personalize-aereo-pane" type="button" role="tab">
                            <i class="fas fa-plane"></i> Pers Aéreo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="personalize-maritimo-tab" data-bs-toggle="tab" data-bs-target="#personalize-maritimo-pane" type="button" role="tab">
                            <i class="fas fa-ship"></i> Pers Marítimo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="layout-tab" data-bs-toggle="tab" data-bs-target="#layout-pane" type="button" role="tab">
                            <i class="fas fa-th"></i> Layout
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="favoritesTabContent">
                           <!-- Aba Favoritos -->
                           <div class="tab-pane fade show active" id="favorites-pane" role="tabpanel">
                               <div class="favorites-management">
                                   <div class="d-flex justify-content-between align-items-center mb-3">
                                       <h6><i class="fas fa-sort"></i> Organize seus favoritos</h6>
                                       <small class="text-muted">Arraste os cards para reorganizar</small>
                                   </div>
                                   <div class="favorites-drag-container" id="favorites-drag-container">
                                       <!-- Módulos e submódulos selecionados serão carregados via JavaScript -->
                                   </div>
                               </div>
                           </div>
                    
                    <!-- Aba Pers Aéreo -->
                    <div class="tab-pane fade" id="personalize-aereo-pane" role="tabpanel">
                        <div class="personalize-layout" id="personalize-aereo-layout">
                            <!-- Módulos aéreos disponíveis para seleção -->
                        </div>
                    </div>
                    
                    <!-- Aba Pers Marítimo -->
                    <div class="tab-pane fade" id="personalize-maritimo-pane" role="tabpanel">
                        <div class="personalize-layout" id="personalize-maritimo-layout">
                            <!-- Módulos marítimos disponíveis para seleção -->
                        </div>
                    </div>
                    
                    <!-- Aba Layout -->
                    <div class="tab-pane fade" id="layout-pane" role="tabpanel">
                        <div class="layout-selection">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6><i class="fas fa-th"></i> Escolha o Layout dos Favoritos</h6>
                                <small class="text-muted">Selecione o layout que melhor se adapta ao seu uso</small>
                            </div>
                            
                            <div class="row">
                                <!-- Layout 1: Quadrados Separados -->
                                <div class="col-12 mb-4">
                                    <div class="layout-option" data-layout="quadrados">
                                        <div class="layout-preview">
                                            <div class="preview-header">
                                                <h6>Layout 1: Quadrados Separados</h6>
                                                <p class="text-muted small">Aéreo e Marítimo em áreas distintas</p>
                                            </div>
                                            <div class="preview-content">
                                                <div class="preview-sections-container">
                                                    <div class="preview-section aereo-section">
                                                        <div class="preview-label">Aéreo</div>
                                                        <div class="preview-grid">
                                                            <div class="preview-card">
                                                                <i class="fas fa-file-invoice"></i>
                                                                <span>Faturamento</span>
                                                            </div>
                                                            <div class="preview-card">
                                                                <i class="fas fa-cube"></i>
                                                                <span>Processo</span>
                                                            </div>
                                                            <div class="preview-card">
                                                                <i class="fas fa-box"></i>
                                                                <span>Guias</span>
                                                            </div>
                                                            <div class="preview-card">
                                                                <i class="fas fa-warehouse"></i>
                                                                <span>Recinto</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="preview-section maritimo-section">
                                                        <div class="preview-label">Marítimo</div>
                                                        <div class="preview-grid">
                                                            <div class="preview-card">
                                                                <i class="fas fa-ship"></i>
                                                                <span>SSE/STC</span>
                                                            </div>
                                                            <div class="preview-card">
                                                                <i class="fas fa-user"></i>
                                                                <span>Usuário</span>
                                                            </div>
                                                            <div class="preview-card">
                                                                <i class="fas fa-globe"></i>
                                                                <span>Web Clientes</span>
                                                            </div>
                                                            <div class="preview-card">
                                                                <i class="fas fa-warehouse"></i>
                                                                <span>Armazém</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layout-actions">
                                            <button class="btn btn-outline-primary btn-sm" onclick="selectLayout('quadrados')">
                                                <i class="fas fa-check"></i> Selecionar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Layout 2: Layout sem separação -->
                                <div class="col-12 mb-4">
                                    <div class="layout-option" data-layout="atual">
                                        <div class="layout-preview">
                                            <div class="preview-header">
                                                <h6>Layout 2: Layout sem separação</h6>
                                                <p class="text-muted small">Layout padrão sem separação por tipo</p>
                                            </div>
                                            <div class="preview-content">
                                                <div class="preview-current-layout">
                                                    <div class="preview-favorites-grid">
                                                        <div class="preview-card">
                                                            <i class="fas fa-file-invoice"></i>
                                                            <span>Faturamento</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-warehouse"></i>
                                                            <span>Recinto</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-cube"></i>
                                                            <span>Processo</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-box"></i>
                                                            <span>Guias</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-globe"></i>
                                                            <span>Web Clientes</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-ship"></i>
                                                            <span>SSE/STC</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layout-actions">
                                            <button class="btn btn-outline-primary btn-sm" onclick="selectLayout('atual')">
                                                <i class="fas fa-check"></i> Selecionar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Layout 3: Com Abas Aéreo/Marítimo -->
                                <div class="col-12 mb-4">
                                    <div class="layout-option" data-layout="abas">
                                        <div class="layout-preview">
                                            <div class="preview-header">
                                                <h6>Layout 3: Com Abas Aéreo/Marítimo</h6>
                                                <p class="text-muted small">Layout atual com abas para separar Aéreo e Marítimo</p>
                                            </div>
                                            <div class="preview-content">
                                                <div class="preview-current-layout">
                                                    <div class="preview-nav">
                                                        <button class="preview-nav-btn active">
                                                            <i class="fas fa-plane"></i> Aéreo
                                                        </button>
                                                        <button class="preview-nav-btn">
                                                            <i class="fas fa-ship"></i> Marítimo
                                                        </button>
                                                    </div>
                                                    <div class="preview-favorites-grid">
                                                        <div class="preview-card">
                                                            <i class="fas fa-file-invoice"></i>
                                                            <span>Faturamento</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-warehouse"></i>
                                                            <span>Recinto</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-cube"></i>
                                                            <span>Processo</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-box"></i>
                                                            <span>Guias</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-globe"></i>
                                                            <span>Web Clientes</span>
                                                        </div>
                                                        <div class="preview-card">
                                                            <i class="fas fa-ship"></i>
                                                            <span>SSE/STC</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="layout-actions">
                                            <button class="btn btn-outline-primary btn-sm" onclick="selectLayout('abas')">
                                                <i class="fas fa-check"></i> Selecionar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                   <div class="modal-footer">
                       <small class="text-muted">
                           <i class="fas fa-info-circle"></i> Use os botões no cabeçalho para salvar ou cancelar suas alterações
                       </small>
                   </div>
        </div>
    </div>
</div>

<!-- Modal para Upload de Avatar -->
<div class="modal fade avatar-upload-modal" id="avatarUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-camera"></i> Alterar Foto de Perfil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img src="{{ url_for('static', filename='img/user-avatar-placeholder.svg') }}" 
                         alt="Preview do avatar" 
                         class="avatar-preview" 
                         id="avatar-preview">
                </div>
                
                <div class="avatar-upload-area" id="avatar-upload-area">
                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                    <h6 class="mb-1">Arraste uma imagem aqui ou clique para selecionar</h6>
                    <p class="text-muted small mb-0">Formatos aceitos: JPG, PNG, GIF (máx. 2MB)</p>
                    <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
                </div>
                
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('avatar-file-input').click()">
                        <i class="fas fa-folder-open"></i> Escolher Arquivo
                    </button>
                </div>
                
                <div class="mb-3">
                    <label for="job-title-input" class="form-label">
                        <i class="fas fa-briefcase"></i> Cargo/Função
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="job-title-input" 
                           placeholder="Ex: Analista de Sistemas, Gerente, etc."
                           value="{{ user.job_title or '' }}">
                    <div class="form-text">Informe seu cargo ou função na empresa (opcional)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="uploadAvatar()" id="upload-avatar-btn">
                    <i class="fas fa-save"></i> Salvar Informações
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados dos terminais
const terminalsData = {
    'CWB': {
        name: 'Curitiba',
        phone: '+55 47 3515.0802',
        operations: ['Import', 'Export', 'Transbordo'],
        status: 'Operacional',
        lastUpdate: '2024-01-15',
        notes: 'Terminal operando normalmente com capacidade total.'
    },
    'GYN': {
        name: 'Goiânia',
        phone: '+55 47 3515.0801',
        operations: ['Import', 'Export'],
        status: 'Operacional',
        lastUpdate: '2024-01-15',
        notes: 'Novas operações de carga perigosa implementadas.'
    },
    'REC': {
        name: 'Recife',
        phone: '+55 47 3515-0803',
        operations: ['Import', 'Export', 'Transbordo'],
        status: 'Operacional',
        lastUpdate: '2024-01-14',
        notes: 'Expansão da área de armazenagem concluída.'
    },
    'VIX': {
        name: 'Vitória',
        phone: '+55 47 3515.0805',
        operations: ['Import', 'Export'],
        status: 'Operacional',
        lastUpdate: '2024-01-15',
        notes: 'Sistema de rastreamento atualizado.'
    },
    'NVT': {
        name: 'Navegantes',
        phone: '+55 47 3515.0804',
        operations: ['Import', 'Export', 'Transbordo'],
        status: 'Operacional',
        lastUpdate: '2024-01-15',
        notes: 'Nova linha de processamento de cargas especiais.'
    }
};

// Dados de notícias (carregados dinamicamente da API)
let newsData = {
    paclog: [
        {
            id: 1,
            title: 'Novo sistema de rastreamento implementado',
            date: '2024-01-15',
            category: 'Tecnologia',
            content: 'Sistema de rastreamento em tempo real foi implementado em todos os terminais.',
            source: 'Comunicados Pac Log'
        },
        {
            id: 2,
            title: 'Expansão da área de armazenagem em Recife',
            date: '2024-01-14',
            category: 'Infraestrutura',
            content: 'Nova área de 5.000m² foi inaugurada no terminal de Recife.',
            source: 'Comunicados Pac Log'
        },
        {
            id: 3,
            title: 'Novas operações de carga perigosa em Goiânia',
            date: '2024-01-12',
            category: 'Operações',
            content: 'Terminal de Goiânia agora processa cargas perigosas classe 1.',
            source: 'Comunicados Pac Log'
        }
    ],
    linkedin: [],
    sistema: [
        {
            id: 1,
            title: 'Versão 2.1.0 - Nova funcionalidade de Autorização de Carregamento',
            date: '2024-01-20',
            category: 'Funcionalidade',
            content: 'Implementada nova funcionalidade completa de autorização de carregamento com formulário dinâmico e validações avançadas.',
            source: 'Sistema Aduaneiro',
            version: '2.1.0',
            type: 'feature'
        },
        {
            id: 2,
            title: 'Correção de bugs na interface de processos',
            date: '2024-01-18',
            category: 'Correção',
            content: 'Corrigidos problemas de responsividade e validação de formulários na seção de processos.',
            source: 'Sistema Aduaneiro',
            version: '2.0.8',
            type: 'bugfix'
        },
        {
            id: 3,
            title: 'Melhorias de performance no dashboard',
            date: '2024-01-16',
            category: 'Melhoria',
            content: 'Otimizações realizadas para melhorar o tempo de carregamento do dashboard principal.',
            source: 'Sistema Aduaneiro',
            version: '2.0.7',
            type: 'improvement'
        },
        {
            id: 4,
            title: 'Nova funcionalidade de personalização de cards',
            date: '2024-01-14',
            category: 'Funcionalidade',
            content: 'Usuários agora podem personalizar a ordem dos cards na tela inicial arrastando e soltando.',
            source: 'Sistema Aduaneiro',
            version: '2.0.6',
            type: 'feature'
        }
    ]
};

let currentNewsTab = 'linkedin';
let newsTimer = null;
let isHovering = false;
let autoRotateInterval = 8000; // 8 segundos entre trocas

// Carregar estatísticas
async function loadStats() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-users').textContent = data.data.users;
            document.getElementById('total-vehicles').textContent = data.data.vehicles;
            document.getElementById('total-entities').textContent = data.data.entities;
            document.getElementById('total-processes').textContent = data.data.processes;
        } else {
            // Fallback para dados simulados
            document.getElementById('total-users').textContent = '12';
            document.getElementById('total-vehicles').textContent = '45';
            document.getElementById('total-entities').textContent = '128';
            document.getElementById('total-processes').textContent = '23';
        }
    } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
        // Fallback para dados simulados
        document.getElementById('total-users').textContent = '12';
        document.getElementById('total-vehicles').textContent = '45';
        document.getElementById('total-entities').textContent = '128';
        document.getElementById('total-processes').textContent = '23';
    }
}

// Carregar posts do LinkedIn da API
async function loadLinkedInPosts() {
    try {
        // Usar dados simulados por padrão para garantir qualidade
        const response = await fetch('/api/linkedin/posts?limit=5&force_simulated=true');
        const data = await response.json();
        
        if (data.success) {
            newsData.linkedin = data.data;
            console.log(`Carregados ${data.count} posts do LinkedIn (${data.source})`);
        } else {
            console.error('Erro ao carregar posts do LinkedIn:', data.error);
            // Manter dados existentes ou usar fallback
        }
    } catch (error) {
        console.error('Erro ao carregar posts do LinkedIn:', error);
    }
}

// Carregar notícias
function loadNews(tab = 'linkedin') {
    const newsContent = document.getElementById('news-content');
    const news = newsData[tab] || [];
    
    if (news.length === 0) {
        newsContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-newspaper fa-2x text-muted"></i>
                <p>Nenhuma notícia disponível no momento.</p>
            </div>
        `;
        return;
    }
    
    if (tab === 'linkedin') {
        newsContent.innerHTML = news.map(item => `
            <div class="linkedin-post" onclick="openLinkedInPost('${item.url}')">
                <div class="post-header">
                    <div class="author-info">
                        <img src="${item.author_image || item.authorImage}" alt="${item.author}" class="author-avatar">
                        <div class="author-details">
                            <h4 class="author-name">${item.author}</h4>
                            <span class="post-date">${formatDate(item.date)}</span>
                        </div>
                    </div>
                    <div class="post-category">
                        <span class="category-badge">${item.category}</span>
                    </div>
                </div>
                
                <div class="post-content">
                    <h3 class="post-title">${item.title}</h3>
                    <p class="post-subtitle">${item.subtitle}</p>
                </div>
                
                <div class="post-image-container">
                    <img src="${item.image}" alt="${item.title}" class="post-image">
                    <div class="image-overlay">
                        <div class="overlay-content">
                            <i class="fab fa-linkedin"></i>
                            <span>Ver mais</span>
                        </div>
                    </div>
                </div>
                
                <div class="post-engagement">
                    <div class="engagement-stats">
                        <span class="likes-count">${item.likes} curtidas</span>
                        <span class="comments-shares">${item.comments} comentários • ${item.shares} compartilhamentos</span>
                    </div>
                </div>
            </div>
        `).join('');
    } else if (tab === 'sistema') {
        newsContent.innerHTML = news.map(item => `
            <div class="system-update-item" onmouseenter="pauseNewsRotation()" onmouseleave="resumeNewsRotation()">
                <div class="update-header">
                    <div class="update-icon">
                        <i class="fas fa-${getUpdateIcon(item.type)}"></i>
                    </div>
                    <div class="update-info">
                        <h4 class="update-title">${item.title}</h4>
                        <div class="update-meta">
                            <span class="update-version">v${item.version}</span>
                            <span class="update-date">${formatDate(item.date)}</span>
                        </div>
                    </div>
                    <div class="update-badge">
                        <span class="badge badge-${getUpdateBadgeClass(item.type)}">${item.category}</span>
                    </div>
                </div>
                <div class="update-content">
                    <p>${item.content}</p>
                </div>
                <div class="update-footer">
                    <span class="update-source">${item.source}</span>
                </div>
            </div>
        `).join('');
    } else {
        newsContent.innerHTML = news.map(item => `
            <div class="news-item" onmouseenter="pauseNewsRotation()" onmouseleave="resumeNewsRotation()">
                <div class="news-header">
                    <h4>${item.title}</h4>
                    <span class="news-date">${formatDate(item.date)}</span>
                </div>
                <div class="news-meta">
                    <span class="news-category">${item.category}</span>
                    <span class="news-source">${item.source}</span>
                </div>
                <div class="news-content">
                    <p>${item.content}</p>
                </div>
            </div>
        `).join('');
    }
}

// Funções auxiliares para atualizações do sistema
function getUpdateIcon(type) {
    const icons = {
        'feature': 'star',
        'bugfix': 'bug',
        'improvement': 'arrow-up',
        'security': 'shield-alt',
        'maintenance': 'tools'
    };
    return icons[type] || 'info-circle';
}

function getUpdateBadgeClass(type) {
    const classes = {
        'feature': 'success',
        'bugfix': 'warning',
        'improvement': 'info',
        'security': 'danger',
        'maintenance': 'secondary'
    };
    return classes[type] || 'primary';
}

// Alternar aba de notícias
function switchNewsTab(tab) {
    currentNewsTab = tab;
    
    // Atualizar botões
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Carregar conteúdo
    loadNews(tab);
    
    // Reiniciar timer se estiver ativo
    if (newsTimer) {
        clearInterval(newsTimer);
        startNewsRotation();
    }
}

// Sistema de rotação automática
function startNewsRotation() {
    if (newsTimer) {
        clearInterval(newsTimer);
    }
    
    const tabs = ['paclog', 'linkedin', 'sistema'];
    let currentIndex = tabs.indexOf(currentNewsTab);
    
    newsTimer = setInterval(() => {
        if (!isHovering) {
            currentIndex = (currentIndex + 1) % tabs.length;
            const nextTab = tabs[currentIndex];
            
            // Atualizar botões
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[onclick="switchNewsTab('${nextTab}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Carregar conteúdo
            currentNewsTab = nextTab;
            loadNews(nextTab);
        }
    }, autoRotateInterval);
}

// Pausar rotação no hover
function pauseNewsRotation() {
    isHovering = true;
}

// Retomar rotação ao sair do hover
function resumeNewsRotation() {
    isHovering = false;
}

// Atualizar notícias
async function refreshNews() {
    if (currentNewsTab === 'linkedin') {
        await loadLinkedInPosts();
    }
    // Para Pac Log, os dados são estáticos, então apenas recarregamos
    loadNews(currentNewsTab);
    FeedbackManager.showSuccess('Notícias atualizadas!');
}

// Forçar atualização do LinkedIn (limpar cache)
async function forceRefreshLinkedIn() {
    try {
        // Primeiro tentar scraping real
        const response = await fetch('/api/linkedin/posts?limit=5&force_simulated=false');
        const data = await response.json();
        
        if (data.success) {
            newsData.linkedin = data.data;
            loadNews('linkedin');
            FeedbackManager.showSuccess(`LinkedIn atualizado! ${data.count} posts carregados (${data.source})`);
        } else {
            // Se falhar, usar dados simulados
            const simulatedResponse = await fetch('/api/linkedin/posts?limit=5&force_simulated=true');
            const simulatedData = await simulatedResponse.json();
            
            if (simulatedData.success) {
                newsData.linkedin = simulatedData.data;
                loadNews('linkedin');
                FeedbackManager.showInfo('Usando dados simulados do LinkedIn');
            } else {
                FeedbackManager.showError('Erro ao atualizar LinkedIn');
            }
        }
    } catch (error) {
        console.error('Erro ao forçar atualização:', error);
        FeedbackManager.showError('Erro ao atualizar LinkedIn');
    }
}

// Atualizar terminais
function refreshTerminals() {
    FeedbackManager.showSuccess('Informações dos terminais atualizadas!');
}

// Ver detalhes do terminal
function viewTerminalDetails(terminalCode) {
    const terminal = terminalsData[terminalCode];
    if (!terminal) return;
    
    document.getElementById('terminalModalTitle').textContent = `Terminal ${terminalCode} - ${terminal.name}`;
    document.getElementById('terminalModalBody').innerHTML = `
        <div class="terminal-details">
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações Básicas</h6>
                    <p><strong>Nome:</strong> ${terminal.name}</p>
                    <p><strong>Telefone:</strong> ${terminal.phone}</p>
                    <p><strong>Status:</strong> <span class="status-badge success">${terminal.status}</span></p>
                </div>
                <div class="col-md-6">
                    <h6>Operações</h6>
                    <ul>
                        ${terminal.operations.map(op => `<li>${op}</li>`).join('')}
                    </ul>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Última Atualização</h6>
                    <p>${formatDate(terminal.lastUpdate)}</p>
                    <h6>Observações</h6>
                    <p>${terminal.notes}</p>
                </div>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('terminalModal')).show();
}


// Abrir post do LinkedIn
function openLinkedInPost(url) {
    window.open(url, '_blank');
}

// Formatar data
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

// Atualizar data e hora atual
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

// Sistema de animações de scroll
function initScrollAnimations() {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
                
                // Adicionar animação específica baseada na classe
                if (entry.target.classList.contains('fade-in-up')) {
                    entry.target.classList.add('fade-in-up');
                } else if (entry.target.classList.contains('fade-in-left')) {
                    entry.target.classList.add('fade-in-left');
                } else if (entry.target.classList.contains('fade-in-right')) {
                    entry.target.classList.add('fade-in-right');
                } else if (entry.target.classList.contains('slide-in-bottom')) {
                    entry.target.classList.add('slide-in-bottom');
                } else if (entry.target.classList.contains('scale-in')) {
                    entry.target.classList.add('scale-in');
                }
            }
        });
    }, observerOptions);

    // Observar todos os elementos com animação
    document.querySelectorAll('.animate-on-scroll').forEach(el => {
        observer.observe(el);
    });
}

// Efeito de contagem animada para estatísticas
function animateCounters() {
    const counters = document.querySelectorAll('#total-users, #total-vehicles, #total-entities, #total-processes');
    
    counters.forEach(counter => {
        const target = parseInt(counter.textContent);
        if (isNaN(target)) return;
        
        let current = 0;
        const increment = target / 50; // 50 steps
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                counter.textContent = target;
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(current);
            }
        }, 30);
    });
}

// Efeito de parallax sutil
function initParallax() {
    window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        const parallaxElements = document.querySelectorAll('.parallax-element');
        
        parallaxElements.forEach(element => {
            const speed = 0.5;
            element.style.transform = `translateY(${scrolled * speed}px)`;
        });
    });
}

// Efeito de typing removido conforme solicitado

// Teste de clique no botão personalizar
document.addEventListener('DOMContentLoaded', function() {
    const personalizarBtn = document.getElementById('personalizarBtn');
    if (personalizarBtn) {
        console.log('Botão personalizar encontrado:', personalizarBtn);
        personalizarBtn.addEventListener('click', function(e) {
            console.log('Botão personalizar clicado!');
            e.preventDefault();
            openFavoritesModal();
        });
    } else {
        console.error('Botão personalizar não encontrado!');
    }
    
    // Atalho de teclado para limpar modal (Ctrl+Shift+M)
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'M') {
            e.preventDefault();
            console.log('Atalho de teclado detectado: Ctrl+Shift+M');
            forceCloseModal();
        }
    });
});

// Sistema de Favoritos Personalizáveis - Módulos e Submódulos
let favoriteModules = {
    // Módulo Cadastro
    'cadastro': {
        name: 'Cadastro',
        icon: 'fas fa-edit',
        url: "{{ url_for('cadastros.cadastros') }}",
        description: 'Módulo completo de cadastros',
        type: 'main_module',
        submodules: {
            'usuarios': {
                name: 'Usuários',
                icon: 'fas fa-user-plus',
                url: "{{ url_for('cadastros.cadastros_usuarios') }}",
                description: 'Gerenciar usuários do sistema'
            },
            'veiculos': {
                name: 'Veículos',
                icon: 'fas fa-truck',
                url: "{{ url_for('cadastros.cadastros_veiculos') }}",
                description: 'Gerenciar frota de veículos'
            },
            'entidades': {
                name: 'Entidades',
                icon: 'fas fa-building',
                url: "{{ url_for('cadastros.cadastros_entidades') }}",
                description: 'Gerenciar entidades/clientes'
            },
            'contratos': {
                name: 'Contratos',
                icon: 'fas fa-file-contract',
                url: '#',
                description: 'Gerenciar contratos'
            },
            'desconto': {
                name: 'Desconto',
                icon: 'fas fa-percentage',
                url: '#',
                description: 'Gerenciar descontos'
            }
        }
    },
    
    
    // Módulo Web Cliente
    'web_cliente': {
        name: 'Web Cliente',
        icon: 'fas fa-user-tie',
        url: "{{ url_for('web_clientes.web_clientes') }}",
        description: 'Módulo completo para clientes',
        type: 'main_module',
        submodules: {
            'processos': {
                name: 'Processos',
                icon: 'fas fa-box',
                url: "{{ url_for('web_clientes.web_clientes_processos') }}",
                description: 'Processos aduaneiros'
            },
            'dape_sem_carga': {
                name: 'DAPE sem Carga',
                icon: 'fas fa-file-alt',
                url: "{{ url_for('web_clientes.web_clientes_dape_sem_carga') }}",
                description: 'DAPE sem carga'
            },
            'agendamento_carregamento': {
                name: 'Agendamento de Carregamento',
                icon: 'fas fa-truck',
                url: "{{ url_for('web_clientes.web_clientes_agendamento_carregamento') }}",
                description: 'Agendamento de carregamento'
            },
            'agendamento_vistorias': {
                name: 'Agendamento de Vistorias',
                icon: 'fas fa-search',
                url: "{{ url_for('web_clientes.web_clientes_agendamento_vistorias') }}",
                description: 'Agendamento de vistorias'
            },
            'perdimento': {
                name: 'Perdimento',
                icon: 'fas fa-exclamation-triangle',
                url: "{{ url_for('web_clientes.web_clientes_perdimento') }}",
                description: 'Perdimento de cargas'
            },
            'autorizacao_carregamento': {
                name: 'Autorização de Carregamento',
                icon: 'fas fa-check-circle',
                url: "{{ url_for('web_clientes.web_clientes_autorizacao_carregamento') }}",
                description: 'Autorização de carregamento'
            },
            'acompanhamento_despachante': {
                name: 'Acompanhamento Despachante',
                icon: 'fas fa-user-check',
                url: "{{ url_for('web_clientes.web_clientes_acompanhamento_despachante') }}",
                description: 'Acompanhe processos em aberto dos despachantes'
            },
            'acompanhamento_motorista': {
                name: 'Acompanhamento Motorista',
                icon: 'fas fa-truck',
                url: "{{ url_for('web_clientes.web_clientes_acompanhamento_motorista') }}",
                description: 'Acompanhe processos e atividades dos motoristas'
            }
        }
    },
    
    // Módulo Relatórios
    'relatorios': {
        name: 'Relatórios',
        icon: 'fas fa-chart-bar',
        url: "{{ url_for('reports.relatorios_main') }}",
        description: 'Módulo completo de relatórios',
        type: 'main_module',
        submodules: {
            'configuracao': {
                name: 'Configuração',
                icon: 'fas fa-cog',
                url: "{{ url_for('reports.relatorios_configuracao') }}",
                description: 'Configurar relatórios'
            },
            'comercial': {
                name: 'Comercial',
                icon: 'fas fa-file-alt',
                url: "{{ url_for('reports.relatorios_comercial') }}",
                description: 'Relatórios comerciais'
            },
            'faturamento': {
                name: 'Faturamento',
                icon: 'fas fa-dollar-sign',
                url: "{{ url_for('reports.relatorios_faturamento') }}",
                description: 'Relatórios de faturamento'
            },
            'financeiro': {
                name: 'Financeiro',
                icon: 'fas fa-chart-line',
                url: "{{ url_for('reports.relatorios_financeiro') }}",
                description: 'Relatórios financeiros'
            },
            'gerencial': {
                name: 'Gerencial',
                icon: 'fas fa-users-cog',
                url: "{{ url_for('reports.relatorios_gerencial') }}",
                description: 'Relatórios gerenciais'
            },
            'operacional': {
                name: 'Operacional',
                icon: 'fas fa-truck',
                url: "{{ url_for('reports.relatorios_operacional') }}",
                description: 'Relatórios operacionais'
            }
        }
    },
    
    // Módulos Marítimos
    'sse_stc': {
        name: 'SSE/STC',
        icon: 'fas fa-ship',
        url: '#',
        description: 'Sistema de Segurança e Emergência / Sistema de Tráfego de Cargas',
        type: 'maritimo_module',
        submodules: {
            'sse_controle': {
                name: 'Controle SSE',
                icon: 'fas fa-shield-alt',
                url: '#',
                description: 'Controle de segurança e emergência'
            },
            'stc_operacoes': {
                name: 'Operações STC',
                icon: 'fas fa-anchor',
                url: '#',
                description: 'Operações do sistema de tráfego'
            },
            'emergencia': {
                name: 'Emergência',
                icon: 'fas fa-exclamation-triangle',
                url: '#',
                description: 'Protocolos de emergência marítima'
            }
        }
    },
    
    'armazem_maritimo': {
        name: 'Armazém Marítimo',
        icon: 'fas fa-warehouse',
        url: '#',
        description: 'Gestão de armazéns portuários',
        type: 'maritimo_module',
        submodules: {
            'estoque': {
                name: 'Controle de Estoque',
                icon: 'fas fa-boxes',
                url: '#',
                description: 'Controle de estoque portuário'
            },
            'movimentacao': {
                name: 'Movimentação',
                icon: 'fas fa-dolly',
                url: '#',
                description: 'Movimentação de cargas'
            },
            'localizacao': {
                name: 'Localização',
                icon: 'fas fa-map-marker-alt',
                url: '#',
                description: 'Controle de localização de cargas'
            }
        }
    },
    
    'trafego_maritimo': {
        name: 'Tráfego Marítimo',
        icon: 'fas fa-water',
        url: '#',
        description: 'Controle de tráfego marítimo',
        type: 'maritimo_module',
        submodules: {
            'navios': {
                name: 'Navios',
                icon: 'fas fa-ship',
                url: '#',
                description: 'Controle de navios'
            },
            'portos': {
                name: 'Portos',
                icon: 'fas fa-anchor',
                url: '#',
                description: 'Gestão de portos'
            },
            'rotas': {
                name: 'Rotas',
                icon: 'fas fa-route',
                url: '#',
                description: 'Planejamento de rotas marítimas'
            }
        }
    }
};

let currentFavorites = ['cadastro', 'relatorios', 'web_cliente'];

// Carregar favoritos salvos
function loadFavorites() {
    const saved = localStorage.getItem('dashboard_favorites');
    if (saved) {
        const savedFavorites = JSON.parse(saved);
        // Validar se os favoritos salvos ainda existem na estrutura atual
        const validFavorites = savedFavorites.filter(favId => {
            // Verificar se é um módulo principal
            if (favoriteModules[favId]) {
                return true;
            }
            // Verificar se é um submódulo
            for (const moduleId in favoriteModules) {
                const module = favoriteModules[moduleId];
                if (module.submodules && module.submodules[favId]) {
                    return true;
                }
            }
            return false;
        });
        
        // Se houve mudanças na estrutura, limpar favoritos inválidos
        if (validFavorites.length !== savedFavorites.length) {
            console.log('Favoritos antigos detectados, limpando...');
            currentFavorites = ['cadastro', 'relatorios', 'web_cliente']; // Valores padrão
            localStorage.setItem('dashboard_favorites', JSON.stringify(currentFavorites));
        } else {
            currentFavorites = validFavorites;
        }
    }
    
    // Carregar layout salvo
    const savedLayout = localStorage.getItem('dashboard_layout');
    if (savedLayout) {
        console.log('Layout salvo encontrado:', savedLayout);
        applyLayout(savedLayout);
    } else {
        console.log('Nenhum layout salvo, aplicando layout padrão');
        // Aplicar layout padrão (atual) se não houver layout salvo
        applyLayout('atual');
    }
}

// Salvar favoritos
function saveFavorites() {
    localStorage.setItem('dashboard_favorites', JSON.stringify(currentFavorites));
    
    // Aplicar layout salvo
    const savedLayout = localStorage.getItem('dashboard_layout');
    if (savedLayout) {
        applyLayout(savedLayout);
    } else {
        renderFavorites();
    }
    
    // Fechar modal usando a instância global
    if (favoritesModalInstance) {
        favoritesModalInstance.hide();
    } else {
        // Fallback se não conseguir obter a instância
        const modalElement = document.getElementById('favoritesModal');
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
    
    FeedbackManager.showSuccess('Favoritos atualizados com sucesso!');
}

// Renderizar favoritos na tela principal
function renderFavorites() {
    const savedLayout = localStorage.getItem('dashboard_layout');
    console.log('renderFavorites chamado com layout:', savedLayout);
    
    // Sempre garantir que as abas estejam ocultas por padrão
    const tabsContainer = document.getElementById('favorites-tabs-container');
    if (tabsContainer) {
        tabsContainer.style.display = 'none';
    }
    
    if (savedLayout === 'abas') {
        // Mostrar abas e renderizar com filtro
        console.log('Aplicando layout com abas');
        if (tabsContainer) {
            tabsContainer.style.display = 'block';
        }
        renderFavoritesWithTabs();
    } else if (savedLayout === 'quadrados') {
        // Aplicar layout de quadrados separados
        console.log('Aplicando layout de quadrados separados');
        const container = document.getElementById('favorite-actions');
        if (container) {
            container.className = 'quick-actions-grid-main layout-quadrados';
        }
        renderQuadradosLayout();
    } else {
        // Ocultar abas e renderizar normalmente (layout atual/sem separação)
        console.log('Aplicando layout normal (sem separação)');
        const container = document.getElementById('favorite-actions');
        if (container) {
            container.className = 'quick-actions-grid-main';
        }
        renderFavoritesNormal();
    }
}

// Renderizar favoritos normalmente (sem abas)
function renderFavoritesNormal() {
    const container = document.getElementById('favorite-actions');
    container.innerHTML = '';
    
    let cardIndex = 0;
    
    currentFavorites.forEach((favId) => {
        let module = null;
        let isSubmodule = false;
        
        // Verificar se é um módulo principal
        if (favoriteModules[favId]) {
            module = favoriteModules[favId];
        } else {
            // Se não for módulo principal, procurar nos submódulos
            Object.keys(favoriteModules).forEach(moduleId => {
                const mainModule = favoriteModules[moduleId];
                if (mainModule.submodules && mainModule.submodules[favId]) {
                    module = mainModule.submodules[favId];
                    isSubmodule = true;
                }
            });
        }
        
        if (module && module.icon) {
            const card = document.createElement('div');
            card.className = `quick-action-card animate-on-scroll scale-in delay-${cardIndex + 2}`;
            card.setAttribute('data-module', favId);
            card.onclick = () => {
                window.location.href = module.url;
            };
            
            const iconSize = 'fa-2x';
            const iconClass = 'submodule-icon';
            
            card.innerHTML = `
                <div class="action-icon ${iconClass}">
                    <i class="${module.icon} ${iconSize}"></i>
                </div>
                <h3>${module.name}</h3>
                <p>${module.description}</p>
                <div class="action-badge">
                    <i class="fas fa-star"></i>
                </div>
            `;
            
            container.appendChild(card);
            cardIndex++;
        }
    });
}

// Renderizar favoritos com abas
function renderFavoritesWithTabs() {
    const currentTab = localStorage.getItem('favorites_current_tab') || 'aereo';
    console.log('renderFavoritesWithTabs chamado, aba atual:', currentTab);
    switchFavoritesTab(currentTab);
}

// Alternar entre abas de favoritos
function switchFavoritesTab(tabType) {
    console.log('switchFavoritesTab chamado com tipo:', tabType);
    
    // Atualizar estado das abas
    const tabAereo = document.getElementById('favorites-tab-aereo');
    const tabMaritimo = document.getElementById('favorites-tab-maritimo');
    const tabAtual = document.getElementById('favorites-tab-' + tabType);
    
    if (tabAereo) tabAereo.classList.remove('active');
    if (tabMaritimo) tabMaritimo.classList.remove('active');
    if (tabAtual) tabAtual.classList.add('active');
    
    // Salvar aba atual
    localStorage.setItem('favorites_current_tab', tabType);
    
    // Renderizar favoritos filtrados
    renderFavoritesByType(tabType);
}

// Renderizar favoritos por tipo (aéreo/marítimo)
function renderFavoritesByType(type) {
    console.log('renderFavoritesByType chamado com tipo:', type);
    const container = document.getElementById('favorite-actions');
    if (!container) {
        console.error('Container favorite-actions não encontrado!');
        return;
    }
    container.innerHTML = '';
    
    let cardIndex = 0;
    
    currentFavorites.forEach((favId) => {
        let module = null;
        let moduleType = null;
        
        // Verificar se é um módulo principal
        if (favoriteModules[favId]) {
            module = favoriteModules[favId];
            moduleType = favoriteModules[favId].type;
        } else {
            // Se não for módulo principal, procurar nos submódulos
            Object.keys(favoriteModules).forEach(moduleId => {
                const mainModule = favoriteModules[moduleId];
                if (mainModule.submodules && mainModule.submodules[favId]) {
                    module = mainModule.submodules[favId];
                    moduleType = mainModule.type;
                }
            });
        }
        
        // Filtrar por tipo
        let shouldShow = false;
        if (type === 'aereo') {
            shouldShow = moduleType === 'main_module' || !moduleType;
        } else if (type === 'maritimo') {
            shouldShow = moduleType === 'maritimo_module';
        }
        
        console.log(`Módulo ${favId}: type=${moduleType}, shouldShow=${shouldShow}, module=${!!module}`);
        
        if (module && module.icon && shouldShow) {
            const card = document.createElement('div');
            card.className = `quick-action-card animate-on-scroll scale-in delay-${cardIndex + 2}`;
            card.setAttribute('data-module', favId);
            card.onclick = () => {
                window.location.href = module.url;
            };
            
            const iconSize = 'fa-2x';
            const iconClass = 'submodule-icon';
            
            card.innerHTML = `
                <div class="action-icon ${iconClass}">
                    <i class="${module.icon} ${iconSize}"></i>
                </div>
                <h3>${module.name}</h3>
                <p>${module.description}</p>
                <div class="action-badge">
                    <i class="fas fa-star"></i>
                </div>
            `;
            
            container.appendChild(card);
            cardIndex++;
        }
    });
}

// Variável global para armazenar a instância do modal
let favoritesModalInstance = null;

// Função de emergência para limpar completamente o modal
function forceCloseModal() {
    console.log('Forçando fechamento do modal...');
    
    try {
        // Destruir instância se existir
        if (favoritesModalInstance) {
            try {
                favoritesModalInstance.dispose();
            } catch (e) {
                console.log('Erro ao destruir instância:', e);
            }
            favoritesModalInstance = null;
        }
        
        // Limpar modal element
        const modalElement = document.getElementById('favoritesModal');
        if (modalElement) {
            modalElement.removeAttribute('aria-hidden');
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            modalElement.setAttribute('aria-hidden', 'true');
        }
        
        // Remover todos os backdrops de forma segura
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            if (backdrop && backdrop.parentNode) {
                backdrop.parentNode.removeChild(backdrop);
            }
        });
        
        // Limpar body completamente
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Remover qualquer foco de elementos do modal
        const activeElement = document.activeElement;
        if (activeElement && activeElement.closest('#favoritesModal')) {
            activeElement.blur();
        }
        
        // Forçar reflow para garantir que as mudanças sejam aplicadas
        document.body.offsetHeight;
        
        console.log('Modal forçadamente fechado!');
        
        // Mostrar notificação de sucesso
        showNotification('Modal limpo com sucesso!', 'success');
        
    } catch (e) {
        console.error('Erro ao forçar fechamento do modal:', e);
        showNotification('Erro ao limpar modal. Recarregue a página.', 'error');
    }
}

// Abrir modal de personalização
function openFavoritesModal() {
    console.log('Tentando abrir modal de favoritos...');
    console.log('Bootstrap disponível:', typeof bootstrap !== 'undefined');
    
    const modalElement = document.getElementById('favoritesModal');
    console.log('Elemento do modal encontrado:', modalElement);
    
    if (!modalElement) {
        console.error('Modal element não encontrado!');
        return;
    }
    
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap não está carregado!');
        return;
    }
    
    try {
        // Se já existe uma instância, destruir primeiro
        if (favoritesModalInstance) {
            favoritesModalInstance.dispose();
            favoritesModalInstance = null;
        }
        
        // Limpar qualquer estado anterior do modal de forma mais segura
        try {
            modalElement.removeAttribute('aria-hidden');
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            
            // Remover backdrop se existir
            const existingBackdrops = document.querySelectorAll('.modal-backdrop');
            existingBackdrops.forEach(backdrop => {
                if (backdrop && backdrop.parentNode) {
                    backdrop.parentNode.removeChild(backdrop);
                }
            });
            
            // Remover classe modal-open do body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        } catch (e) {
            console.log('Erro ao limpar estado anterior:', e);
        }
        
        // Aguardar um pouco para garantir que a limpeza foi processada
        setTimeout(() => {
            try {
                favoritesModalInstance = new bootstrap.Modal(modalElement, {
                    backdrop: true,
                    keyboard: true,
                    focus: false  // Desabilitar foco automático para evitar conflitos
                });
                
                console.log('Instância do modal criada:', favoritesModalInstance);
                
                // Adicionar eventos de limpeza
                modalElement.addEventListener('hidden.bs.modal', function() {
                    console.log('Modal fechado, limpando...');
                    favoritesModalInstance = null;
                    modalElement.removeAttribute('aria-hidden');
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    
                    // Limpar backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Limpar body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                });
                
                renderFavoritesModal();
                console.log('Renderizando modal...');
                
                favoritesModalInstance.show();
                console.log('Modal mostrado!');
                
            } catch (e) {
                console.error('Erro ao criar instância do modal:', e);
                return;
            }
        }, 100);
    } catch (error) {
        console.error('Erro ao abrir modal:', error);
    }
}

// Renderizar modal de favoritos
function renderFavoritesModal() {
    console.log('Iniciando renderização do modal...');
    console.log('Favoritos atuais antes da renderização:', currentFavorites);
    
    try {
        // Recarregar favoritos do localStorage para garantir consistência
        loadFavorites();
        console.log('Favoritos recarregados:', currentFavorites);
        
        renderFavoritesLayout();
        console.log('Layout de favoritos renderizado');
        renderPersonalizeAereoLayout();
        console.log('Layout de personalização aéreo renderizado');
        renderPersonalizeMaritimoLayout();
        console.log('Layout de personalização marítimo renderizado');
        
        // Marcar layout selecionado
        const savedLayout = localStorage.getItem('dashboard_layout');
        if (savedLayout) {
            document.querySelectorAll('.layout-option').forEach(option => {
                option.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`[data-layout="${savedLayout}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
        }
    } catch (error) {
        console.error('Erro ao renderizar modal:', error);
    }
}

// Renderizar layout de favoritos (aba Favoritos)
function renderFavoritesLayout() {
    console.log('Renderizando layout de favoritos...');
    console.log('favoriteModules:', favoriteModules);
    console.log('currentFavorites:', currentFavorites);
    
    const favoritesContainer = document.getElementById('favorites-drag-container');
    if (!favoritesContainer) {
        console.error('Elemento favorites-drag-container não encontrado!');
        return;
    }
    
    // Obter layout atual
    const savedLayout = localStorage.getItem('dashboard_layout') || 'atual';
    console.log('Layout atual para preview:', savedLayout);
    
    // Limpar container
    favoritesContainer.innerHTML = '';
    
    // Aplicar classe baseada no layout
    if (savedLayout === 'quadrados') {
        favoritesContainer.className = 'favorites-drag-container layout-quadrados-preview';
        renderFavoritesLayoutQuadrados(favoritesContainer);
    } else if (savedLayout === 'abas') {
        favoritesContainer.className = 'favorites-drag-container layout-abas-preview';
        renderFavoritesLayoutAbas(favoritesContainer);
    } else {
        favoritesContainer.className = 'favorites-drag-container layout-normal-preview';
        renderFavoritesLayoutNormal(favoritesContainer);
    }
}

// Renderizar layout normal (sem separação) na aba de favoritos
function renderFavoritesLayoutNormal(container) {
    console.log('Renderizando preview layout normal...');
    
    // Criar cards arrastáveis para cada favorito
    currentFavorites.forEach((favId, index) => {
        let module = null;
        let isSubmodule = false;
        let parentModule = null;
        
        // Verificar se é um módulo principal
        if (favoriteModules[favId]) {
            module = favoriteModules[favId];
        } else {
            // Se não for módulo principal, procurar nos submódulos
            Object.keys(favoriteModules).forEach(moduleId => {
                const mainModule = favoriteModules[moduleId];
                if (mainModule.submodules && mainModule.submodules[favId]) {
                    module = mainModule.submodules[favId];
                    isSubmodule = true;
                    parentModule = moduleId;
                }
            });
        }
        
        if (module && module.icon) {
            const card = document.createElement('div');
            card.className = 'favorite-item';
            card.setAttribute('data-favorite-id', favId);
            card.setAttribute('data-index', index);
            
            card.innerHTML = `
                <div class="favorite-card-content">
                    <div class="favorite-card-icon">
                        <i class="${module.icon} fa-lg"></i>
                    </div>
                    <div class="favorite-card-info">
                        <h6>${module.name}</h6>
                    </div>
                    <div class="favorite-card-actions">
                        <button class="btn btn-outline-danger btn-sm" onclick="removeFavorite('${favId}')" title="Remover">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="favorite-card-badge">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
        }
    });
    
    // Inicializar SortableJS
    initializeSortable(container);
    
    // Se não há favoritos, mostrar mensagem
    if (currentFavorites.length === 0) {
        container.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center text-center py-5" style="min-height: 200px; grid-column: 1 / -1;">
                <i class="fas fa-star fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhum favorito selecionado</h5>
                <p class="text-muted">Vá para as abas "Pers Aéreo" ou "Pers Marítimo" para adicionar módulos e submódulos aos seus favoritos.</p>
            </div>
        `;
    }
}

// Renderizar layout de quadrados separados na aba de favoritos
function renderFavoritesLayoutQuadrados(container) {
    console.log('Renderizando preview layout quadrados...');
    console.log('Favoritos atuais:', currentFavorites);
    
    // Separar favoritos por tipo
    const aereoFavorites = [];
    const maritimoFavorites = [];
    
    currentFavorites.forEach((favId) => {
        let module = null;
        let moduleType = null;
        
        // Verificar se é um módulo principal
        if (favoriteModules[favId]) {
            module = favoriteModules[favId];
            moduleType = favoriteModules[favId].type;
        } else {
            // Se não for módulo principal, procurar nos submódulos
            Object.keys(favoriteModules).forEach(moduleId => {
                const mainModule = favoriteModules[moduleId];
                if (mainModule.submodules && mainModule.submodules[favId]) {
                    module = mainModule.submodules[favId];
                    moduleType = mainModule.type;
                }
            });
        }
        
        if (module && module.icon) {
            if (moduleType === 'maritimo_module') {
                maritimoFavorites.push({ id: favId, module });
            } else {
                aereoFavorites.push({ id: favId, module });
            }
        }
    });
    
    console.log('Favoritos aéreos encontrados:', aereoFavorites.length);
    console.log('Favoritos marítimos encontrados:', maritimoFavorites.length);
    
    // Criar seção Aéreo
    const aereoSection = document.createElement('div');
    aereoSection.className = 'preview-section aereo-section';
    aereoSection.innerHTML = `
        <div class="preview-label">Aéreo</div>
        <div class="preview-grid" id="preview-aereo-grid"></div>
    `;
    container.appendChild(aereoSection);
    
    // Criar seção Marítimo
    const maritimoSection = document.createElement('div');
    maritimoSection.className = 'preview-section maritimo-section';
    maritimoSection.innerHTML = `
        <div class="preview-label">Marítimo</div>
        <div class="preview-grid" id="preview-maritimo-grid"></div>
    `;
    container.appendChild(maritimoSection);
    
    // Renderizar favoritos aéreos
    const aereoGrid = document.getElementById('preview-aereo-grid');
    if (aereoGrid) {
        aereoFavorites.forEach(({ id, module }) => {
            const card = createPreviewCard(id, module, 'aereo');
            aereoGrid.appendChild(card);
            console.log(`Card aéreo renderizado: ${module.name}`);
        });
    }
    
    // Renderizar favoritos marítimos
    const maritimoGrid = document.getElementById('preview-maritimo-grid');
    if (maritimoGrid) {
        maritimoFavorites.forEach(({ id, module }) => {
            const card = createPreviewCard(id, module, 'maritimo');
            maritimoGrid.appendChild(card);
            console.log(`Card marítimo renderizado: ${module.name}`);
        });
    }
    
    // Inicializar SortableJS para ambos os grids com restrições de categoria
    if (aereoGrid) {
        initializeSortableWithCategory(aereoGrid, 'aereo');
    }
    if (maritimoGrid) {
        initializeSortableWithCategory(maritimoGrid, 'maritimo');
    }
}

// Renderizar layout com abas na aba de favoritos
function renderFavoritesLayoutAbas(container) {
    console.log('Renderizando preview layout com abas...');
    
    // Criar abas de preview
    const tabsContainer = document.createElement('div');
    tabsContainer.className = 'preview-tabs';
    tabsContainer.innerHTML = `
        <button class="preview-tab active" onclick="switchPreviewTab('aereo')" id="preview-tab-aereo">
            <i class="fas fa-plane"></i> Aéreo
        </button>
        <button class="preview-tab" onclick="switchPreviewTab('maritimo')" id="preview-tab-maritimo">
            <i class="fas fa-ship"></i> Marítimo
        </button>
    `;
    container.appendChild(tabsContainer);
    
    // Criar grid de preview
    const gridContainer = document.createElement('div');
    gridContainer.className = 'preview-favorites-grid';
    gridContainer.id = 'preview-favorites-grid';
    container.appendChild(gridContainer);
    
    // Renderizar favoritos baseado na aba ativa
    switchPreviewTab('aereo');
}

// Função auxiliar para criar cards de preview
function createPreviewCard(favId, module, type) {
    const card = document.createElement('div');
    card.className = 'preview-card';
    card.setAttribute('data-favorite-id', favId);
    card.setAttribute('data-category', type);
    
    card.innerHTML = `
        <i class="${module.icon}"></i>
        <span>${module.name}</span>
        <button class="btn btn-outline-danger btn-sm preview-remove-btn" onclick="removeFavorite('${favId}')" title="Remover">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    return card;
}

// Função auxiliar para inicializar SortableJS
function initializeSortable(container) {
    if (typeof Sortable !== 'undefined') {
        console.log('Inicializando SortableJS...');
        const sortable = new Sortable(container, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function() {
                console.log('Drag iniciado');
                container.classList.add('dragging');
            },
            onEnd: function() {
                console.log('Drag finalizado');
                container.classList.remove('dragging');
                updateFavoritesOrder();
            }
        });
        console.log('SortableJS inicializado:', sortable);
    } else {
        console.warn('SortableJS não está disponível!');
    }
}

// Função auxiliar para inicializar SortableJS com restrições de categoria
function initializeSortableWithCategory(container, category) {
    if (typeof Sortable !== 'undefined') {
        console.log(`Inicializando SortableJS para categoria: ${category}`);
        
        // Destruir instância anterior se existir
        if (container.sortableInstance) {
            container.sortableInstance.destroy();
        }
        
        const sortable = new Sortable(container, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            group: category, // Restringir drag and drop apenas dentro da mesma categoria
            onStart: function(evt) {
                console.log(`Drag iniciado na categoria: ${category}`);
                container.classList.add('dragging');
                
                // Adicionar indicador visual de categoria
                evt.item.classList.add(`dragging-${category}`);
            },
            onEnd: function(evt) {
                console.log(`Drag finalizado na categoria: ${category}`);
                container.classList.remove('dragging');
                evt.item.classList.remove(`dragging-${category}`);
                
                // Atualizar ordem apenas para a categoria específica
                updateFavoritesOrderByCategory(category);
            },
            onMove: function(evt) {
                // Verificar se o item está sendo movido para a categoria correta
                const targetCategory = evt.to ? (evt.to.getAttribute('data-category') || category) : category;
                const itemCategory = evt.item ? (evt.item.getAttribute('data-category') || category) : category;
                
                // Permitir movimento apenas dentro da mesma categoria
                return targetCategory === itemCategory;
            }
        });
        
        // Armazenar referência da instância
        container.sortableInstance = sortable;
        container.setAttribute('data-category', category);
        
        console.log(`SortableJS inicializado para categoria ${category}:`, sortable);
    } else {
        console.warn('SortableJS não está disponível!');
    }
}

// Função para alternar abas no preview
function switchPreviewTab(tabType) {
    console.log(`Alternando para aba: ${tabType}`);
    
    // Atualizar estado das abas
    const tabAereo = document.getElementById('preview-tab-aereo');
    const tabMaritimo = document.getElementById('preview-tab-maritimo');
    const tabAtual = document.getElementById('preview-tab-' + tabType);
    
    if (tabAereo) tabAereo.classList.remove('active');
    if (tabMaritimo) tabMaritimo.classList.remove('active');
    if (tabAtual) tabAtual.classList.add('active');
    
    // Renderizar favoritos filtrados
    const gridContainer = document.getElementById('preview-favorites-grid');
    if (!gridContainer) {
        console.error('Grid container não encontrado!');
        return;
    }
    
    gridContainer.innerHTML = '';
    console.log('Renderizando favoritos para aba:', tabType);
    console.log('Favoritos atuais:', currentFavorites);
    
    let renderedCount = 0;
    
    currentFavorites.forEach((favId) => {
        let module = null;
        let moduleType = null;
        
        // Verificar se é um módulo principal
        if (favoriteModules[favId]) {
            module = favoriteModules[favId];
            moduleType = favoriteModules[favId].type;
        } else {
            // Se não for módulo principal, procurar nos submódulos
            Object.keys(favoriteModules).forEach(moduleId => {
                const mainModule = favoriteModules[moduleId];
                if (mainModule.submodules && mainModule.submodules[favId]) {
                    module = mainModule.submodules[favId];
                    moduleType = mainModule.type;
                }
            });
        }
        
        // Filtrar por tipo
        let shouldShow = false;
        if (tabType === 'aereo') {
            shouldShow = moduleType === 'main_module' || !moduleType;
        } else if (tabType === 'maritimo') {
            shouldShow = moduleType === 'maritimo_module';
        }
        
        if (module && module.icon && shouldShow) {
            const card = createPreviewCard(favId, module, tabType);
            gridContainer.appendChild(card);
            renderedCount++;
            console.log(`Renderizado: ${module.name} (${favId})`);
        }
    });
    
    console.log(`Total de cards renderizados: ${renderedCount}`);
    
    // Inicializar SortableJS para o grid atual com restrição de categoria
    initializeSortableWithCategory(gridContainer, tabType);
}

// Renderizar layout de personalização aéreo (aba Pers Aéreo)
function renderPersonalizeAereoLayout() {
    console.log('Renderizando layout de personalização aéreo...');
    console.log('currentFavorites na renderização:', currentFavorites);
    
    const personalizeLayout = document.getElementById('personalize-aereo-layout');
    if (!personalizeLayout) {
        console.error('Elemento personalize-aereo-layout não encontrado!');
        return;
    }
    
    personalizeLayout.innerHTML = '';
    
    // Filtrar apenas módulos aéreos (não marítimos)
    Object.keys(favoriteModules).forEach(moduleId => {
        const module = favoriteModules[moduleId];
        
        // Pular módulos marítimos
        if (module.type === 'maritimo_module') {
            return;
        }
        
        const isMainModuleSelected = currentFavorites.includes(moduleId);
        console.log(`Módulo ${moduleId} (${module.name}) está selecionado:`, isMainModuleSelected);
        
        const moduleContainer = document.createElement('div');
        moduleContainer.className = 'available-module-group';
        
        let moduleHtml = `
            <div class="available-main-module ${isMainModuleSelected ? 'selected' : ''}">
                <div class="main-module-content">
                    <div class="main-module-icon">
                        <i class="${module.icon}"></i>
                    </div>
                    <div class="main-module-info">
                        <h5>${module.name}</h5>
                        <p>Módulo Principal</p>
                    </div>
                    <button class="add-main-btn" onclick="addFavorite('${moduleId}')" data-state="${isMainModuleSelected ? 'remove' : 'add'}">
                        <i class="fas fa-${isMainModuleSelected ? 'minus' : 'plus'}"></i> ${isMainModuleSelected ? 'Remover' : 'Adicionar'}
                    </button>
                </div>
            </div>
        `;
        
        // Adicionar submódulos
        if (module.submodules) {
            moduleHtml += '<div class="available-submodules">';
            Object.keys(module.submodules).forEach(subId => {
                const sub = module.submodules[subId];
                const isSubmoduleSelected = currentFavorites.includes(subId);
                console.log(`Submódulo ${subId} (${sub.name}) está selecionado:`, isSubmoduleSelected);
                
                moduleHtml += `
                    <div class="available-submodule ${isSubmoduleSelected ? 'selected' : ''}" onclick="addFavorite('${subId}')" style="cursor: pointer;">
                        <div class="submodule-content">
                            <div class="submodule-icon">
                                <i class="${sub.icon}"></i>
                            </div>
                            <div class="submodule-info">
                                <h6>${sub.name}</h6>
                                <small class="text-muted">de ${module.name}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            moduleHtml += '</div>';
        }
        
        moduleContainer.innerHTML = moduleHtml;
        personalizeLayout.appendChild(moduleContainer);
    });
}

// Renderizar layout de personalização marítimo (aba Pers Marítimo)
function renderPersonalizeMaritimoLayout() {
    console.log('Renderizando layout de personalização marítimo...');
    
    const personalizeLayout = document.getElementById('personalize-maritimo-layout');
    if (!personalizeLayout) {
        console.error('Elemento personalize-maritimo-layout não encontrado!');
        return;
    }
    
    personalizeLayout.innerHTML = '';
    
    // Filtrar apenas módulos marítimos
    Object.keys(favoriteModules).forEach(moduleId => {
        const module = favoriteModules[moduleId];
        
        // Pular módulos não marítimos
        if (module.type !== 'maritimo_module') {
            return;
        }
        
        const isMainModuleSelected = currentFavorites.includes(moduleId);
        
        const moduleContainer = document.createElement('div');
        moduleContainer.className = 'available-module-group';
        
        let moduleHtml = `
            <div class="available-main-module ${isMainModuleSelected ? 'selected' : ''}">
                <div class="main-module-content">
                    <div class="main-module-icon">
                        <i class="${module.icon}"></i>
                    </div>
                    <div class="main-module-info">
                        <h5>${module.name}</h5>
                        <p>Módulo Marítimo</p>
                    </div>
                    <button class="add-main-btn" onclick="addFavorite('${moduleId}')" data-state="${isMainModuleSelected ? 'remove' : 'add'}">
                        <i class="fas fa-${isMainModuleSelected ? 'minus' : 'plus'}"></i> ${isMainModuleSelected ? 'Remover' : 'Adicionar'}
                    </button>
                </div>
            </div>
        `;
        
        // Adicionar submódulos
        if (module.submodules) {
            moduleHtml += '<div class="available-submodules">';
            Object.keys(module.submodules).forEach(subId => {
                const sub = module.submodules[subId];
                const isSubmoduleSelected = currentFavorites.includes(subId);
                console.log(`Submódulo ${subId} (${sub.name}) está selecionado:`, isSubmoduleSelected);
                
                moduleHtml += `
                    <div class="available-submodule ${isSubmoduleSelected ? 'selected' : ''}" onclick="addFavorite('${subId}')" style="cursor: pointer;">
                        <div class="submodule-content">
                            <div class="submodule-icon">
                                <i class="${sub.icon}"></i>
                            </div>
                            <div class="submodule-info">
                                <h6>${sub.name}</h6>
                                <small class="text-muted">de ${module.name}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            moduleHtml += '</div>';
        }
        
        moduleContainer.innerHTML = moduleHtml;
        personalizeLayout.appendChild(moduleContainer);
    });
}

// Função para selecionar layout
function selectLayout(layoutType) {
    // Atualizar visual dos botões
    document.querySelectorAll('.layout-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelector(`[data-layout="${layoutType}"]`).classList.add('selected');
    
    // Salvar layout selecionado no localStorage
    localStorage.setItem('dashboard_layout', layoutType);
    
    // Aplicar layout selecionado
    applyLayout(layoutType);
    
    // Layout aplicado silenciosamente
}

// Função para aplicar o layout selecionado
function applyLayout(layoutType) {
    console.log('applyLayout chamado com tipo:', layoutType);
    const container = document.getElementById('favorite-actions');
    if (!container) {
        console.error('Container favorite-actions não encontrado!');
        return;
    }
    
    if (layoutType === 'quadrados') {
        console.log('Aplicando layout de quadrados separados');
        // Aplicar layout de quadrados separados
        container.className = 'quick-actions-grid-main layout-quadrados';
        // Ocultar abas para layout de quadrados
        const tabsContainer = document.getElementById('favorites-tabs-container');
        if (tabsContainer) {
            tabsContainer.style.display = 'none';
        }
        renderQuadradosLayout();
    } else {
        console.log('Aplicando layout padrão ou com abas:', layoutType);
        // Aplicar layout padrão ou com abas
        container.className = 'quick-actions-grid-main';
        renderFavorites();
    }
}

// Função para renderizar layout de quadrados separados
function renderQuadradosLayout() {
    console.log('renderQuadradosLayout chamado');
    const container = document.getElementById('favorite-actions');
    if (!container) {
        console.error('Container favorite-actions não encontrado em renderQuadradosLayout!');
        return;
    }
    container.innerHTML = '';
    
    // Separar favoritos por tipo (aéreo/marítimo)
    const aereoFavorites = [];
    const maritimoFavorites = [];
    
    currentFavorites.forEach((favId) => {
        let module = null;
        let isSubmodule = false;
        
        // Verificar se é um módulo principal
        if (favoriteModules[favId]) {
            module = favoriteModules[favId];
        } else {
            // Se não for módulo principal, procurar nos submódulos
            Object.keys(favoriteModules).forEach(moduleId => {
                const mainModule = favoriteModules[moduleId];
                if (mainModule.submodules && mainModule.submodules[favId]) {
                    module = mainModule.submodules[favId];
                    isSubmodule = true;
                }
            });
        }
        
        if (module && module.icon) {
            if (isSubmodule) {
                // Determinar se é aéreo ou marítimo baseado no módulo pai
                const parentModule = Object.keys(favoriteModules).find(moduleId => 
                    favoriteModules[moduleId].submodules && 
                    favoriteModules[moduleId].submodules[favId]
                );
                
                if (parentModule && favoriteModules[parentModule].type === 'maritimo_module') {
                    maritimoFavorites.push({ id: favId, module, isSubmodule });
                } else {
                    aereoFavorites.push({ id: favId, module, isSubmodule });
                }
            } else {
                // Módulo principal
                if (module.type === 'maritimo_module') {
                    maritimoFavorites.push({ id: favId, module, isSubmodule });
                } else {
                    aereoFavorites.push({ id: favId, module, isSubmodule });
                }
            }
        }
    });
    
    // Criar estrutura de quadrados separados
    const layoutHTML = `
        <div class="quadrados-layout">
            <!-- Seção Aéreo -->
            <div class="quadrado-section aereo-section">
                <div class="section-header">
                    <h3><i class="fas fa-plane"></i> Aéreo</h3>
                </div>
                <div class="section-grid" id="aereo-grid">
                    ${aereoFavorites.map((fav, index) => createQuadradoCard(fav, index)).join('')}
                </div>
            </div>
            
            <!-- Seção Marítimo -->
            <div class="quadrado-section maritimo-section">
                <div class="section-header">
                    <h3><i class="fas fa-ship"></i> Marítimo</h3>
                </div>
                <div class="section-grid" id="maritimo-grid">
                    ${maritimoFavorites.map((fav, index) => createQuadradoCard(fav, index)).join('')}
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = layoutHTML;
}

// Função para criar card do quadrado
function createQuadradoCard(fav, index) {
    const { id, module } = fav;
    
    return `
        <div class="quadrado-card animate-on-scroll scale-in delay-${index + 2}" 
             data-module="${id}" 
             onclick="window.location.href='${module.url}'">
            <div class="card-icon">
                <i class="${module.icon} fa-2x"></i>
            </div>
            <div class="card-content">
                <h4>${module.name}</h4>
                <p>${module.description}</p>
            </div>
            <div class="card-badge">
                <i class="fas fa-star"></i>
            </div>
        </div>
    `;
}

// Função para mostrar notificações
function showNotification(message, type = 'info') {
    // Criar elemento de notificação
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Adicionar ao body
    document.body.appendChild(notification);
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Funções de gerenciamento de drag & drop

function updateFavoritesOrder() {
    const items = document.querySelectorAll('.favorite-item');
    const newOrder = Array.from(items).map(item => item.getAttribute('data-favorite-id'));
    
    console.log('Nova ordem dos favoritos:', newOrder);
    
    // Atualizar currentFavorites e salvar automaticamente
    currentFavorites = newOrder;
    localStorage.setItem('dashboard_favorites', JSON.stringify(currentFavorites));
}

// Função para atualizar ordem dos favoritos por categoria
function updateFavoritesOrderByCategory(category) {
    console.log(`Atualizando ordem dos favoritos para categoria: ${category}`);
    
    let categoryItems = [];
    
    try {
        if (category === 'aereo') {
            // Obter itens da seção aéreo
            const aereoGrid = document.getElementById('preview-aereo-grid');
            if (aereoGrid) {
                const cards = aereoGrid.querySelectorAll('.preview-card');
                categoryItems = Array.from(cards).map(item => {
                    const favId = item.getAttribute('data-favorite-id');
                    return favId ? favId : null;
                }).filter(id => id !== null);
            }
        } else if (category === 'maritimo') {
            // Obter itens da seção marítimo
            const maritimoGrid = document.getElementById('preview-maritimo-grid');
            if (maritimoGrid) {
                const cards = maritimoGrid.querySelectorAll('.preview-card');
                categoryItems = Array.from(cards).map(item => {
                    const favId = item.getAttribute('data-favorite-id');
                    return favId ? favId : null;
                }).filter(id => id !== null);
            }
        } else {
            // Para layout com abas, obter itens do grid atual
            const gridContainer = document.getElementById('preview-favorites-grid');
            if (gridContainer) {
                const cards = gridContainer.querySelectorAll('.preview-card');
                categoryItems = Array.from(cards).map(item => {
                    const favId = item.getAttribute('data-favorite-id');
                    return favId ? favId : null;
                }).filter(id => id !== null);
            }
        }
    } catch (error) {
        console.error('Erro ao obter itens da categoria:', error);
        return;
    }
    
    console.log(`Nova ordem para categoria ${category}:`, categoryItems);
    
    // Para layouts com separação de categorias, não reordenar currentFavorites
    // Apenas atualizar a ordem visual dos cards
    console.log(`Ordem atual dos favoritos mantida para categoria: ${category}`);
    
    // Não alterar currentFavorites para layouts com categorias separadas
    // A ordem é mantida visualmente apenas
    
    console.log('Ordem final dos favoritos:', currentFavorites);
    
    // Atualizar índices dos elementos da categoria específica
    if (category === 'aereo') {
        const aereoGrid = document.getElementById('preview-aereo-grid');
        if (aereoGrid) {
            const aereoItems = aereoGrid.querySelectorAll('.preview-card');
            aereoItems.forEach((item, index) => {
                item.setAttribute('data-index', index);
            });
        }
    } else if (category === 'maritimo') {
        const maritimoGrid = document.getElementById('preview-maritimo-grid');
        if (maritimoGrid) {
            const maritimoItems = maritimoGrid.querySelectorAll('.preview-card');
            maritimoItems.forEach((item, index) => {
                item.setAttribute('data-index', index);
            });
        }
    } else {
        // Para layout com abas
        const gridContainer = document.getElementById('preview-favorites-grid');
        if (gridContainer) {
            const gridItems = gridContainer.querySelectorAll('.preview-card');
            gridItems.forEach((item, index) => {
                item.setAttribute('data-index', index);
            });
        }
    }
    
    // Aplicar layout salvo
    const savedLayout = localStorage.getItem('dashboard_layout');
    if (savedLayout) {
        applyLayout(savedLayout);
    } else {
        renderFavorites();
    }
    
    console.log('Ordem salva automaticamente:', currentFavorites);
}

// Cancelar e fechar modal
function cancelFavorites() {
    if (favoritesModalInstance) {
        favoritesModalInstance.hide();
    } else {
        // Fallback se não conseguir obter a instância
        const modalElement = document.getElementById('favoritesModal');
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}

// Adicionar/Remover favorito (toggle)
function addFavorite(moduleId) {
    console.log('addFavorite chamada para:', moduleId);
    console.log('currentFavorites antes:', currentFavorites);
    
    const index = currentFavorites.indexOf(moduleId);
    if (index === -1) {
        // Se não está nos favoritos, adicionar
        currentFavorites.push(moduleId);
        console.log('Adicionado aos favoritos');
    } else {
        // Se já está nos favoritos, remover
        currentFavorites.splice(index, 1);
        console.log('Removido dos favoritos');
    }
    
    console.log('currentFavorites depois:', currentFavorites);
    
    // Salvar favoritos atualizados
    localStorage.setItem('dashboard_favorites', JSON.stringify(currentFavorites));
    
    // Aplicar layout salvo na área principal
    const savedLayout = localStorage.getItem('dashboard_layout');
    if (savedLayout) {
        applyLayout(savedLayout);
    } else {
        renderFavorites();
    }
    
    renderFavoritesLayout();
    renderPersonalizeAereoLayout();
    renderPersonalizeMaritimoLayout();
}

// Remover favorito
function removeFavorite(moduleId) {
    const index = currentFavorites.indexOf(moduleId);
    if (index > -1) {
        currentFavorites.splice(index, 1);
        
        // Salvar favoritos atualizados
        localStorage.setItem('dashboard_favorites', JSON.stringify(currentFavorites));
        
        // Aplicar layout salvo na área principal
        const savedLayout = localStorage.getItem('dashboard_layout');
        if (savedLayout) {
            applyLayout(savedLayout);
        } else {
            renderFavorites();
        }
        
        renderFavoritesLayout();
        renderPersonalizeAereoLayout();
        renderPersonalizeMaritimoLayout();
    }
}

// Drag and Drop
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    if (draggedElement && draggedElement !== this) {
        const draggedModule = draggedElement.getAttribute('data-module');
        const targetModule = this.getAttribute('data-module');
        
        const draggedIndex = currentFavorites.indexOf(draggedModule);
        const targetIndex = currentFavorites.indexOf(targetModule);
        
        // Reordenar array
        currentFavorites.splice(draggedIndex, 1);
        currentFavorites.splice(targetIndex, 0, draggedModule);
        
        renderFavoritesModal();
    }
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedElement = null;
}

// Sistema de Avatar e Perfil do Usuário
let selectedAvatarFile = null;

// Função para atualizar cargo do usuário no banco de dados
async function updateUserJobTitle(jobTitle) {
    try {
        // Simular chamada para API (em produção, fazer requisição real)
        console.log('Atualizando cargo do usuário:', jobTitle);
        
        // Em produção, fazer uma requisição PUT para /api/users/current
        // const response = await fetch('/api/users/current', {
        //     method: 'PUT',
        //     headers: {
        //         'Content-Type': 'application/json',
        //     },
        //     body: JSON.stringify({ job_title: jobTitle })
        // });
        
        // Por enquanto, apenas simular sucesso
        return true;
    } catch (error) {
        console.error('Erro ao atualizar cargo:', error);
        return false;
    }
}

// Mostrar seção do colaborador apenas na home
function showUserProfileSection() {
    const userProfileSection = document.getElementById('user-profile-section');
    if (userProfileSection) {
        userProfileSection.style.display = 'block';
        
        // Carregar cargo salvo do localStorage
        const savedJobTitle = localStorage.getItem('user_job_title');
        if (savedJobTitle) {
            const jobTitleElement = document.getElementById('user-job-title');
            if (jobTitleElement) {
                jobTitleElement.textContent = savedJobTitle;
            }
        }
    }
}

// Esconder seção do colaborador em outras páginas
function hideUserProfileSection() {
    const userProfileSection = document.getElementById('user-profile-section');
    if (userProfileSection) {
        userProfileSection.style.display = 'none';
    }
}

// Abrir modal de upload de avatar
function openAvatarUpload() {
    const modal = new bootstrap.Modal(document.getElementById('avatarUploadModal'));
    
    // Carregar cargo atual do usuário
    const currentJobTitle = document.getElementById('user-job-title').textContent;
    const jobTitleInput = document.getElementById('job-title-input');
    if (jobTitleInput && currentJobTitle !== 'Cargo não informado') {
        jobTitleInput.value = currentJobTitle;
    }
    
    modal.show();
}

// Abrir configurações do perfil (removido - agora apenas clica na foto)

// Configurar upload de avatar
function setupAvatarUpload() {
    const fileInput = document.getElementById('avatar-file-input');
    const uploadArea = document.getElementById('avatar-upload-area');
    const preview = document.getElementById('avatar-preview');
    const uploadBtn = document.getElementById('upload-avatar-btn');
    
    // Click na área de upload
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    // Seleção de arquivo
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        // Validar tipo de arquivo
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione apenas arquivos de imagem.');
            return;
        }
        
        // Validar tamanho (2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('O arquivo deve ter no máximo 2MB.');
            return;
        }
        
        selectedAvatarFile = file;
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// Upload do avatar e atualização do cargo
function uploadAvatar() {
    const jobTitleInput = document.getElementById('job-title-input');
    const jobTitle = jobTitleInput ? jobTitleInput.value.trim() : '';
    
    // Atualizar cargo na sidebar
    const sidebarJobTitle = document.getElementById('user-job-title');
    if (sidebarJobTitle) {
        sidebarJobTitle.textContent = jobTitle || 'Cargo não informado';
    }
    
    // Salvar cargo no localStorage
    localStorage.setItem('user_job_title', jobTitle);
    
    // Simular atualização no banco de dados
    updateUserJobTitle(jobTitle);
    
    if (!selectedAvatarFile) {
        // Se não há arquivo, apenas atualizar o cargo
        const modal = bootstrap.Modal.getInstance(document.getElementById('avatarUploadModal'));
        if (modal) {
            modal.hide();
        }
        
        FeedbackManager.showSuccess('Informações do perfil atualizadas com sucesso!');
        return;
    }
    
    const formData = new FormData();
    formData.append('avatar', selectedAvatarFile);
    
    // Simular upload (em produção, enviar para o servidor)
    const uploadBtn = document.getElementById('upload-avatar-btn');
    const originalText = uploadBtn.innerHTML;
    
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    uploadBtn.disabled = true;
    
    // Simular delay de upload
    setTimeout(() => {
        // Atualizar avatar na sidebar
        const sidebarAvatar = document.getElementById('user-avatar');
        const preview = document.getElementById('avatar-preview');
        
        if (sidebarAvatar && preview) {
            sidebarAvatar.src = preview.src;
        }
        
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('avatarUploadModal'));
        if (modal) {
            modal.hide();
        }
        
        // Resetar botão
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        
        // Mostrar sucesso
        FeedbackManager.showSuccess('Foto de perfil e informações atualizadas com sucesso!');
        
        // Limpar seleção
        selectedAvatarFile = null;
        document.getElementById('avatar-file-input').value = '';
    }, 1500);
}

// Função de teste para debug (pode ser chamada no console)
function testLayoutAbas() {
    console.log('=== TESTE DE LAYOUT COM ABAS ===');
    console.log('1. Definindo layout como "abas"');
    localStorage.setItem('dashboard_layout', 'abas');
    
    console.log('2. Chamando renderFavorites');
    renderFavorites();
    
    console.log('3. Verificando se as abas estão visíveis');
    const tabsContainer = document.getElementById('favorites-tabs-container');
    console.log('Container de abas:', tabsContainer);
    console.log('Display style:', tabsContainer ? tabsContainer.style.display : 'não encontrado');
    
    console.log('4. Verificando elementos das abas');
    const tabAereo = document.getElementById('favorites-tab-aereo');
    const tabMaritimo = document.getElementById('favorites-tab-maritimo');
    console.log('Aba Aéreo:', tabAereo);
    console.log('Aba Marítimo:', tabMaritimo);
}

// Função de teste para verificar estado do localStorage
function testLayoutState() {
    console.log('=== TESTE DE ESTADO DO LAYOUT ===');
    console.log('Layout salvo no localStorage:', localStorage.getItem('dashboard_layout'));
    console.log('Favoritos salvos no localStorage:', localStorage.getItem('dashboard_favorites'));
    console.log('Aba atual salva:', localStorage.getItem('favorites_current_tab'));
    
    const tabsContainer = document.getElementById('favorites-tabs-container');
    console.log('Container de abas existe:', !!tabsContainer);
    console.log('Display das abas:', tabsContainer ? tabsContainer.style.display : 'não encontrado');
    
    const container = document.getElementById('favorite-actions');
    console.log('Container de favoritos existe:', !!container);
    console.log('Classe do container:', container ? container.className : 'não encontrado');
}

// Função para simular o problema de atualização
function testLayoutPersistence() {
    console.log('=== TESTE DE PERSISTÊNCIA DO LAYOUT ===');
    
    // 1. Definir layout como quadrados
    console.log('1. Definindo layout como "quadrados"');
    localStorage.setItem('dashboard_layout', 'quadrados');
    
    // 2. Simular carregamento (como se fosse F5)
    console.log('2. Simulando carregamento da página...');
    loadFavorites();
    
    // 3. Verificar se o layout foi aplicado corretamente
    console.log('3. Verificando resultado...');
    const container = document.getElementById('favorite-actions');
    const tabsContainer = document.getElementById('favorites-tabs-container');
    
    console.log('Classe do container:', container ? container.className : 'não encontrado');
    console.log('Display das abas:', tabsContainer ? tabsContainer.style.display : 'não encontrado');
    console.log('Layout salvo:', localStorage.getItem('dashboard_layout'));
    
    if (container && container.className.includes('layout-quadrados')) {
        console.log('✅ Layout de quadrados aplicado corretamente!');
    } else {
        console.log('❌ Layout de quadrados NÃO foi aplicado!');
    }
}

// Inicializar página
document.addEventListener('DOMContentLoaded', async function() {
    updateCurrentTime();
    await loadStats();
    await loadLinkedInPosts();
    loadNews();
    
    // Inicializar favoritos
    loadFavorites();
    
    // Forçar renderização após um pequeno delay para garantir que o DOM está pronto
    setTimeout(() => {
        console.log('Forçando renderização após delay');
        renderFavorites();
    }, 100);
    
    // Mostrar seção do colaborador (apenas na home)
    showUserProfileSection();
    
    // Configurar upload de avatar
    setupAvatarUpload();
    
    // Inicializar animações
    initScrollAnimations();
    // initParallax(); // Removido - causava problema de scroll
    
    // Animar contadores após carregar dados
    setTimeout(animateCounters, 500);
    
    // Atualizar a cada minuto
    setInterval(updateCurrentTime, 60000);
    
    // Inicializar notificações
    initNotifications();
    
    // Iniciar rotação automática das notícias
    startNewsRotation();
});

// ========================================
// SISTEMA DE NOTIFICAÇÕES
// ========================================

// Dados de notificações
let notificationsData = [
    {
        id: 1,
        type: 'document',
        title: 'Documentos',
        message: 'Por favor inserir CE MERCANTE - P2025.16.430',
        time: '2 min atrás',
        read: false,
        priority: 'high'
    },
    {
        id: 2,
        type: 'update',
        title: 'Atualização',
        message: 'Amanhã teremos atualização no sistema, confira as novidades.',
        time: '1 hora atrás',
        read: false,
        priority: 'medium'
    },
    {
        id: 3,
        type: 'process',
        title: 'Processo',
        message: 'O Processo P2025.43.392 foi aprovado.',
        time: '3 horas atrás',
        read: true,
        priority: 'low'
    },
    {
        id: 4,
        type: 'billing',
        title: 'Faturamento',
        message: 'A nota fiscal 7320 está pendente.',
        time: '5 horas atrás',
        read: true,
        priority: 'high'
    }
];

function initNotifications() {
    loadNotifications();
    updateBadge();
}

function loadNotifications() {
    const list = document.getElementById('notificationList');
    if (!list) return;
    
    list.innerHTML = '';
    
    if (notificationsData.length === 0) {
        list.innerHTML = `
            <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <p>Nenhuma notificação</p>
            </div>
        `;
        return;
    }
    
    notificationsData.forEach(notification => {
        const notificationElement = createNotificationElement(notification);
        list.appendChild(notificationElement);
    });
}

function createNotificationElement(notification) {
    const div = document.createElement('div');
    div.className = `notification-item ${notification.read ? 'read' : 'unread'} priority-${notification.priority}`;
    div.innerHTML = `
        <div class="notification-icon">
            <i class="fas fa-${getNotificationIcon(notification.type)}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${notification.time}</div>
        </div>
        <div class="notification-actions">
            <button class="btn-remove" onclick="removeNotification(${notification.id})" title="Remover">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Adicionar evento de clique para marcar como lida
    div.addEventListener('click', (e) => {
        if (!e.target.closest('.btn-remove')) {
            markAsRead(notification.id);
        }
    });
    
    return div;
}

function getNotificationIcon(type) {
    const icons = {
        'document': 'file-alt',
        'update': 'sync-alt',
        'process': 'check-circle',
        'billing': 'receipt',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[type] || 'bell';
}

function markAsRead(id) {
    const notification = notificationsData.find(n => n.id === id);
    if (notification && !notification.read) {
        notification.read = true;
        loadNotifications();
        updateBadge();
    }
}

function removeNotification(id) {
    notificationsData = notificationsData.filter(n => n.id !== id);
    loadNotifications();
    updateBadge();
}

function markAllAsRead() {
    notificationsData.forEach(n => n.read = true);
    loadNotifications();
    updateBadge();
}

function clearAllNotifications() {
    if (confirm('Tem certeza que deseja remover todas as notificações?')) {
        notificationsData = [];
        loadNotifications();
        updateBadge();
    }
}

function updateBadge() {
    const badge = document.getElementById('notificationBadge');
    const unreadCount = notificationsData.filter(n => !n.read).length;
    
    if (badge) {
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

function toggleNotifications() {
    const dropdown = document.getElementById('notificationDropdown');
    const bell = document.getElementById('notificationBell');
    
    if (dropdown && bell) {
        if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
        } else {
            // Calcular posição baseada na posição do sininho
            const bellRect = bell.getBoundingClientRect();
            dropdown.style.top = (bellRect.bottom + 10) + 'px';
            dropdown.style.right = (window.innerWidth - bellRect.right) + 'px';
            dropdown.style.left = 'auto';
            dropdown.classList.add('show');
        }
    }
}

// Fechar dropdown ao clicar fora
document.addEventListener('click', (e) => {
    const container = document.querySelector('.notification-bell-container');
    const dropdown = document.getElementById('notificationDropdown');
    
    if (container && dropdown && !container.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
    }
});
</script>

<!-- Dropdown de Notificações -->
<div class="notification-dropdown" id="notificationDropdown">
    <div class="notification-header">
        <h4>Notificações</h4>
        <button class="btn-clear-all" onclick="clearAllNotifications()">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    <div class="notification-list" id="notificationList">
        <!-- Notificações serão carregadas dinamicamente -->
    </div>
    <div class="notification-footer">
        <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()">
            Marcar todas como lidas
        </button>
    </div>
</div>

{% endblock %}

