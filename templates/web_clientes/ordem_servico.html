{% extends "base.html" %}

{% block title %}Ordem de Serviço - Web Cliente{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <!-- View de Listagem -->
    <div class="content-section active" id="listagemView">
        <div class="container-fluid">
            <!-- Header da página -->
            <div class="page-header">
                <div class="header-content">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clipboard-list fa-2x text-white me-3"></i>
                        <div class="header-text">
                            <h2>Listagem de Ordens de Serviço</h2>
                            <p class="page-subtitle">Gerencie e acompanhe todas as ordens de serviço dos clientes</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Barra de Pesquisa e Filtros -->
            <div class="search-section">
                <div class="search-input-group">
                    <form method="GET" class="search-form">
                        <div class="input-group">
                            <input type="text" 
                                   name="search" 
                                   id="searchInput"
                                   class="form-control search-input" 
                                   placeholder="Pesquisar por ficha, serviço, processo, entidade...">
                            <button type="submit" class="btn btn-primary search-btn" id="searchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary clear-btn" id="clearFilters">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </form>
                    <button class="btn btn-outline-info filter-toggle" onclick="toggleAdvancedFilters()">
                        <i class="fas fa-filter"></i> Filtros Avançados
                    </button>
                    <button class="btn btn-success" id="cadastrarServico">
                        <i class="fas fa-plus"></i> Cadastrar Serviço
                    </button>
                </div>
                
                <!-- Checkbox para Sem Carga Atrelada -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="semCargaAtrelada" onchange="ordemServicoManager.filterSemCarga()">
                            <label class="form-check-label fw-bold text-dark" for="semCargaAtrelada">
                                Mostrar apenas serviços sem carga atrelada
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Filtros Avançados -->
                <div class="advanced-filters" id="advancedFilters" style="display: none;">
                    <div class="filters-header">
                        <h5>Filtros</h5>
                    </div>
                    <form method="GET" class="filters-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Status</label>
                                        <select name="status" id="statusFilter" class="form-select">
                                            <option value="">Selecione...</option>
                                            <option value="SOLICITACAO">Solicitação</option>
                                            <option value="EXECUTADO">Executado</option>
                                            <option value="AGENDAMENTO">Agendamento</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Tipo de Serviço</label>
                                        <select name="tipo_servico" id="tipoServicoFilter" class="form-select">
                                            <option value="">Selecione...</option>
                                            <option value="acesso_veiculos">Acesso de Veículos</option>
                                            <option value="coleta_carga">Coleta de Carga com Pátio Vencido</option>
                                            <option value="descarregamento_exportacao">Descarregamento - Exportação</option>
                                            <option value="visualizacao_video">Visualização de gravação de video</option>
                                            <option value="carga_nacional">Carga nacional</option>
                                            <option value="alteracao_cnpj">Alteração de CNPJ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Entidade</label>
                                        <input type="text" name="entidade" id="entidadeFilter" class="form-control" placeholder="Entidade">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Ficha</label>
                                        <input type="text" name="ficha" id="fichaFilter" class="form-control" placeholder="Ficha">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Processo</label>
                                        <input type="text" name="processo" id="processoFilter" class="form-control" placeholder="Processo">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">AWB</label>
                                        <input type="text" name="awb" id="awbFilter" class="form-control" placeholder="AWB">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">HAWB</label>
                                        <input type="text" name="hawb" id="hawbFilter" class="form-control" placeholder="HAWB">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">DI/DUE</label>
                                        <input type="text" name="di_due" id="diDueFilter" class="form-control" placeholder="DI/DUE">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Placa</label>
                                        <input type="text" name="placa" id="placaFilter" class="form-control" placeholder="Placa">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Data de</label>
                                        <input type="date" name="data_de" id="dataDeFilter" class="form-control">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Data até</label>
                                        <input type="date" name="data_ate" id="dataAteFilter" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" onclick="clearAdvancedFilters()">
                                        <i class="fas fa-eraser"></i> Limpar Pesquisa
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Pesquisar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Ações da Tabela -->
            <div class="table-actions">
                <div class="actions-left">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshTable()" title="Atualizar">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                <div class="actions-right">
                    <div class="items-per-page-container">
                        <span class="items-label">Itens por página:</span>
                        <select class="form-select items-select" id="itemsPorPagina">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tabela de Ordens de Serviço -->
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover ordens-table" id="ordensTable">
                        <thead class="table-header">
                            <tr class="table-header-row">
                                <th width="8%" class="text-start">Status</th>
                                <th width="8%" class="text-start">Ficha</th>
                                <th width="15%" class="text-start">Serviço</th>
                                <th width="8%" class="text-center">Data</th>
                                <th width="8%" class="text-center">Hora</th>
                                <th width="10%" class="text-start">Processo</th>
                                <th width="15%" class="text-start">Entidade</th>
                                <th width="8%" class="text-center">AWB</th>
                                <th width="8%" class="text-center">HAWB</th>
                                <th width="8%" class="text-center">DI/DUE</th>
                                <th width="5%" class="text-center">DTA</th>
                                <th width="8%" class="text-center">Placa</th>
                                <th width="8%" class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="ordensTableBody">
                            <!-- Dados serão carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Estado vazio -->
                <div class="empty-state d-none" id="emptyState">
                    <i class="fas fa-clipboard-list fa-4x text-muted mb-3"></i>
                    <h5>Nenhuma ordem de serviço encontrada</h5>
                    <p>Não há ordens de serviço que correspondam aos critérios de busca.</p>
                    <button class="btn btn-primary" id="clearFiltersEmpty">
                        <i class="fas fa-refresh"></i> Limpar Filtros
                    </button>
                </div>
            </div>
            
            </nav>
        </div>
    </div>
    </div>
    
    <!-- View de Cadastro -->
    <div class="content-section" id="cadastroView" style="display: none;">
        <div class="container-fluid">
            <!-- Header da página de cadastro -->
            <div class="page-header">
                <div class="header-content">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-arrow-left fa-2x text-white me-3" onclick="voltarParaListagem()" style="cursor: pointer;"></i>
                        <div class="header-text">
                            <h2>Cadastro de Ordem de Serviço</h2>
                            <p class="page-subtitle">Preencha as informações para criar uma nova ordem de serviço</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulário de Cadastro -->
            <div class="card">
                <div class="card-body">
                <form id="cadastroServicoForm">
                    <div class="form-section">
                        <h6 class="section-title">Detalhes do Serviço</h6>
                            
                            <!-- Checkbox para Serviço sem carga atrelada -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="servicoSemCargaAtrelada">
                                        <label class="form-check-label" for="servicoSemCargaAtrelada">
                                            Serviço sem carga atrelada
                                        </label>
                                </div>
                            </div>
                        </div>

                            <!-- Campos para serviço SEM carga atrelada -->
                            <div id="camposSemCarga">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                            <label for="entidadeServico" class="form-label required">Selecione a Entidade</label>
                                            <input type="text" class="form-control" id="entidadeServico" placeholder="Digite 3 ou mais caracteres para pesquisar a Entidade" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                            <label for="tipoServico" class="form-label required">Tipo <span class="text-danger">*</span></label>
                                            <select class="form-select" id="tipoServico" required>
                                                <option value="">Selecione...</option>
                                                <option value="IMPORTAÇÃO">IMPORTAÇÃO</option>
                                                <option value="EXPORTAÇÃO">EXPORTAÇÃO</option>
                                            </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                            <label for="termoServico" class="form-label">Termo</label>
                                            <input type="text" class="form-control" id="termoServico" placeholder="Termo">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                            <label for="placaServico" class="form-label">Placa</label>
                                            <input type="text" class="form-control" id="placaServico" placeholder="Placa">
                                        </div>
                                </div>
                                </div>
                            </div>

                            <!-- Campos para serviço COM carga atrelada -->
                            <div id="camposComCarga" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label">Selecione o Processo</label>
                            </div>
                        </div>
                        <div class="row">
                                    <div class="col-md-3 mb-3">
                                <div class="form-group">
                                    <label for="awbServico" class="form-label">AWB</label>
                                            <input type="text" class="form-control" id="awbServico" placeholder="AWB">
                                </div>
                            </div>
                                    <div class="col-md-3 mb-3">
                                <div class="form-group">
                                    <label for="hawbServico" class="form-label">HAWB</label>
                                            <input type="text" class="form-control" id="hawbServico" placeholder="HAWB">
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-group">
                                            <label for="diServico" class="form-label">DI</label>
                                            <input type="text" class="form-control" id="diServico" placeholder="DI">
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-group">
                                            <label for="dtaServico" class="form-label">DTA</label>
                                            <input type="text" class="form-control" id="dtaServico" placeholder="DTA">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                            <label for="termoServicoComCarga" class="form-label">Termo</label>
                                            <input type="text" class="form-control" id="termoServicoComCarga" placeholder="Termo">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-group">
                                            <label for="placaServicoComCarga" class="form-label">Placa</label>
                                            <input type="text" class="form-control" id="placaServicoComCarga" placeholder="Placa">
                                        </div>
                                </div>
                                </div>
                            </div>
                            
                            <!-- Seção de Serviços -->
                            <div class="form-section mt-4">
                                <h6 class="section-title">Serviços</h6>
                                
                                <!-- Tabela de serviços -->
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="5%">#</th>
                                                <th width="15%">Serviço</th>
                                                <th width="10%">Data</th>
                                                <th width="8%">Hora</th>
                                                <th width="10%">Data Fim</th>
                                                <th width="8%">Hora Fim</th>
                                                <th width="8%">Quantidade</th>
                                                <th width="10%">Status</th>
                                                <th width="15%">Observação</th>
                                                <th width="10%">CNPJ/CPF Pagador</th>
                                                <th width="8%">Prévia Valor</th>
                                                <th width="8%">Opções</th>
                                            </tr>
                                        </thead>
                                        <tbody id="servicosTableBody">
                                            <tr>
                                                <td colspan="12" class="text-center text-danger py-3">
                                                    Nenhum serviço adicionado
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Formulário para adicionar serviço -->
                                <div class="row mt-3">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" class="form-control" id="novoServico" placeholder="Digite 3 ou mais carac">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" class="form-control" id="novaDataServico" placeholder="dd/mm/aaaa">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="time" class="form-control" id="novaHoraServico" placeholder="00:00">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" class="form-control" id="novaDataFimServico" placeholder="dd/mm/aaaa">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="time" class="form-control" id="novaHoraFimServico" placeholder="00:00">
                                    </div>
                                    <div class="col-md-1 mb-2">
                                        <input type="number" class="form-control" id="novaQuantidadeServico" value="0">
                            </div>
                        </div>
                        <div class="row">
                                    <div class="col-md-2 mb-2">
                                        <select class="form-select" id="novoStatusServico">
                                            <option value="">Selecione...</option>
                                            <option value="SOLICITACAO">Solicitação</option>
                                            <option value="EXECUTADO">Executado</option>
                                            <option value="AGENDAMENTO">Agendamento</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <input type="text" class="form-control" id="novaObservacaoServico" placeholder="Observação">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="text" class="form-control" id="novoCnpjCpfServico" placeholder="CNPJ/CPF Pagador">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="text" class="form-control" id="novaPreviaValorServico" placeholder="Prévia Valor">
                                    </div>
                                    <div class="col-md-1 mb-2">
                                        <button type="button" class="btn btn-dark w-100 d-flex align-items-center justify-content-center" onclick="adicionarServico()" title="Adicionar Serviço">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="voltarParaListagem()">
                            <i class="fas fa-arrow-left"></i> Cancelar
                        </button>
                <button type="button" class="btn btn-success" onclick="salvarServico()">
                    <i class="fas fa-save"></i> Salvar Serviço
                </button>
            </div>
        </div>
    </div>
</div>
    </div>
</main>


<!-- Modal para Visualizar/Editar Serviço -->
<div class="modal fade" id="visualizarServicoModal" tabindex="-1" aria-labelledby="visualizarServicoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visualizarServicoModalLabel">
                    <i class="fas fa-eye me-2"></i>Detalhes da Ordem de Serviço
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="visualizarServicoBody">
                <!-- Conteúdo será carregado via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="editarServico()">
                    <i class="fas fa-edit"></i> Editar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Estilos para cabeçalho da tabela com barra preta */
.table-header-row {
    background-color: #000 !important;
    color: white !important;
}

.table-header-row th {
    background-color: #000 !important;
    color: white !important;
    border-color: #333 !important;
    font-weight: 600;
    padding: 12px 8px;
    vertical-align: middle;
}

.table-header-row th:first-child {
    border-top-left-radius: 8px;
}

.table-header-row th:last-child {
    border-top-right-radius: 8px;
}

/* Garantir que o cabeçalho tenha altura consistente */
.table-header-row th {
    height: 50px;
    line-height: 1.2;
}

/* Estilos para hover no cabeçalho */
.table-header-row:hover th {
    background-color: #000 !important;
}

/* Ajustar espaçamento da tabela */
.ordens-table {
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Estilos para o container da tabela */
.table-container {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Estilos para as linhas da tabela */
.ordens-table tbody tr {
    border-bottom: 1px solid #e9ecef;
}

.ordens-table tbody tr:hover {
    background-color: #f8f9fa;
}

.ordens-table tbody tr:last-child {
    border-bottom: none;
}

/* Estilos para células da tabela */
.ordens-table td {
    padding: 12px 8px;
    vertical-align: middle;
    border: none;
}

/* Alinhamento específico para colunas */
.ordens-table th.text-start,
.ordens-table td.text-start {
    text-align: left !important;
}

.ordens-table th.text-center,
.ordens-table td.text-center {
    text-align: center !important;
}

/* Estilos específicos para a coluna Status */
.ordens-table td.text-start .d-flex {
    justify-content: flex-start;
}

/* Garantir que ícones e texto fiquem alinhados à esquerda */
.ordens-table td.text-start .d-flex .fas {
    margin-right: 0.5rem;
}

/* Responsividade */
@media (max-width: 768px) {
    .table-header-row th {
        padding: 8px 4px;
        font-size: 0.875rem;
    }
    
    .ordens-table td {
        padding: 8px 4px;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/ordem_servico.js') }}"></script>
{% endblock %}
