{% extends "base.html" %}

{% block title %}Cadastro de Processo - Sistema Aduaneiro{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <!-- Cabeçalho da Página -->
            <div class="page-header">
                <div class="header-content">
                    <div class="header-title d-flex align-items-center">
                        <i class="fas fa-arrow-left fa-2x me-3" onclick="voltarParaProcessos()" style="cursor: pointer;"></i>
                        <div>
                            {% if modo == 'edicao' %}
                                <h2 class="mb-0">Editar Processo</h2>
                                <p class="header-subtitle mb-0">Edite as informações do processo aduaneiro</p>
                            {% elif modo == 'visualizacao' %}
                                <h2 class="mb-0">Visualizar Processo</h2>
                                <p class="header-subtitle mb-0">Visualize as informações do processo aduaneiro</p>
                            {% else %}
                                <h2 class="mb-0">Cadastro de Processo</h2>
                                <p class="header-subtitle mb-0">Preencha as informações do processo aduaneiro</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navegador de Seções -->
            <div class="navegador-container mb-3">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle navegador-btn" type="button" id="navegadorDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-list me-2"></i> Navegação
                    </button>
                    <ul class="dropdown-menu navegador-menu" aria-labelledby="navegadorDropdown">
                        <li><a class="dropdown-item navegador-item" href="#detalhes-section">
                            <i class="fas fa-info-circle me-2"></i> Detalhes
                        </a></li>
                        <li><a class="dropdown-item navegador-item" href="#documentos-section">
                            <i class="fas fa-file-alt me-2"></i> Documentos
                        </a></li>
                        <li><a class="dropdown-item navegador-item" href="#carga-section">
                            <i class="fas fa-boxes me-2"></i> Cargas
                        </a></li>
                        <li><a class="dropdown-item navegador-item" href="#observacao-section">
                            <i class="fas fa-comment me-2"></i> Observação Interna
                        </a></li>
                    </ul>
                </div>
            </div>


            <!-- Conteúdo do Formulário -->
            <div class="form-content">
                    <div class="form-section" id="detalhes-section">
                        <h6 class="section-title">Detalhes</h6>
                        <form id="cadastroProcessoForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="despachanteCadastro" class="form-label required">Despachante / Responsável</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="despachanteCadastro" 
                                               placeholder="Digite 3 ou mais caracteres para pesquisar o DESPACHANTE"
                                               required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="clienteCadastro" class="form-label required">Cliente / Consignatário</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="clienteCadastro" 
                                               placeholder="Digite 3 ou mais caracteres para pesquisar o CLIENTE / CONSIGNATÁRIO"
                                               required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="naturezaOperacaoCadastro" class="form-label required">Natureza de Operação</label>
                                        <select class="form-select" id="naturezaOperacaoCadastro" required>
                                            <option value="">Selecione...</option>
                                            <option value="05.03">05.03 - Despacho De Exportacao - Aereo</option>
                                            <option value="05.01">05.01 - Despacho De Exportacao - Maritimo</option>
                                            <option value="05.02">05.02 - Despacho De Exportacao - Rodoviario</option>
                                            <option value="01.01">01.01 - Despacho De Importacao - Aereo</option>
                                            <option value="01.02">01.02 - Despacho De Importacao - Maritimo</option>
                                            <option value="01.03">01.03 - Despacho De Importacao - Rodoviario</option>
                                            <option value="05.04">05.04 - Despacho De Exportacao - Aereo Via Dta</option>
                                            <option value="05.05">05.05 - Devolucao De Madeira Para Exterior</option>
                                            <option value="05.06">05.06 - Despacho De Importacao - Aereo Dsi</option>
                                            <option value="05.08">05.08 - Operacao Courier</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="tabelaAplicada" class="form-label required">Tabela a ser aplicada</label>
                                        <select class="form-select" id="tabelaAplicada" required>
                                            <option value="">Selecione...</option>
                                            <option value="tabela1">Tabela 1 - Importação</option>
                                            <option value="tabela2">Tabela 2 - Exportação</option>
                                            <option value="tabela3">Tabela 3 - Especial</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="referenciaCliente" class="form-label">Referência do Cliente</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="referenciaCliente" 
                                               placeholder="Referência do cliente">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="dataPontoZero" class="form-label">Data (Ponto Zero)</label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="dataPontoZero">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="previsaoCarregamento" class="form-label">Previsão Carregamento</label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="previsaoCarregamento">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="reexportacao" class="form-label">Reexportação</label>
                                        <select class="form-select" id="reexportacao">
                                            <option value="">Selecione...</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">Não</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="observacao" class="form-label">Observação</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="observacao" 
                                               placeholder="Observação">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Novos campos solicitados -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="receberGuiasEmail" class="form-label">Receber Guias E-mail</label>
                                        <select class="form-select" id="receberGuiasEmail">
                                            <option value="">Selecione...</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">Não</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="emailGuias" class="form-label">E-mail Guias</label>
                                        <input type="email" 
                                               class="form-control" 
                                               id="emailGuias" 
                                               placeholder="E-mail Guia">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="impedimentoCarga" class="form-label">Impedimento da Carga</label>
                                        <select class="form-select" id="impedimentoCarga">
                                            <option value="">Selecione...</option>
                                            <option value="impedimento_cct_bloqueio_pgto_frete">Impedimento CCT - Bloqueio Pgto Frete</option>
                                            <option value="impedimento_cct_conhecimento_sem_di">Impedimento CCT - Conhecimento sem DI vinculada</option>
                                            <option value="impedimento_cct_di_manual_sem_autorizacao">Impedimento CCT - DI vinculada manualmente sem autorização de entrega da RFB</option>
                                            <option value="impedimento_cct_carga_abandono">Impedimento CCT - Carga em Abandono</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                        </form>
                    </div>
                    
                    <!-- Seção Documentos -->
                    <div class="form-section" id="documentos-section">
                        <!-- Abas no lugar do título -->
                        {% if modo == 'edicao' or modo == 'visualizacao' %}
                        <div class="section-tabs-left">
                            <button class="section-tab-btn active" data-tab="documentos-content">
                                <i class="fas fa-file-alt"></i> Documentos
                            </button>
                            <button class="section-tab-btn" data-tab="servicos-content">
                                <i class="fas fa-cogs"></i> Serviços
                            </button>
                        </div>
                        {% else %}
                        <h6 class="section-title">Documentos</h6>
                        <p class="text-muted mb-3" style="font-size: 0.85rem;" id="mensagemNaturezaOperacaoCadastro">
                            <i class="fas fa-info-circle me-2"></i>
                            Selecione uma natureza de operação para listar os documentos
                        </p>
                        {% endif %}
                        
                        <!-- Conteúdo das Abas -->
                        <div class="section-tab-content">
                            <!-- Aba Documentos -->
                            <div class="tab-content-pane active" id="documentos-content-tab">
                                <!-- Mensagem informativa apenas na aba Documentos (modo edição/visualização) -->
                                {% if modo == 'edicao' or modo == 'visualizacao' %}
                                <p class="text-muted mb-3" style="font-size: 0.85rem;" id="mensagemNaturezaOperacao">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Selecione uma natureza de operação para listar os documentos
                                </p>
                                {% endif %}
                                
                                <!-- Lista de Documentos -->
                                <div id="documentosLista" class="documentos-container" style="display: none;">
                                    <div class="documentos-layout">
                                        <!-- Lista de Documentos (Lado Esquerdo) -->
                                        <div class="documentos-sidebar">
                                            <div class="documentos-list" id="documentosList">
                                                <!-- Documentos serão carregados dinamicamente -->
                                            </div>
                                        </div>
                                        
                                        <!-- Detalhes do Documento (Lado Direito) -->
                                        <div class="documentos-details" id="documentosDetails">
                                            <div class="documento-placeholder">
                                                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                                                <h6 class="text-muted">Selecione um documento para visualizar os detalhes</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Aba Serviços (apenas para edição e visualização) -->
                            {% if modo == 'edicao' or modo == 'visualizacao' %}
                            <div class="tab-content-pane" id="servicos-content-tab">
                                <!-- Lista de Serviços -->
                                <div class="servicos-lista mt-3">
                                        <h6 class="mb-3">Serviços Prestados</h6>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Serviço</th>
                                                        <th>Observação</th>
                                                        <th>Data</th>
                                                        <th>Hora</th>
                                                        <th>Data Final</th>
                                                        <th>Hora Final</th>
                                                        <th>Parâmetro</th>
                                                        <th>Status</th>
                                                        <th>Opções</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="servicosTableBody">
                                                    <!-- Serviços serão carregados dinamicamente -->
                                                    <tr>
                                                        <td colspan="10" class="text-center text-muted">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            Nenhum serviço registrado ainda
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Seção Carga -->
                    <div class="form-section mt-4" id="carga-section">
                        <h6 class="section-title">Carga</h6>
                        <form id="cargaForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="regimeAduaneiroCadastro" class="form-label">Regime Aduaneiro</label>
                                        <select class="form-select" id="regimeAduaneiroCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="exportacao_definitiva">Exportação Definitiva</option>
                                            <option value="exportacao_temporaria">Exportação Temporária</option>
                                            <option value="importacao_definitiva">Importação Definitiva</option>
                                            <option value="importacao_temporaria">Importação Temporária</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="objetivoImportacaoCadastro" class="form-label">Objetivo da Importação/Exportação</label>
                                        <select class="form-select" id="objetivoImportacaoCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="comercial">Comercial</option>
                                            <option value="industrial">Industrial</option>
                                            <option value="pessoal">Pessoal</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="tipoCargaCadastro" class="form-label">Tipo da Carga</label>
                                        <select class="form-select" id="tipoCargaCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="geral">Carga Geral</option>
                                            <option value="granel">Granel</option>
                                            <option value="perigosa">Perigosa</option>
                                            <option value="refrigerada">Refrigerada</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="imoDgrCadastro" class="form-label">IMO / DGR</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="imoDgrCadastro" 
                                               placeholder="IMO/DGR">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="imoDgrCadastro" class="form-label">IMO / DGR</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="imoDgrCadastro" 
                                               placeholder="Selecione...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="volumeCadastro" class="form-label">Volume</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="volumeCadastro" 
                                               placeholder="Volume">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="pesoBrutoCadastro" class="form-label">Peso Bruto</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="pesoBrutoCadastro" 
                                               placeholder="Peso Bruto">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="valorCifCadastro" class="form-label">Valor CIF</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="valorCifCadastro" 
                                               placeholder="0,00"
                                               step="0.01">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="valorFreteCadastro" class="form-label">Valor Frete</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="valorFreteCadastro" 
                                               placeholder="0,00"
                                               step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="valorSeguroCadastro" class="form-label">Valor Seguro</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="valorSeguroCadastro" 
                                               placeholder="0,00"
                                               step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="valorFobCadastro" class="form-label">Valor FOB</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="valorFobCadastro" 
                                               placeholder="0,00"
                                               step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="moedaFreteCadastro" class="form-label">Moeda Frete</label>
                                        <select class="form-select" id="moedaFreteCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="moedaSeguroCadastro" class="form-label">Moeda Seguro</label>
                                        <select class="form-select" id="moedaSeguroCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="moedaFobCadastro" class="form-label">Moeda FOB</label>
                                        <select class="form-select" id="moedaFobCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                            <option value="BRL">BRL</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="embalagemMadeiraCadastro" class="form-label">Embalagem / Suporte de Madeira?</label>
                                        <select class="form-select" id="embalagemMadeiraCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">Não</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="controleTemperaturaCadastro" class="form-label">Controle de Temperatura?</label>
                                        <select class="form-select" id="controleTemperaturaCadastro">
                                            <option value="">Selecione...</option>
                                            <option value="sim">Sim</option>
                                            <option value="nao">Não</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campos de Temperatura (aparecem quando controle de temperatura = Sim) -->
                            <div class="row" id="camposTemperatura" style="display: none;">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="temperaturaMinimaCadastro" class="form-label">Temperatura Mínima (°C)</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="temperaturaMinimaCadastro" 
                                               placeholder="Ex: -20"
                                               step="0.1">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="temperaturaMaximaCadastro" class="form-label">Temperatura Máxima (°C)</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="temperaturaMaximaCadastro" 
                                               placeholder="Ex: 25"
                                               step="0.1">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Seção Observação Interna -->
                    <div class="form-section" id="observacao-section">
                        <h6 class="section-title">Observação Interna</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="observacaoInterna" class="form-label">Observação Interna</label>
                                    <textarea class="form-control" 
                                              id="observacaoInterna" 
                                              rows="4" 
                                              placeholder="Digite observações internas sobre o processo"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex flex-column align-items-end">
                                {% if modo == 'visualizacao' %}
                                    <button type="button" class="btn btn-primary mb-2" onclick="voltarParaProcessos()">
                                        <i class="fas fa-arrow-left"></i> Voltar
                                    </button>
                                    <button type="button" class="btn btn-warning mb-2" onclick="editarProcesso()">
                                        <i class="fas fa-edit"></i> Editar Processo
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-primary btn-salvar mb-2">
                                        <i class="fas fa-save"></i> Salvar
                                    </button>
                                    <button type="button" class="btn btn-warning btn-solicitar-faturamento mb-2">
                                        <i class="fas fa-file-invoice-dollar"></i> Solicitar Faturamento
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="descartarAlteracoesCadastro">
                                        <i class="fas fa-times"></i> Descartar Alterações
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal de Edição/Visualização de Serviço -->
<div class="modal fade" id="servicoModal" tabindex="-1" aria-labelledby="servicoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="servicoModalLabel">
                    <i class="fas fa-cogs me-2"></i>
                    <span id="servicoModalTitle">Editar Serviço</span> - <span id="servicoIdDisplay"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="servicoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoNome" class="form-label required">Serviço *</label>
                                <input type="text" class="form-control" id="servicoNome" placeholder="Digite o nome do serviço" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoStatus" class="form-label required">Status *</label>
                                <select class="form-select" id="servicoStatus" required>
                                    <option value="">Selecione...</option>
                                    <option value="EXECUTADO">Executado</option>
                                    <option value="EM_ANDAMENTO">Em Andamento</option>
                                    <option value="AGENDADO">Agendado</option>
                                    <option value="CANCELADO">Cancelado</option>
                                    <option value="PENDENTE">Pendente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoData" class="form-label required">Data *</label>
                                <input type="date" class="form-control" id="servicoData" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoHora" class="form-label required">Hora *</label>
                                <input type="time" class="form-control" id="servicoHora" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoDataFinal" class="form-label">Data Final</label>
                                <input type="date" class="form-control" id="servicoDataFinal">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoHoraFinal" class="form-label">Hora Final</label>
                                <input type="time" class="form-control" id="servicoHoraFinal">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoQuantidade" class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="servicoQuantidade" value="1" min="1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servicoObservacao" class="form-label">Observação</label>
                                <input type="text" class="form-control" id="servicoObservacao" placeholder="Observações sobre o serviço">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarServico">
                    <i class="fas fa-save"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para o modo visualização do modal de serviços */
#servicoModal .view-mode .form-control:read-only,
#servicoModal .view-mode .form-select:disabled {
    background-color: #f8f9fa !important;
    border-color: #dee2e6 !important;
    color: #6c757d !important;
    cursor: not-allowed !important;
}

#servicoModal .view-mode .form-control:read-only:focus,
#servicoModal .view-mode .form-select:disabled:focus {
    box-shadow: none !important;
    border-color: #dee2e6 !important;
}

#servicoModal .view-mode .form-label {
    color: #6c757d !important;
    font-weight: 500;
}

#servicoModal .view-mode .required::after {
    color: #6c757d !important;
}
</style>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/processos.js') }}"></script>
<script>
// Função para voltar para a lista de processos
function voltarParaProcessos() {
    window.location.href = "/web-clientes/processos";
}

// Inicializar o gerenciador de processos
document.addEventListener('DOMContentLoaded', function() {
    // ProcessosManager já é inicializado no arquivo processos.js
    
    // Configurar modo da página
    const urlParams = new URLSearchParams(window.location.search);
    const modo = urlParams.get('modo') || 'cadastro';
    const processoId = urlParams.get('id');
    
    // Configurar campos baseado no modo
    if (modo === 'visualizacao') {
        configurarModoVisualizacao();
    } else if (modo === 'edicao') {
        configurarModoEdicao();
    }
    
    // Configurar abas da seção de documentos
    setupSectionTabs();
    
    // Carregar serviços se estiver em modo de edição ou visualização
    if (modo === 'edicao' || modo === 'visualizacao') {
        carregarServicos();
    }
    
    // Controlar visibilidade inicial da mensagem
    if (modo === 'cadastro') {
        controlarVisibilidadeMensagem('cadastro');
    }
    
// Configurar listener para natureza de operação
const naturezaOperacaoCadastro = document.getElementById('naturezaOperacaoCadastro');
if (naturezaOperacaoCadastro) {
    naturezaOperacaoCadastro.addEventListener('change', function() {
        // Chamar função de controle de visibilidade da mensagem
        if (modo === 'cadastro') {
            controlarVisibilidadeMensagem('cadastro');
        } else {
            controlarVisibilidadeMensagem('documentos-content');
        }
    });
}
    
    // Controlar exibição dos campos de temperatura
    const controleTemperatura = document.getElementById('controleTemperaturaCadastro');
    const camposTemperatura = document.getElementById('camposTemperatura');
    
    if (controleTemperatura && camposTemperatura) {
        controleTemperatura.addEventListener('change', function() {
            if (this.value === 'sim') {
                camposTemperatura.style.display = 'block';
            } else {
                camposTemperatura.style.display = 'none';
                // Limpar os campos quando ocultar
                document.getElementById('temperaturaMinimaCadastro').value = '';
                document.getElementById('temperaturaMaximaCadastro').value = '';
            }
        });
    }
    
    // Controlar obrigatoriedade do campo E-mail Guias baseado em Receber Guias E-mail
    const receberGuiasEmail = document.getElementById('receberGuiasEmail');
    const emailGuias = document.getElementById('emailGuias');
    
    if (receberGuiasEmail && emailGuias) {
        receberGuiasEmail.addEventListener('change', function() {
            if (this.value === 'sim') {
                // Tornar o campo obrigatório
                emailGuias.setAttribute('required', 'required');
                emailGuias.classList.add('required-field');
                
                // Adicionar asterisco ao label
                const label = emailGuias.previousElementSibling;
                if (label && !label.querySelector('.required-asterisk')) {
                    const asterisk = document.createElement('span');
                    asterisk.className = 'required-asterisk text-danger';
                    asterisk.textContent = ' *';
                    label.appendChild(asterisk);
                }
            } else {
                // Remover obrigatoriedade
                emailGuias.removeAttribute('required');
                emailGuias.classList.remove('required-field');
                
                // Remover asterisco do label
                const label = emailGuias.previousElementSibling;
                const asterisk = label?.querySelector('.required-asterisk');
                if (asterisk) {
                    asterisk.remove();
                }
                
                // Limpar o campo
                emailGuias.value = '';
            }
        });
    }
    
    // Navegador de seções
    const navegadorItems = document.querySelectorAll('.navegador-item');
    navegadorItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                // Scroll direto para a seção (sem necessidade de abas)
                
                // Scroll suave para a seção
                setTimeout(() => {
                    targetElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
        });
    });
});

// Funções para configurar modos da página
function configurarModoVisualizacao() {
    // Tornar todos os campos readonly
    const formElements = document.querySelectorAll('input, select, textarea, button');
    formElements.forEach(element => {
        if (element.type !== 'button' && element.onclick !== voltarParaProcessos) {
            element.setAttribute('readonly', true);
            element.setAttribute('disabled', true);
        }
    });
    
    // Remover readonly dos botões de ação específicos
    const voltarBtn = document.querySelector('button[onclick="voltarParaProcessos()"]');
    const editarBtn = document.querySelector('button[onclick="editarProcesso()"]');
    if (voltarBtn) voltarBtn.removeAttribute('disabled');
    if (editarBtn) editarBtn.removeAttribute('disabled');
    
    // Configurar campos específicos da aba de serviços
    configurarCamposServicos();
}

function configurarModoEdicao() {
    // Campos editáveis (modo padrão)
    // Não precisa fazer nada especial, campos já estão editáveis
}

function editarProcesso() {
    // Redirecionar para modo de edição
    const urlParams = new URLSearchParams(window.location.search);
    const processoId = urlParams.get('id');
    window.location.href = `/web-clientes/processos/cadastro?modo=edicao&id=${processoId}`;
}

// Função para configurar as abas da seção de documentos
function setupSectionTabs() {
    const tabButtons = document.querySelectorAll('.section-tab-btn');
    const tabPanes = document.querySelectorAll('.tab-content-pane');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Remove active class from all buttons and panes
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Add active class to clicked button and corresponding pane
            button.classList.add('active');
            document.getElementById(`${targetTab}-tab`).classList.add('active');
            
            // Controlar visibilidade da mensagem baseado na aba ativa
            controlarVisibilidadeMensagem(targetTab);
        });
    });
}

// Função para controlar a visibilidade da mensagem baseado na aba ativa
function controlarVisibilidadeMensagem(abaAtiva) {
    const mensagemNaturezaOperacao = document.getElementById('mensagemNaturezaOperacao');
    const mensagemNaturezaOperacaoCadastro = document.getElementById('mensagemNaturezaOperacaoCadastro');
    const naturezaOperacaoCadastro = document.getElementById('naturezaOperacaoCadastro');
    
    // Obter modo da URL
    const urlParams = new URLSearchParams(window.location.search);
    const modo = urlParams.get('modo') || 'cadastro';
    
    // Controlar mensagem da aba Documentos (apenas em modo edição/visualização)
    if (mensagemNaturezaOperacao && (modo === 'edicao' || modo === 'visualizacao')) {
        if (abaAtiva === 'documentos-content') {
            // Na aba Documentos, mostrar mensagem apenas se não há natureza selecionada
            if (!naturezaOperacaoCadastro || !naturezaOperacaoCadastro.value) {
                mensagemNaturezaOperacao.style.display = 'block';
            } else {
                mensagemNaturezaOperacao.style.display = 'none';
            }
        } else if (abaAtiva === 'servicos-content') {
            // Na aba Serviços, sempre ocultar a mensagem
            mensagemNaturezaOperacao.style.display = 'none';
        }
    }
    
    // Controlar mensagem do modo cadastro (sem abas)
    if (mensagemNaturezaOperacaoCadastro && modo === 'cadastro') {
        if (!naturezaOperacaoCadastro || !naturezaOperacaoCadastro.value) {
            mensagemNaturezaOperacaoCadastro.style.display = 'block';
        } else {
            mensagemNaturezaOperacaoCadastro.style.display = 'none';
        }
    }
}

// Função para carregar dados de serviços (simulação)
function carregarServicos() {
    const servicosTableBody = document.getElementById('servicosTableBody');
    if (!servicosTableBody) return;
    
    // Se servicosData estiver vazio, inicializar com dados simulados
    if (servicosData.length === 0) {
        servicosData.push(
            {
                id: 1,
                servico: 'GRIS',
                status: 'EXECUTADO',
                responsavel: 'Sistema',
                dataInicio: '01/09/2025',
                dataConclusao: '01/09/2025',
                observacao: 'Serviço compulsório gerado automaticamente',
                parametro: '1',
                horaInicio: '14:41',
                horaConclusao: '14:41'
            },
            {
                id: 2,
                servico: 'Carregamento / descarregamento - 100,01kg a 500kg',
                status: 'AGENDAMENTO',
                responsavel: 'Sistema',
                dataInicio: '',
                dataConclusao: '',
                observacao: 'Serviço de carregamento gerado automaticamente',
                parametro: '1',
                horaInicio: '',
                horaConclusao: ''
            }
        );
    }
    
    const servicos = servicosData;
    
    if (servicos.length === 0) {
        servicosTableBody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    Nenhum serviço registrado ainda
                </td>
            </tr>
        `;
        return;
    }
    
     servicosTableBody.innerHTML = servicos.map(servico => `
         <tr>
             <td>${servico.id}</td>
             <td>${servico.servico}</td>
             <td>${servico.observacao}</td>
             <td>${servico.dataInicio || '-'}</td>
             <td>${servico.horaInicio || '-'}</td>
             <td>${servico.dataConclusao || '-'}</td>
             <td>${servico.horaConclusao || '-'}</td>
             <td>${servico.parametro}</td>
             <td>${servico.status}</td>
             <td>
                 <div class="dropdown">
                     <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                         <i class="fas fa-bars"></i>
                     </button>
                     <ul class="dropdown-menu">
                         <li>
                             <button class="dropdown-item" title="Editar" onclick="editarServico(${servico.id})">
                                 <i class="fas fa-edit me-2"></i> Editar
                             </button>
                         </li>
                         <li>
                             <button class="dropdown-item" title="Visualizar" onclick="visualizarServico(${servico.id})">
                                 <i class="fas fa-search-plus me-2"></i> Visualizar
                             </button>
                         </li>
                         <li><hr class="dropdown-divider"></li>
                         <li>
                             <button class="dropdown-item text-danger" title="Excluir" onclick="excluirServico(${servico.id})">
                                 <i class="fas fa-trash me-2"></i> Excluir
                             </button>
                         </li>
                     </ul>
                 </div>
             </td>
         </tr>
     `).join('');
}


function formatarData(data) {
    if (!data) return '-';
    return new Date(data).toLocaleDateString('pt-BR');
}

function configurarCamposServicos() {
    // Configurar campos específicos da aba de serviços
    const camposServicos = [
        'statusServico',
        'responsavelServico', 
        'dataInicioServico',
        'dataConclusaoServico',
        'observacoesServico'
    ];
    
    camposServicos.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            campo.setAttribute('readonly', true);
            campo.setAttribute('disabled', true);
        }
    });
}

// Variáveis globais para controle do modal de serviços
var servicosData = servicosData || [];
var servicoAtual = null;
var modoServico = 'edicao'; // 'edicao' ou 'visualizacao'

// Função para editar serviço
function editarServico(servicoId) {
    const servico = servicosData.find(s => s.id === servicoId);
    if (!servico) return;
    
    servicoAtual = servico;
    modoServico = 'edicao';
    abrirModalServico('Editar Serviço', servicoId);
    preencherFormularioServico(servico);
}

// Função para visualizar serviço
function visualizarServico(servicoId) {
    const servico = servicosData.find(s => s.id === servicoId);
    if (!servico) return;
    
    servicoAtual = servico;
    modoServico = 'visualizacao';
    abrirModalServico('Visualizar Serviço', servicoId);
    preencherFormularioServico(servico);
    
    // Aguardar um pouco para garantir que o modal esteja totalmente carregado
    setTimeout(() => {
        tornarCamposReadonly();
    }, 100);
}

// Função para excluir serviço
function excluirServico(servicoId) {
    if (confirm('Tem certeza que deseja excluir este serviço?')) {
        servicosData = servicosData.filter(s => s.id !== servicoId);
        carregarServicos();
    }
}

// Função para abrir o modal de serviço
function abrirModalServico(titulo, servicoId) {
    document.getElementById('servicoModalTitle').textContent = titulo;
    document.getElementById('servicoIdDisplay').textContent = servicoId;
    
    const modal = new bootstrap.Modal(document.getElementById('servicoModal'));
    modal.show();
}

// Função para preencher o formulário do serviço
function preencherFormularioServico(servico) {
    document.getElementById('servicoNome').value = servico.servico || '';
    document.getElementById('servicoStatus').value = servico.status || '';
    
    // Converter datas do formato DD/MM/YYYY para YYYY-MM-DD
    if (servico.dataInicio) {
        const dataInicio = converterDataParaInput(servico.dataInicio);
        document.getElementById('servicoData').value = dataInicio;
    }
    
    if (servico.horaInicio) {
        document.getElementById('servicoHora').value = servico.horaInicio;
    }
    
    if (servico.dataConclusao) {
        const dataConclusao = converterDataParaInput(servico.dataConclusao);
        document.getElementById('servicoDataFinal').value = dataConclusao;
    }
    
    if (servico.horaConclusao) {
        document.getElementById('servicoHoraFinal').value = servico.horaConclusao;
    }
    
    document.getElementById('servicoQuantidade').value = servico.parametro || '1';
    document.getElementById('servicoObservacao').value = servico.observacao || '';
}

// Função para converter data do formato DD/MM/YYYY para YYYY-MM-DD
function converterDataParaInput(dataString) {
    if (!dataString || dataString === '-') return '';
    const partes = dataString.split('/');
    if (partes.length === 3) {
        return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
    }
    return '';
}

// Função para converter data do formato YYYY-MM-DD para DD/MM/YYYY
function converterDataParaExibicao(dataString) {
    if (!dataString) return '';
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR');
}

// Função para tornar campos readonly no modo visualização
function tornarCamposReadonly() {
    const campos = [
        'servicoNome', 'servicoStatus', 'servicoData', 'servicoHora',
        'servicoDataFinal', 'servicoHoraFinal', 'servicoQuantidade', 'servicoObservacao'
    ];
    
    campos.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            // Para inputs de texto e number
            if (campo.type === 'text' || campo.type === 'number') {
                campo.setAttribute('readonly', true);
                campo.style.backgroundColor = '#f8f9fa';
                campo.style.cursor = 'not-allowed';
            }
            // Para selects
            else if (campo.tagName === 'SELECT') {
                campo.setAttribute('disabled', true);
                campo.style.backgroundColor = '#f8f9fa';
                campo.style.cursor = 'not-allowed';
            }
            // Para inputs de data e hora
            else if (campo.type === 'date' || campo.type === 'time') {
                campo.setAttribute('readonly', true);
                campo.setAttribute('disabled', true);
                campo.style.backgroundColor = '#f8f9fa';
                campo.style.cursor = 'not-allowed';
            }
        }
    });
    
    // Ocultar botão de confirmar no modo visualização
    const confirmarBtn = document.getElementById('confirmarServico');
    if (confirmarBtn) {
        confirmarBtn.style.display = 'none';
    }
    
    // Adicionar classe visual para indicar modo visualização
    const modalBody = document.querySelector('#servicoModal .modal-body');
    if (modalBody) {
        modalBody.classList.add('view-mode');
    }
}

// Função para tornar campos editáveis no modo edição
function tornarCamposEditaveis() {
    const campos = [
        'servicoNome', 'servicoStatus', 'servicoData', 'servicoHora',
        'servicoDataFinal', 'servicoHoraFinal', 'servicoQuantidade', 'servicoObservacao'
    ];
    
    campos.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            // Remover atributos de readonly/disabled
            campo.removeAttribute('readonly');
            campo.removeAttribute('disabled');
            
            // Restaurar estilos normais
            campo.style.backgroundColor = '';
            campo.style.cursor = '';
        }
    });
    
    // Mostrar botão de confirmar no modo edição
    const confirmarBtn = document.getElementById('confirmarServico');
    if (confirmarBtn) {
        confirmarBtn.style.display = 'inline-block';
    }
    
    // Remover classe visual do modo visualização
    const modalBody = document.querySelector('#servicoModal .modal-body');
    if (modalBody) {
        modalBody.classList.remove('view-mode');
    }
}

// Event listener para o botão de confirmar serviço
document.addEventListener('DOMContentLoaded', function() {
    const confirmarServicoBtn = document.getElementById('confirmarServico');
    if (confirmarServicoBtn) {
        confirmarServicoBtn.addEventListener('click', function() {
            if (modoServico === 'edicao') {
                salvarServico();
            }
        });
    }
    
    // Event listener para quando o modal é fechado
    const servicoModal = document.getElementById('servicoModal');
    if (servicoModal) {
        servicoModal.addEventListener('hidden.bs.modal', function() {
            // Limpar formulário
            document.getElementById('servicoForm').reset();
            servicoAtual = null;
            modoServico = 'edicao';
            tornarCamposEditaveis();
        });
    }
});

// Função para salvar serviço
function salvarServico() {
    const servicoNome = document.getElementById('servicoNome').value;
    const servicoStatus = document.getElementById('servicoStatus').value;
    const servicoData = document.getElementById('servicoData').value;
    const servicoHora = document.getElementById('servicoHora').value;
    const servicoDataFinal = document.getElementById('servicoDataFinal').value;
    const servicoHoraFinal = document.getElementById('servicoHoraFinal').value;
    const servicoQuantidade = document.getElementById('servicoQuantidade').value;
    const servicoObservacao = document.getElementById('servicoObservacao').value;
    
    // Validação básica
    if (!servicoNome || !servicoStatus || !servicoData || !servicoHora) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    // Atualizar dados do serviço
    if (servicoAtual) {
        servicoAtual.servico = servicoNome;
        servicoAtual.status = servicoStatus;
        servicoAtual.dataInicio = converterDataParaExibicao(servicoData);
        servicoAtual.horaInicio = servicoHora;
        servicoAtual.dataConclusao = servicoDataFinal ? converterDataParaExibicao(servicoDataFinal) : '';
        servicoAtual.horaConclusao = servicoHoraFinal;
        servicoAtual.parametro = servicoQuantidade;
        servicoAtual.observacao = servicoObservacao;
    }
    
    // Atualizar tabela
    carregarServicos();
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('servicoModal'));
    modal.hide();
    
    alert('Serviço salvo com sucesso!');
}
</script>
{% endblock %}
{% endblock %}