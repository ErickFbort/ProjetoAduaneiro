{% extends "base.html" %}

{% block title %}Cadastros - Veículos{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <!-- Cabeçalho da Página -->
            <div class="page-header">
                <div class="header-content">
                    <div class="header-title">
                        <h2><i class="fas fa-truck"></i> Cadastro de Veículos</h2>
                        <p class="header-subtitle">Gerencie a frota de veículos do sistema</p>
                    </div>
                </div>
            </div>

            <!-- Barra de Pesquisa e Filtros -->
            <div class="search-section">
                <div class="search-input-group">
                    <form method="GET" class="search-form">
                        <div class="input-group">
                            <input type="text" 
                                   name="search" 
                                   value="{{ search }}" 
                                   class="form-control search-input" 
                                   placeholder="Pesquisar por motorista, CPF, placa ou RENAVAM...">
                            <button type="submit" class="btn btn-primary search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                            {% if search %}
                            <a href="{{ url_for('cadastros.cadastros_veiculos') }}" class="btn btn-outline-secondary clear-btn">
                                <i class="fas fa-times"></i>
                            </a>
                            {% endif %}
                        </div>
                    </form>
                    <button class="btn btn-outline-info filter-toggle" onclick="toggleAdvancedFilters()">
                        <i class="fas fa-filter"></i> Filtros Avançados
                    </button>
                    <button class="btn btn-success" onclick="openAddVehicleModal()">
                        <i class="fas fa-plus"></i> Adicionar Veículo
                    </button>
                </div>

                <!-- Filtros Avançados -->
                <div class="advanced-filters" id="advancedFilters" style="display: none;">
                    <form method="GET" class="filters-form">
                        <input type="hidden" name="search" value="{{ search }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Tipo de Veículo</label>
                                <select name="tipo" class="form-select">
                                    <option value="">Todos os tipos</option>
                                    <option value="Cavalo" {% if tipo_filter == 'Cavalo' %}selected{% endif %}>Cavalo</option>
                                    <option value="Carreta" {% if tipo_filter == 'Carreta' %}selected{% endif %}>Carreta</option>
                                    <option value="Truck" {% if tipo_filter == 'Truck' %}selected{% endif %}>Truck</option>
                                    <option value="Reboque" {% if tipo_filter == 'Reboque' %}selected{% endif %}>Reboque</option>
                                    <option value="Outros" {% if tipo_filter == 'Outros' %}selected{% endif %}>Outros</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Estado</label>
                                <select name="estado" class="form-select">
                                    <option value="">Todos os estados</option>
                                    <option value="SP" {% if estado_filter == 'SP' %}selected{% endif %}>São Paulo</option>
                                    <option value="RJ" {% if estado_filter == 'RJ' %}selected{% endif %}>Rio de Janeiro</option>
                                    <option value="MG" {% if estado_filter == 'MG' %}selected{% endif %}>Minas Gerais</option>
                                    <option value="PR" {% if estado_filter == 'PR' %}selected{% endif %}>Paraná</option>
                                    <option value="RS" {% if estado_filter == 'RS' %}selected{% endif %}>Rio Grande do Sul</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="">Todos os status</option>
                                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Ativo</option>
                                    <option value="blocked" {% if status_filter == 'blocked' %}selected{% endif %}>Bloqueado</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end gap-2">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-check"></i> Aplicar
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Ações da Tabela -->
            <div class="table-actions">
                <div class="actions-left">
                    <div class="btn-group">
                        <button class="btn btn-outline-success" onclick="exportVehicles()" title="Exportar para Excel">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                        <button class="btn btn-outline-primary" onclick="importVehicles()" title="Importar do CSV">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshTable()" title="Atualizar">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Veículos -->
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover vehicles-table">
                        <thead class="table-header">
                            <tr>
                                <th>Motorista</th>
                                <th>CPF</th>
                                <th>Placa</th>
                                <th>RENAVAM</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Status</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if veiculos and veiculos.items %}
                            {% for veiculo in veiculos.items %}
                            <tr class="vehicle-row" data-vehicle-id="{{ veiculo.id }}">
                                <td class="driver-cell">
                                    <div class="driver-info">
                                        <div class="driver-name">{{ veiculo.motorista_responsavel }}</div>
                                        <div class="driver-details">
                                            <small class="text-muted">{{ veiculo.municipio or 'N/A' }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="cpf-cell">
                                    <div class="cpf-value">{{ veiculo.cpf_motorista }}</div>
                                </td>
                                <td class="placa-cell">
                                    <div class="placa-value">{{ veiculo.placa }}</div>
                                </td>
                                <td class="renavam-cell">
                                    <div class="renavam-value">{{ veiculo.renavam or '-' }}</div>
                                </td>
                                <td class="tipo-cell">
                                    <div class="tipo-value">
                                        {% if veiculo.tipo == 'Outros' and veiculo.tipo_outros %}
                                            {{ veiculo.tipo_outros }}
                                        {% else %}
                                            {{ veiculo.tipo }}
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="estado-cell">
                                    <div class="estado-value">{{ veiculo.estado or '-' }}</div>
                                </td>
                                <td class="status-cell">
                                    <span class="status-badge status-{{ veiculo.status }}">
                                        {{ 'Ativo' if veiculo.status == 'active' else 'Bloqueado' }}
                                    </span>
                                </td>
                                <td class="actions-cell">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary edit-vehicle" 
                                                data-vehicle-id="{{ veiculo.id }}" 
                                                title="Editar veículo">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning toggle-status" 
                                                data-vehicle-id="{{ veiculo.id }}" 
                                                title="{{ 'Bloquear' if veiculo.status == 'active' else 'Desbloquear' }} veículo">
                                            <i class="fas fa-{{ 'lock' if veiculo.status == 'active' else 'unlock' }}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-vehicle" 
                                                data-vehicle-id="{{ veiculo.id }}" 
                                                title="Excluir veículo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            
                            <!-- Mensagem quando não há registros -->
                            {% if not veiculos or not veiculos.items %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div class="empty-state">
                                        <i class="fas fa-truck fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">Nenhum veículo encontrado</h5>
                                        <p class="text-muted">
                                            {% if search %}
                                                Não foram encontrados veículos para a busca "{{ search }}".
                                            {% elif tipo_filter or estado_filter or status_filter %}
                                                Não foram encontrados veículos com os filtros aplicados.
                                            {% else %}
                                                Nenhum veículo cadastrado no sistema.
                                            {% endif %}
                                        </p>
                                        <button class="btn btn-primary" onclick="clearFilters()">
                                            <i class="fas fa-refresh"></i> Limpar Filtros
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Paginação -->
            {% if veiculos and veiculos.pages and veiculos.pages > 1 %}
            <nav aria-label="Paginação">
                <ul class="pagination justify-content-center">
                    {% if veiculos.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ veiculos.prev_num }}">Anterior</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in veiculos.iter_pages() %}
                    <li class="page-item {% if page_num == veiculos.page %}active{% endif %}">
                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if veiculos.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ veiculos.next_num }}">Próximo</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</main>

<!-- Modal para Adicionar/Editar Veículo -->
<div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Adicionar Novo Veículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="vehicle-form">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="motorista_responsavel" class="form-label">Nome do Motorista *</label>
                                <input type="text" class="form-control" id="motorista_responsavel" name="motorista_responsavel" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cpf_motorista" class="form-label">CPF do Motorista *</label>
                                <input type="text" class="form-control" id="cpf_motorista" name="cpf_motorista" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="placa" class="form-label">Placa *</label>
                                <input type="text" class="form-control" id="placa" name="placa" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="renavam" class="form-label">RENAVAM</label>
                                <input type="text" class="form-control" id="renavam" name="renavam">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo" class="form-label">Tipo *</label>
                                <select class="form-select" id="tipo" name="tipo" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="Cavalo">Cavalo</option>
                                    <option value="Carreta">Carreta</option>
                                    <option value="Truck">Truck</option>
                                    <option value="Reboque">Reboque</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="tipo-outros-container" style="display: none;">
                                <label for="tipo_outros" class="form-label">Especificar Tipo</label>
                                <input type="text" class="form-control" id="tipo_outros" name="tipo_outros">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="estado" class="form-label">Estado</label>
                                <select class="form-select" id="estado" name="estado">
                                    <option value="">Selecione o estado</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="municipio" class="form-label">Município</label>
                                <input type="text" class="form-control" id="municipio" name="municipio">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status do Veículo</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="status-active" value="active" checked>
                            <label class="form-check-label" for="status-active">Ativado</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="status-blocked" value="blocked">
                            <label class="form-check-label" for="status-blocked">Bloqueado</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Salvar Veículo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Input oculto para importação -->
<input type="file" id="importFile" accept=".csv" style="display: none;">
{% endblock %}

{% block extra_js %}
<script>
let currentVehicleId = null;

// Validação de CPF
function validarCPFInput(input) {
    const cpf = input.value.replace(/[^\d]/g, '');
    if (cpf.length === 11) {
        if (!Validators.validarCPF(cpf)) {
            input.setCustomValidity('CPF inválido');
            input.classList.add('is-invalid');
        } else {
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    } else {
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
    }
}

// Validação de placa
function validarPlacaInput(input) {
    const placa = input.value.toUpperCase();
    if (placa.length >= 7) {
        if (!Validators.validarPlaca(placa)) {
            input.setCustomValidity('Formato de placa inválido');
            input.classList.add('is-invalid');
        } else {
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    } else {
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
    }
}

// Funções de filtros
function toggleAdvancedFilters() {
    const filters = document.getElementById('advancedFilters');
    const button = document.querySelector('.filter-toggle');
    
    if (filters.style.display === 'none') {
        filters.style.display = 'block';
        button.innerHTML = '<i class="fas fa-filter"></i> Ocultar Filtros';
    } else {
        filters.style.display = 'none';
        button.innerHTML = '<i class="fas fa-filter"></i> Filtros Avançados';
    }
}

function clearFilters() {
    window.location.href = '{{ url_for("cadastros.cadastros_veiculos") }}';
}

// Funções de exportação/importação
function exportVehicles() {
    window.location.href = '/api/veiculos/export';
}

function importVehicles() {
    document.getElementById('importFile').click();
}

document.getElementById('importFile').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/veiculos/import', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            FeedbackManager.showSuccess(result.message);
            if (result.errors && result.errors.length > 0) {
                console.warn('Erros durante importação:', result.errors);
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            FeedbackManager.showError(result.error);
        }
    } catch (error) {
        FeedbackManager.showError('Erro ao importar veículos');
    }
    
    // Limpar input
    e.target.value = '';
});

// Função para atualizar tabela
function refreshTable() {
    location.reload();
}

// Função para abrir modal de adicionar veículo
function openAddVehicleModal() {
    currentVehicleId = null;
    document.getElementById('modalTitle').textContent = 'Adicionar Novo Veículo';
    document.getElementById('vehicle-form').reset();
    document.getElementById('tipo-outros-container').style.display = 'none';
    new bootstrap.Modal(document.getElementById('vehicleModal')).show();
}

// Mostrar/ocultar campo "Outros" baseado no tipo selecionado
document.getElementById('tipo').addEventListener('change', function() {
    const outrosContainer = document.getElementById('tipo-outros-container');
    if (this.value === 'Outros') {
        outrosContainer.style.display = 'block';
    } else {
        outrosContainer.style.display = 'none';
    }
});

// Validação de CPF em tempo real
document.getElementById('cpf_motorista').addEventListener('input', function() {
    validarCPFInput(this);
});

// Validação de placa em tempo real
document.getElementById('placa').addEventListener('input', function() {
    validarPlacaInput(this);
});

document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Validar campos antes de enviar
    const cpfInput = document.getElementById('cpf_motorista');
    const placaInput = document.getElementById('placa');
    
    validarCPFInput(cpfInput);
    validarPlacaInput(placaInput);
    
    if (!cpfInput.checkValidity() || !placaInput.checkValidity()) {
        FeedbackManager.showError('Por favor, corrija os erros no formulário');
        return;
    }
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    const url = currentVehicleId ? `/api/veiculos/${currentVehicleId}` : '/api/veiculos';
    const method = currentVehicleId ? 'PUT' : 'POST';
    
    await FormManager.submitForm(e.target, {
        url: url,
        method: method,
        processData: (data) => data,
        successMessage: currentVehicleId ? 'Veículo atualizado com sucesso!' : 'Veículo criado com sucesso!',
        reload: true
    });
});

// Edit vehicle
document.addEventListener('click', async (e) => {
    if (e.target.closest('.edit-vehicle')) {
        const vehicleId = e.target.closest('.edit-vehicle').dataset.vehicleId;
        currentVehicleId = vehicleId;
        
        try {
            const response = await fetch(`/api/veiculos/${vehicleId}`);
            const vehicle = await response.json();
            
            document.getElementById('modalTitle').textContent = 'Editar Veículo';
            document.getElementById('motorista_responsavel').value = vehicle.motorista_responsavel;
            document.getElementById('cpf_motorista').value = vehicle.cpf_motorista;
            document.getElementById('placa').value = vehicle.placa;
            document.getElementById('renavam').value = vehicle.renavam || '';
            document.getElementById('tipo').value = vehicle.tipo;
            document.getElementById('estado').value = vehicle.estado || '';
            document.getElementById('municipio').value = vehicle.municipio || '';
            document.getElementById('observacoes').value = vehicle.observacoes || '';
            
            // Mostrar campo "Outros" se necessário
            if (vehicle.tipo === 'Outros') {
                document.getElementById('tipo-outros-container').style.display = 'block';
                document.getElementById('tipo_outros').value = vehicle.tipo_outros || '';
            } else {
                document.getElementById('tipo-outros-container').style.display = 'none';
            }
            
            // Set status
            document.querySelector(`input[name="status"][value="${vehicle.status}"]`).checked = true;
            
            new bootstrap.Modal(document.getElementById('vehicleModal')).show();
        } catch (error) {
            FeedbackManager.showError('Erro ao carregar dados do veículo');
        }
    }
});

// Delete vehicle
document.addEventListener('click', async (e) => {
    if (e.target.closest('.delete-vehicle')) {
        if (confirm('Tem certeza que deseja excluir este veículo?')) {
            const vehicleId = e.target.closest('.delete-vehicle').dataset.vehicleId;
            
            try {
                const response = await fetch(`/api/veiculos/${vehicleId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    FeedbackManager.showSuccess('Veículo excluído com sucesso!');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    FeedbackManager.showError('Erro ao excluir veículo');
                }
            } catch (error) {
                FeedbackManager.showError('Erro ao excluir veículo');
            }
        }
    }
});

// Toggle status
document.addEventListener('click', async (e) => {
    if (e.target.closest('.toggle-status')) {
        const vehicleId = e.target.closest('.toggle-status').dataset.vehicleId;
        
        try {
            const response = await fetch(`/api/veiculos/${vehicleId}`);
            const vehicle = await response.json();
            const newStatus = vehicle.status === 'active' ? 'blocked' : 'active';
            
            const updateResponse = await fetch(`/api/veiculos/${vehicleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ...vehicle,
                    status: newStatus
                })
            });
            
            if (updateResponse.ok) {
                const statusText = newStatus === 'active' ? 'ativado' : 'bloqueado';
                FeedbackManager.showSuccess(`Veículo ${statusText} com sucesso!`);
                setTimeout(() => location.reload(), 1000);
            } else {
                FeedbackManager.showError('Erro ao alterar status do veículo');
            }
        } catch (error) {
            FeedbackManager.showError('Erro ao alterar status do veículo');
        }
    }
});
</script>
{% endblock %}