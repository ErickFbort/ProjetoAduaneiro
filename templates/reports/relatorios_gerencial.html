{% extends "base.html" %}

{% block title %}Relatórios - Gerencial{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <!-- Header -->
            <div class="page-header">
                <div class="header-content">
                    <i class="fas fa-chart-line"></i>
                    <div class="title-section">
                        <h2 class="page-title">Relatórios Gerenciais</h2>
                        <p class="page-subtitle">Relatórios para gestão e tomada de decisões</p>
                    </div>
                </div>
            </div>

            <!-- Barra de Seleção Rápida -->
            <div class="quick-select-section">
                <div class="quick-select-header">
                    <h5><i class="fas fa-list me-2"></i>Seleção Rápida de Relatórios</h5>
                </div>
                <div class="quick-select-content">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="reportSelect" class="form-label">Selecione o Relatório</label>
                            <select class="form-select" id="reportSelect" onchange="selectReportFromDropdown()">
                                <option value="">Selecione...</option>
                                <!-- Opções serão carregadas dinamicamente dos relatórios configurados -->
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="openSelectedReport()" id="openReportBtn" disabled>
                                <i class="fas fa-eye me-2"></i>Abrir Relatório
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Favoritos -->
            <div id="favorites-section" class="favorites-section" style="display: none;">
                <div class="favorites-header">
                    <h5><i class="fas fa-star text-warning me-2"></i>Relatórios Favoritos</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFavorites()">
                        <i class="fas fa-trash"></i> Limpar Todos
                    </button>
                </div>
                <div id="favorites-container" class="favorites-container">
                    <!-- Favoritos serão carregados dinamicamente -->
                </div>
            </div>

            <!-- Grid de Relatórios -->
            <div class="reports-grid" id="reportsGrid">
                <!-- Relatórios serão carregados dinamicamente dos configurados -->
            </div>
        </div>
    </div>
</main>

<!-- Modal de Relatório -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>
                    <span id="reportTitle">Relatório</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros do Relatório -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label for="dateTo" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    <div class="col-md-3">
                        <label for="filterField" class="form-label">Filtro Adicional</label>
                        <select class="form-select" id="filterField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Tabela de Dados -->
                <div class="table-responsive" id="reportTableContainer" style="display: none;">
                    <table class="table table-striped" id="reportTable">
                        <thead id="reportTableHead">
                            <!-- Cabeçalhos serão preenchidos dinamicamente -->
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Dados serão preenchidos dinamicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div class="text-center py-5" id="loadingState" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Gerando relatório...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ========================================
// FUNÇÕES ESPECÍFICAS DO MÓDULO GERENCIAL
// ========================================

let currentReportType = null;
let reportModal = null;

// Abrir relatório
function openReport(reportType) {
    console.log('Abrindo relatório gerencial:', reportType);
    
    currentReportType = reportType;
    const report = getReportData(reportType);
    
    if (!report) {
        alert('Relatório não encontrado!');
        return;
    }
    
    // Configurar modal
    setupReportModal(report);
    
    // Abrir modal
    if (!reportModal) {
        reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    }
    reportModal.show();
}

// Obter dados do relatório
function getReportData(reportType) {
    // Primeiro, tentar obter do sistema centralizado
    if (window.ALL_REPORTS_DATA && window.ALL_REPORTS_DATA[reportType]) {
        const reportData = window.ALL_REPORTS_DATA[reportType];
        return {
            name: reportData.name,
            description: reportData.description || 'Relatório personalizado',
            fields: reportData.fields,
            icon: reportData.icon,
            color: reportData.color,
            columns: getDefaultColumns(reportType),
            sampleData: getDefaultSampleData(reportType)
        };
    }
    
    // Fallback para dados locais (relatórios nativos do gerencial)
    const reportsData = {
        'dashboard-gerencial': {
            name: 'Dashboard Gerencial',
            description: 'Dashboard com indicadores gerenciais principais',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-tachometer-alt',
            color: 'primary',
            columns: ['Indicador', 'Valor Atual', 'Meta', 'Status'],
            sampleData: [
                ['Produtividade', '95%', '100%', 'Abaixo da Meta'],
                ['Eficiência', '88%', '90%', 'Abaixo da Meta'],
                ['Satisfação', '92%', '95%', 'Abaixo da Meta']
            ]
        },
        'indicadores-kpi': {
            name: 'Indicadores KPI',
            description: 'Relatório de indicadores-chave de performance',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-chart-bar',
            color: 'info',
            columns: ['KPI', 'Valor', 'Tendência', 'Status'],
            sampleData: [
                ['Tempo Médio Operação', '45 min', '↗', 'Atenção'],
                ['Taxa de Ocupação', '78%', '↗', 'Bom'],
                ['Satisfação Cliente', '4.2/5', '↗', 'Excelente']
            ]
        },
        'performance-equipe': {
            name: 'Performance da Equipe',
            description: 'Relatório de performance individual e da equipe',
            fields: '001*,002*,003,006,008,018',
            icon: 'fa-users',
            color: 'success',
            columns: ['Funcionário', 'Performance', 'Meta', 'Status'],
            sampleData: [
                ['João Silva', '95%', '100%', 'Abaixo da Meta'],
                ['Maria Santos', '105%', '100%', 'Acima da Meta'],
                ['Pedro Costa', '98%', '100%', 'Abaixo da Meta']
            ]
        },
        'analise-tendencias': {
            name: 'Análise de Tendências',
            description: 'Análise de tendências e projeções',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-chart-line',
            color: 'warning',
            columns: ['Período', 'Tendência', 'Projeção', 'Confiança'],
            sampleData: [
                ['Q1 2024', 'Crescimento', '+15%', '85%'],
                ['Q2 2024', 'Estabilidade', '+5%', '70%'],
                ['Q3 2024', 'Crescimento', '+20%', '90%']
            ]
        },
        'relatorio-executivo': {
            name: 'Relatório Executivo',
            description: 'Relatório executivo consolidado',
            fields: '001*,002*,003,006,007,008,009,018',
            icon: 'fa-file-alt',
            color: 'primary',
            columns: ['Métrica', 'Valor', 'Comparação', 'Status'],
            sampleData: [
                ['Receita Total', 'R$ 1.250.000', '+12% vs mês anterior', 'Positivo'],
                ['Custos Operacionais', 'R$ 850.000', '+8% vs mês anterior', 'Atenção'],
                ['Margem de Lucro', '32%', '+4% vs mês anterior', 'Positivo']
            ]
        }
    };
    
    return reportsData[reportType];
}

// Funções utilitárias movidas para reports-utils.js

// Configurar modal do relatório
function setupReportModal(report) {
    document.getElementById('reportTitle').textContent = report.name;
    
    // Limpar tabela
    document.getElementById('reportTableHead').innerHTML = '';
    document.getElementById('reportTableBody').innerHTML = '';
    document.getElementById('reportTableContainer').style.display = 'none';
}

// Gerar relatório
function generateReport() {
    const report = getReportData(currentReportType);
    if (!report) return;
    
    // Mostrar loading
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('reportTableContainer').style.display = 'none';
    
    // Simular geração do relatório
    setTimeout(() => {
        // Criar cabeçalho da tabela
        const thead = document.getElementById('reportTableHead');
        const headerRow = document.createElement('tr');
        report.columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        // Criar dados da tabela
        const tbody = document.getElementById('reportTableBody');
        report.sampleData.forEach(rowData => {
            const row = document.createElement('tr');
            rowData.forEach(cellData => {
                const td = document.createElement('td');
                td.textContent = cellData;
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        
        // Mostrar tabela
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportTableContainer').style.display = 'block';
    }, 1500);
}

// Exportar relatório
function exportReport(reportType) {
    console.log('Exportando relatório gerencial:', reportType);
    alert('Funcionalidade de exportação será implementada em breve!');
}

// ========================================
// SISTEMA DE FAVORITOS
// ========================================

// Carregar favoritos
function loadFavorites() {
    const saved = localStorage.getItem('gerencialFavorites');
    return saved ? JSON.parse(saved) : [];
}

// Salvar favoritos
function saveFavorites(favorites) {
    localStorage.setItem('gerencialFavorites', JSON.stringify(favorites));
}

// Toggle favorito
function toggleFavorite(reportType) {
    const favorites = loadFavorites();
    const index = favorites.indexOf(reportType);
    
    if (index > -1) {
        favorites.splice(index, 1);
        updateFavoriteButton(reportType, false);
    } else {
        favorites.push(reportType);
        updateFavoriteButton(reportType, true);
    }
    
    saveFavorites(favorites);
    updateFavoritesSection();
}

// Atualizar botão de favorito
function updateFavoriteButton(reportType, isFavorite) {
    const card = document.querySelector(`[data-report="${reportType}"]`);
    if (!card) return;
    
    const btn = card.querySelector('.btn-favorite');
    const icon = btn.querySelector('i');
    
    if (isFavorite) {
        icon.className = 'fas fa-star';
        btn.title = 'Remover dos favoritos';
    } else {
        icon.className = 'far fa-star';
        btn.title = 'Adicionar aos favoritos';
    }
}

// Atualizar seção de favoritos
function updateFavoritesSection() {
    const favorites = loadFavorites();
    const section = document.getElementById('favorites-section');
    const container = document.getElementById('favorites-container');
    
    if (favorites.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    container.innerHTML = '';
    
    favorites.forEach(reportType => {
        const report = getReportData(reportType);
        if (report) {
            const card = createFavoriteCard(reportType, report);
            container.appendChild(card);
        }
    });
}

// Criar card de favorito
function createFavoriteCard(reportType, report) {
    const card = document.createElement('div');
    card.className = 'favorite-card';
    card.innerHTML = `
        <div class="favorite-content">
            <div class="favorite-icon">
                <i class="fas ${report.icon}"></i>
            </div>
            <div class="favorite-info">
                <h6>${report.name}</h6>
                <p>${report.description}</p>
            </div>
        </div>
        <div class="favorite-actions">
            <button class="btn btn-sm btn-primary" onclick="openReport('${reportType}')" title="Abrir relatório">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="toggleFavorite('${reportType}')" title="Remover dos favoritos">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    return card;
}

// Limpar todos os favoritos
function clearAllFavorites() {
    if (confirm('Tem certeza que deseja remover todos os favoritos?')) {
        saveFavorites([]);
        updateFavoritesSection();
        
        // Atualizar todos os botões de favorito
        document.querySelectorAll('.btn-favorite').forEach(btn => {
            const icon = btn.querySelector('i');
            icon.className = 'far fa-star';
            icon.parentElement.title = 'Adicionar aos favoritos';
        });
    }
}

// ========================================
// SISTEMA DE SELEÇÃO RÁPIDA
// ========================================

// Selecionar relatório do dropdown
function selectReportFromDropdown() {
    const select = document.getElementById('reportSelect');
    const openBtn = document.getElementById('openReportBtn');
    
    if (select.value) {
        openBtn.disabled = false;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    } else {
        openBtn.disabled = true;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    }
}

// Abrir relatório selecionado
function openSelectedReport() {
    const select = document.getElementById('reportSelect');
    const reportType = select.value;
    
    if (reportType) {
        openReport(reportType);
        // Scroll para o card do relatório
        const reportCard = document.querySelector(`[data-report="${reportType}"]`);
        if (reportCard) {
            reportCard.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Destacar o card temporariamente
            reportCard.style.border = '2px solid #007bff';
            reportCard.style.boxShadow = '0 0 15px rgba(0, 123, 255, 0.3)';
            
            setTimeout(() => {
                reportCard.style.border = '';
                reportCard.style.boxShadow = '';
            }, 2000);
        }
    }
}

// Inicializar página
document.addEventListener('DOMContentLoaded', function() {
    // O sistema de sincronização automática já carrega os relatórios
    // Apenas inicializar funcionalidades específicas do módulo
    
    // Carregar favoritos
    const favorites = loadFavorites();
    
    // Atualizar botões de favorito
    favorites.forEach(reportType => {
        updateFavoriteButton(reportType, true);
    });
    
    // Atualizar seção de favoritos
    updateFavoritesSection();
    
    // Inicializar dropdown
    selectReportFromDropdown();
});
</script>

<!-- Estilos movidos para reports.css -->

{% endblock %}

