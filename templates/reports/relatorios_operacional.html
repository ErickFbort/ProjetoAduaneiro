{% extends "base.html" %}

{% block title %}Relatórios - Operacional{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <!-- Header -->
            <div class="page-header">
                <div class="header-content">
                    <i class="fas fa-cogs"></i>
                    <div class="title-section">
                        <h2 class="page-title">Relatórios Operacionais</h2>
                        <p class="page-subtitle">Relatórios relacionados às operações do terminal</p>
                    </div>
                </div>
            </div>

            <!-- Barra de Seleção Rápida -->
            <div class="quick-select-section">
                <div class="quick-select-header">
                    <h5><i class="fas fa-list me-2"></i>Seleção Rápida de Relatórios</h5>
                </div>
                <div class="quick-select-content">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="reportSelect" class="form-label">Selecione o Relatório</label>
                            <select class="form-select" id="reportSelect" onchange="selectReportFromDropdown()">
                                <option value="">Selecione...</option>
                                <!-- Opções serão carregadas dinamicamente dos relatórios configurados -->
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="openSelectedReport()" id="openReportBtn" disabled>
                                <i class="fas fa-eye me-2"></i>Abrir Relatório
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Favoritos -->
            <div id="favorites-section" class="favorites-section" style="display: none;">
                <div class="favorites-header">
                    <h5><i class="fas fa-star text-warning me-2"></i>Relatórios Favoritos</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFavorites()">
                        <i class="fas fa-trash"></i> Limpar Todos
                    </button>
                </div>
                <div id="favorites-container" class="favorites-container">
                    <!-- Favoritos serão carregados dinamicamente -->
                </div>
            </div>

            <!-- Grid de Relatórios -->
            <div class="reports-grid" id="reportsGrid">
                <!-- Relatórios serão carregados dinamicamente dos configurados -->
            </div>
        </div>
    </div>
</main>

<!-- Modal de Relatório -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>
                    <span id="reportTitle">Relatório</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros do Relatório -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label for="dateTo" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    <div class="col-md-3">
                        <label for="filterField" class="form-label">Filtro Adicional</label>
                        <select class="form-select" id="filterField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Tabela de Dados -->
                <div class="table-responsive" id="reportTableContainer" style="display: none;">
                    <table class="table table-striped" id="reportTable">
                        <thead id="reportTableHead">
                            <!-- Cabeçalhos serão preenchidos dinamicamente -->
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Dados serão preenchidos dinamicamente -->
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
// ========================================
// FUNÇÕES ESPECÍFICAS DO MÓDULO OPERACIONAL
// ========================================

let currentReportType = null;
let reportModal = null;

// Abrir relatório
function openReport(reportType) {
    console.log('Abrindo relatório operacional:', reportType);
    
    currentReportType = reportType;
    const report = getReportData(reportType);
    
    if (!report) {
        alert('Relatório não encontrado!');
        return;
    }
    
    // Configurar modal
    setupReportModal(report);
    
    // Abrir modal
    if (!reportModal) {
        reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    }
    reportModal.show();
}

// Obter dados do relatório
function getReportData(reportType) {
    // Primeiro, tentar obter do sistema centralizado
    if (window.ALL_REPORTS_DATA && window.ALL_REPORTS_DATA[reportType]) {
        const reportData = window.ALL_REPORTS_DATA[reportType];
        return {
            name: reportData.name,
            description: reportData.description || 'Relatório personalizado',
            fields: reportData.fields,
            icon: reportData.icon,
            color: reportData.color,
            columns: getDefaultColumns(reportType),
            sampleData: getDefaultSampleData(reportType)
        };
    }
    
    // Fallback para dados locais (relatórios nativos do operacional)
    const reportsData = {
        'operacoes-dia': {
            name: 'Operações do Dia',
            description: 'Relatório de operações realizadas no dia',
            fields: '001*,002*,003,018',
            icon: 'fa-calendar-day',
            color: 'primary',
            columns: ['ID', 'Operação', 'Hora', 'Status', 'Responsável'],
            sampleData: [
                ['001', 'Descarga Caminhão', '08:30', 'Concluída', 'João Silva'],
                ['002', 'Carregamento', '10:15', 'Em Andamento', 'Maria Santos'],
                ['003', 'Vistoria', '14:20', 'Pendente', 'Pedro Costa']
            ]
        },
        'movimentacao-cargas': {
            name: 'Movimentação de Cargas',
            description: 'Relatório de movimentação de cargas no terminal',
            fields: '001*,002*,003*,006,008,009,018',
            icon: 'fa-truck-loading',
            color: 'info',
            columns: ['ID', 'Carga', 'Origem', 'Destino', 'Status'],
            sampleData: [
                ['001', 'C-2024-001', 'Portão A', 'Área 1', 'Movimentada'],
                ['002', 'C-2024-002', 'Área 2', 'Portão B', 'Em Movimento'],
                ['003', 'C-2024-003', 'Área 3', 'Área 1', 'Pendente']
            ]
        },
        'status-operacoes': {
            name: 'Status das Operações',
            description: 'Relatório de status atual das operações',
            fields: '001*,002*,003*,018',
            icon: 'fa-tasks',
            color: 'warning',
            columns: ['Operação', 'Status', 'Progresso', 'Próxima Ação'],
            sampleData: [
                ['Descarga', 'Em Andamento', '75%', 'Finalizar descarga'],
                ['Carregamento', 'Aguardando', '0%', 'Aguardar liberação'],
                ['Vistoria', 'Concluída', '100%', 'Arquivar documentos']
            ]
        },
        'tempo-operacao': {
            name: 'Tempo de Operação',
            description: 'Relatório de tempo médio de operações',
            fields: '001*,002*,003,006,008,018',
            icon: 'fa-clock',
            color: 'success',
            columns: ['Operação', 'Tempo Médio', 'Tempo Mínimo', 'Tempo Máximo'],
            sampleData: [
                ['Descarga', '45 min', '30 min', '60 min'],
                ['Carregamento', '35 min', '25 min', '50 min'],
                ['Vistoria', '20 min', '15 min', '30 min']
            ]
        },
        'produtividade': {
            name: 'Produtividade',
            description: 'Relatório de produtividade da equipe',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-chart-line',
            color: 'success',
            columns: ['Funcionário', 'Operações', 'Eficiência', 'Meta'],
            sampleData: [
                ['João Silva', '25', '95%', '100%'],
                ['Maria Santos', '22', '88%', '100%'],
                ['Pedro Costa', '28', '112%', '100%']
            ]
        }
    };
    
    return reportsData[reportType];
}

// Funções utilitárias movidas para reports-utils.js

// Configurar modal do relatório
function setupReportModal(report) {
    document.getElementById('reportTitle').textContent = report.name;
    
    // Limpar tabela
    document.getElementById('reportTableHead').innerHTML = '';
    document.getElementById('reportTableBody').innerHTML = '';
    document.getElementById('reportTableContainer').style.display = 'none';
}

// Gerar relatório
function generateReport() {
    const report = getReportData(currentReportType);
    if (!report) return;
    
    // Mostrar tabela diretamente
    document.getElementById('reportTableContainer').style.display = 'block';
    
    // Simular geração do relatório
    setTimeout(() => {
        // Criar cabeçalho da tabela
        const thead = document.getElementById('reportTableHead');
        const headerRow = document.createElement('tr');
        report.columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        // Criar dados da tabela
        const tbody = document.getElementById('reportTableBody');
        report.sampleData.forEach(rowData => {
            const row = document.createElement('tr');
            rowData.forEach(cellData => {
                const td = document.createElement('td');
                td.textContent = cellData;
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        
        // Mostrar tabela
        document.getElementById('reportTableContainer').style.display = 'block';
    }, 1500);
}

// Exportar relatório
function exportReport(reportType) {
    console.log('Exportando relatório operacional:', reportType);
    alert('Funcionalidade de exportação será implementada em breve!');
}

// ========================================
// SISTEMA DE FAVORITOS
// ========================================

// Carregar favoritos
function loadFavorites() {
    const saved = localStorage.getItem('operacionalFavorites');
    return saved ? JSON.parse(saved) : [];
}

// Salvar favoritos
function saveFavorites(favorites) {
    localStorage.setItem('operacionalFavorites', JSON.stringify(favorites));
}

// Toggle favorito
function toggleFavorite(reportType) {
    const favorites = loadFavorites();
    const index = favorites.indexOf(reportType);
    
    if (index > -1) {
        favorites.splice(index, 1);
        updateFavoriteButton(reportType, false);
    } else {
        favorites.push(reportType);
        updateFavoriteButton(reportType, true);
    }
    
    saveFavorites(favorites);
    updateFavoritesSection();
}

// Atualizar botão de favorito
function updateFavoriteButton(reportType, isFavorite) {
    const card = document.querySelector(`[data-report="${reportType}"]`);
    if (!card) return;
    
    const btn = card.querySelector('.btn-favorite');
    const icon = btn.querySelector('i');
    
    if (isFavorite) {
        icon.className = 'fas fa-star';
        btn.title = 'Remover dos favoritos';
    } else {
        icon.className = 'far fa-star';
        btn.title = 'Adicionar aos favoritos';
    }
}

// Atualizar seção de favoritos
function updateFavoritesSection() {
    const favorites = loadFavorites();
    const section = document.getElementById('favorites-section');
    const container = document.getElementById('favorites-container');
    
    if (favorites.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    container.innerHTML = '';
    
    favorites.forEach(reportType => {
        const report = getReportData(reportType);
        if (report) {
            const card = createFavoriteCard(reportType, report);
            container.appendChild(card);
        }
    });
}

// Criar card de favorito
function createFavoriteCard(reportType, report) {
    const card = document.createElement('div');
    card.className = 'favorite-card';
    card.innerHTML = `
        <div class="favorite-content">
            <div class="favorite-icon">
                <i class="fas ${report.icon}"></i>
            </div>
            <div class="favorite-info">
                <h6>${report.name}</h6>
                <p>${report.description}</p>
            </div>
        </div>
        <div class="favorite-actions">
            <button class="btn btn-sm btn-primary" onclick="openReport('${reportType}')" title="Abrir relatório">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="toggleFavorite('${reportType}')" title="Remover dos favoritos">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    return card;
}

// Limpar todos os favoritos
function clearAllFavorites() {
    if (confirm('Tem certeza que deseja remover todos os favoritos?')) {
        saveFavorites([]);
        updateFavoritesSection();
        
        // Atualizar todos os botões de favorito
        document.querySelectorAll('.btn-favorite').forEach(btn => {
            const icon = btn.querySelector('i');
            icon.className = 'far fa-star';
            icon.parentElement.title = 'Adicionar aos favoritos';
        });
    }
}

// ========================================
// SISTEMA DE SELEÇÃO RÁPIDA
// ========================================

// Selecionar relatório do dropdown
function selectReportFromDropdown() {
    const select = document.getElementById('reportSelect');
    const openBtn = document.getElementById('openReportBtn');
    
    if (select.value) {
        openBtn.disabled = false;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    } else {
        openBtn.disabled = true;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    }
}

// Abrir relatório selecionado
function openSelectedReport() {
    const select = document.getElementById('reportSelect');
    const reportType = select.value;
    
    if (reportType) {
        openReport(reportType);
        // Scroll para o card do relatório
        const reportCard = document.querySelector(`[data-report="${reportType}"]`);
        if (reportCard) {
            reportCard.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Destacar o card temporariamente
            reportCard.style.border = '2px solid #007bff';
            reportCard.style.boxShadow = '0 0 15px rgba(0, 123, 255, 0.3)';
            
            setTimeout(() => {
                reportCard.style.border = '';
                reportCard.style.boxShadow = '';
            }, 2000);
        }
    }
}

// Inicializar página
document.addEventListener('DOMContentLoaded', function() {
    // O sistema de sincronização automática já carrega os relatórios
    // Apenas inicializar funcionalidades específicas do módulo
    
    // Carregar favoritos
    const favorites = loadFavorites();
    
    // Atualizar botões de favorito
    favorites.forEach(reportType => {
        updateFavoriteButton(reportType, true);
    });
    
    // Atualizar seção de favoritos
    updateFavoritesSection();
    
    // Inicializar dropdown
    selectReportFromDropdown();
});
</script>

<!-- Estilos movidos para reports.css -->

{% endblock %}
