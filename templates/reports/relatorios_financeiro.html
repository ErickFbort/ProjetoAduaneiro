{% extends "base.html" %}

{% block title %}Relatórios - Financeiro{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <!-- Header -->
            <div class="page-header">
                <div class="header-content">
                    <i class="fas fa-dollar-sign"></i>
                    <div class="title-section">
                        <h2 class="page-title">Relatórios Financeiros</h2>
                        <p class="page-subtitle">Relatórios relacionados às finanças e contabilidade</p>
                    </div>
                </div>
            </div>

            <!-- Barra de Seleção Rápida -->
            <div class="quick-select-section">
                <div class="quick-select-header">
                    <h5><i class="fas fa-list me-2"></i>Seleção Rápida de Relatórios</h5>
                </div>
                <div class="quick-select-content">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="reportSelect" class="form-label">Selecione o Relatório</label>
                            <select class="form-select" id="reportSelect" onchange="selectReportFromDropdown()">
                                <option value="">Selecione...</option>
                                <!-- Opções serão carregadas dinamicamente dos relatórios configurados -->
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="openSelectedReport()" id="openReportBtn" disabled>
                                <i class="fas fa-eye me-2"></i>Abrir Relatório
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Favoritos -->
            <div id="favorites-section" class="favorites-section" style="display: none;">
                <div class="favorites-header">
                    <h5><i class="fas fa-star text-warning me-2"></i>Relatórios Favoritos</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFavorites()">
                        <i class="fas fa-trash"></i> Limpar Todos
                    </button>
                </div>
                <div id="favorites-container" class="favorites-container">
                    <!-- Favoritos serão carregados dinamicamente -->
                </div>
            </div>

            <!-- Grid de Relatórios -->
            <div class="reports-grid" id="reportsGrid">
                <!-- Relatórios serão carregados dinamicamente dos configurados -->
            </div>
        </div>
    </div>
</main>

<!-- Modal de Relatório -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>
                    <span id="reportTitle">Relatório</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros do Relatório -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label for="dateTo" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    <div class="col-md-3">
                        <label for="filterField" class="form-label">Filtro Adicional</label>
                        <select class="form-select" id="filterField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Tabela de Dados -->
                <div class="table-responsive" id="reportTableContainer" style="display: none;">
                    <table class="table table-striped" id="reportTable">
                        <thead id="reportTableHead">
                            <!-- Cabeçalhos serão preenchidos dinamicamente -->
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Dados serão preenchidos dinamicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div class="text-center py-5" id="loadingState" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Gerando relatório...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ========================================
// FUNÇÕES ESPECÍFICAS DO MÓDULO FINANCEIRO
// ========================================

let currentReportType = null;
let reportModal = null;

// Abrir relatório
function openReport(reportType) {
    console.log('Abrindo relatório financeiro:', reportType);
    
    currentReportType = reportType;
    const report = getReportData(reportType);
    
    if (!report) {
        alert('Relatório não encontrado!');
        return;
    }
    
    // Configurar modal
    setupReportModal(report);
    
    // Abrir modal
    if (!reportModal) {
        reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    }
    reportModal.show();
}

// Obter dados do relatório
function getReportData(reportType) {
    // Primeiro, tentar obter do sistema centralizado
    if (window.ALL_REPORTS_DATA && window.ALL_REPORTS_DATA[reportType]) {
        const reportData = window.ALL_REPORTS_DATA[reportType];
        return {
            name: reportData.name,
            description: reportData.description || 'Relatório personalizado',
            fields: reportData.fields,
            icon: reportData.icon,
            color: reportData.color,
            columns: getDefaultColumns(reportType),
            sampleData: getDefaultSampleData(reportType)
        };
    }
    
    // Fallback para dados locais (relatórios nativos do financeiro)
    const reportsData = {
        'fluxo-caixa': {
            name: 'Fluxo de Caixa',
            description: 'Relatório de fluxo de caixa mensal',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-money-bill-wave',
            color: 'success',
            columns: ['Período', 'Entradas', 'Saídas', 'Saldo'],
            sampleData: [
                ['Janeiro 2024', 'R$ 1.250.000', 'R$ 850.000', 'R$ 400.000'],
                ['Fevereiro 2024', 'R$ 1.180.000', 'R$ 920.000', 'R$ 260.000'],
                ['Março 2024', 'R$ 1.350.000', 'R$ 780.000', 'R$ 570.000']
            ]
        },
        'receitas-despesas': {
            name: 'Receitas e Despesas',
            description: 'Relatório de receitas e despesas por categoria',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-chart-pie',
            color: 'info',
            columns: ['Categoria', 'Receitas', 'Despesas', 'Saldo'],
            sampleData: [
                ['Operacional', 'R$ 1.200.000', 'R$ 800.000', 'R$ 400.000'],
                ['Administrativo', 'R$ 0', 'R$ 150.000', 'R$ -150.000'],
                ['Financeiro', 'R$ 50.000', 'R$ 20.000', 'R$ 30.000']
            ]
        },
        'contas-pagar': {
            name: 'Contas a Pagar',
            description: 'Relatório de contas a pagar',
            fields: '001*,002*,003,006,008,018',
            icon: 'fa-credit-card',
            color: 'warning',
            columns: ['Fornecedor', 'Valor', 'Vencimento', 'Status'],
            sampleData: [
                ['Fornecedor A', 'R$ 25.000', '15/02/2024', 'Pendente'],
                ['Fornecedor B', 'R$ 18.500', '20/02/2024', 'Pago'],
                ['Fornecedor C', 'R$ 32.000', '25/02/2024', 'Pendente']
            ]
        },
        'contas-receber': {
            name: 'Contas a Receber',
            description: 'Relatório de contas a receber',
            fields: '001*,002*,003,006,008,018',
            icon: 'fa-hand-holding-usd',
            color: 'primary',
            columns: ['Cliente', 'Valor', 'Vencimento', 'Status'],
            sampleData: [
                ['Cliente A', 'R$ 45.000', '10/02/2024', 'Recebido'],
                ['Cliente B', 'R$ 38.000', '15/02/2024', 'Pendente'],
                ['Cliente C', 'R$ 52.000', '20/02/2024', 'Pendente']
            ]
        },
        'balanco-mensal': {
            name: 'Balanço Mensal',
            description: 'Relatório de balanço mensal consolidado',
            fields: '001*,002*,003,006,007,008,018',
            icon: 'fa-balance-scale',
            color: 'success',
            columns: ['Conta', 'Saldo Anterior', 'Movimentação', 'Saldo Atual'],
            sampleData: [
                ['Caixa', 'R$ 100.000', '+R$ 50.000', 'R$ 150.000'],
                ['Bancos', 'R$ 500.000', '-R$ 30.000', 'R$ 470.000'],
                ['Estoque', 'R$ 200.000', '+R$ 25.000', 'R$ 225.000']
            ]
        }
    };
    
    return reportsData[reportType];
}

// Funções utilitárias movidas para reports-utils.js

// Configurar modal do relatório
function setupReportModal(report) {
    document.getElementById('reportTitle').textContent = report.name;
    
    // Limpar tabela
    document.getElementById('reportTableHead').innerHTML = '';
    document.getElementById('reportTableBody').innerHTML = '';
    document.getElementById('reportTableContainer').style.display = 'none';
}

// Gerar relatório
function generateReport() {
    const report = getReportData(currentReportType);
    if (!report) return;
    
    // Mostrar loading
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('reportTableContainer').style.display = 'none';
    
    // Simular geração do relatório
    setTimeout(() => {
        // Criar cabeçalho da tabela
        const thead = document.getElementById('reportTableHead');
        const headerRow = document.createElement('tr');
        report.columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        // Criar dados da tabela
        const tbody = document.getElementById('reportTableBody');
        report.sampleData.forEach(rowData => {
            const row = document.createElement('tr');
            rowData.forEach(cellData => {
                const td = document.createElement('td');
                td.textContent = cellData;
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        
        // Mostrar tabela
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportTableContainer').style.display = 'block';
    }, 1500);
}

// Exportar relatório
function exportReport(reportType) {
    console.log('Exportando relatório financeiro:', reportType);
    alert('Funcionalidade de exportação será implementada em breve!');
}

// ========================================
// SISTEMA DE FAVORITOS
// ========================================

// Carregar favoritos
function loadFavorites() {
    const saved = localStorage.getItem('financeiroFavorites');
    return saved ? JSON.parse(saved) : [];
}

// Salvar favoritos
function saveFavorites(favorites) {
    localStorage.setItem('financeiroFavorites', JSON.stringify(favorites));
}

// Toggle favorito
function toggleFavorite(reportType) {
    const favorites = loadFavorites();
    const index = favorites.indexOf(reportType);
    
    if (index > -1) {
        favorites.splice(index, 1);
        updateFavoriteButton(reportType, false);
    } else {
        favorites.push(reportType);
        updateFavoriteButton(reportType, true);
    }
    
    saveFavorites(favorites);
    updateFavoritesSection();
}

// Atualizar botão de favorito
function updateFavoriteButton(reportType, isFavorite) {
    const card = document.querySelector(`[data-report="${reportType}"]`);
    if (!card) return;
    
    const btn = card.querySelector('.btn-favorite');
    const icon = btn.querySelector('i');
    
    if (isFavorite) {
        icon.className = 'fas fa-star';
        btn.title = 'Remover dos favoritos';
    } else {
        icon.className = 'far fa-star';
        btn.title = 'Adicionar aos favoritos';
    }
}

// Atualizar seção de favoritos
function updateFavoritesSection() {
    const favorites = loadFavorites();
    const section = document.getElementById('favorites-section');
    const container = document.getElementById('favorites-container');
    
    if (favorites.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    container.innerHTML = '';
    
    favorites.forEach(reportType => {
        const report = getReportData(reportType);
        if (report) {
            const card = createFavoriteCard(reportType, report);
            container.appendChild(card);
        }
    });
}

// Criar card de favorito
function createFavoriteCard(reportType, report) {
    const card = document.createElement('div');
    card.className = 'favorite-card';
    card.innerHTML = `
        <div class="favorite-content">
            <div class="favorite-icon">
                <i class="fas ${report.icon}"></i>
            </div>
            <div class="favorite-info">
                <h6>${report.name}</h6>
                <p>${report.description}</p>
            </div>
        </div>
        <div class="favorite-actions">
            <button class="btn btn-sm btn-primary" onclick="openReport('${reportType}')" title="Abrir relatório">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="toggleFavorite('${reportType}')" title="Remover dos favoritos">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    return card;
}

// Limpar todos os favoritos
function clearAllFavorites() {
    if (confirm('Tem certeza que deseja remover todos os favoritos?')) {
        saveFavorites([]);
        updateFavoritesSection();
        
        // Atualizar todos os botões de favorito
        document.querySelectorAll('.btn-favorite').forEach(btn => {
            const icon = btn.querySelector('i');
            icon.className = 'far fa-star';
            icon.parentElement.title = 'Adicionar aos favoritos';
        });
    }
}

// ========================================
// SISTEMA DE SELEÇÃO RÁPIDA
// ========================================

// Selecionar relatório do dropdown
function selectReportFromDropdown() {
    const select = document.getElementById('reportSelect');
    const openBtn = document.getElementById('openReportBtn');
    
    if (select.value) {
        openBtn.disabled = false;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    } else {
        openBtn.disabled = true;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    }
}

// Abrir relatório selecionado
function openSelectedReport() {
    const select = document.getElementById('reportSelect');
    const reportType = select.value;
    
    if (reportType) {
        openReport(reportType);
        // Scroll para o card do relatório
        const reportCard = document.querySelector(`[data-report="${reportType}"]`);
        if (reportCard) {
            reportCard.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Destacar o card temporariamente
            reportCard.style.border = '2px solid #007bff';
            reportCard.style.boxShadow = '0 0 15px rgba(0, 123, 255, 0.3)';
            
            setTimeout(() => {
                reportCard.style.border = '';
                reportCard.style.boxShadow = '';
            }, 2000);
        }
    }
}

// Inicializar página
document.addEventListener('DOMContentLoaded', function() {
    // O sistema de sincronização automática já carrega os relatórios
    // Apenas inicializar funcionalidades específicas do módulo
    
    // Carregar favoritos
    const favorites = loadFavorites();
    
    // Atualizar botões de favorito
    favorites.forEach(reportType => {
        updateFavoriteButton(reportType, true);
    });
    
    // Atualizar seção de favoritos
    updateFavoritesSection();
    
    // Inicializar dropdown
    selectReportFromDropdown();
});
</script>

<!-- Estilos movidos para reports.css -->

{% endblock %}

