{% extends "base.html" %}

{% block title %}Relatórios - Comercial{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
{% include 'partials/sidebar.html' %}

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <!-- Header -->
            <div class="page-header">
                <div class="header-content">
                    <i class="fas fa-file-alt"></i>
                    <div class="title-section">
                        <h2 class="page-title">Relatórios Comerciais</h2>
                        <p class="page-subtitle">Relatórios relacionados às atividades comerciais</p>
                    </div>
                </div>
            </div>

            <!-- Barra de Seleção Rápida -->
            <div class="quick-select-section">
                <div class="quick-select-header">
                    <h5><i class="fas fa-list me-2"></i>Seleção Rápida de Relatórios</h5>
                </div>
                <div class="quick-select-content">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="reportSelect" class="form-label">Selecione o Relatório</label>
                            <select class="form-select" id="reportSelect" onchange="selectReportFromDropdown()">
                                <option value="">Selecione...</option>
                                <option value="cargas-armazenadas-60">Cargas Armazenadas +60 Dias</option>
                                <option value="cargas-consignatario">Cargas Armazenadas por Consignatário</option>
                                <option value="cargas-isencao">Cargas com Isenção</option>
                                <option value="cargas-entregues">Cargas Entregues</option>
                                <option value="cargas-entregues-processo">Cargas Entregues (Processo)</option>
                                <option value="cargas-entregues-dta">Cargas Entregues DTA</option>
                                <option value="clientes-correntistas">Clientes Correntistas</option>
                                <option value="custodia">Custódia</option>
                                <option value="dapes-sem-carga">DAPES Sem Carga em Aberto</option>
                                <option value="demonstrativo-cargas">Demonstrativo Cargas Analítico</option>
                                <option value="descontos">Descontos</option>
                                <option value="exportacoes">Exportações</option>
                                <option value="perfil-cliente">Perfil de Cliente</option>
                                <option value="servicos-faturamento">Serviços x Faturamento</option>
                                <option value="vistorias">Vistorias</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="openSelectedReport()" id="openReportBtn" disabled>
                                <i class="fas fa-eye me-2"></i>Abrir Relatório
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Favoritos -->
            <div id="favorites-section" class="favorites-section" style="display: none;">
                <div class="favorites-header">
                    <h5><i class="fas fa-star text-warning me-2"></i>Relatórios Favoritos</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFavorites()">
                        <i class="fas fa-trash"></i> Limpar Todos
                    </button>
                </div>
                <div id="favorites-container" class="favorites-container">
                    <!-- Favoritos serão inseridos aqui dinamicamente -->
                </div>
            </div>

            <!-- Cards de Relatórios Comerciais -->
            <div class="reports-grid">
                <!-- Cargas Armazenadas +60 Dias -->
                <div class="report-card" data-report="cargas-armazenadas-60">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('cargas-armazenadas-60')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Cargas Armazenadas +60 Dias</h4>
                        <p>Relatório de cargas armazenadas há mais de 60 dias</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-clock text-warning"></i>
                                Campos: 003*,006,008,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('cargas-armazenadas-60')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('cargas-armazenadas-60')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Cargas Armazenadas por Consignatário -->
                <div class="report-card" data-report="cargas-consignatario">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('cargas-consignatario')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Cargas Armazenadas por Consignatário</h4>
                        <p>Análise de cargas por consignatário</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-chart-bar text-info"></i>
                                Campos: 003*,006,008,009
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('cargas-consignatario')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('cargas-consignatario')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Cargas com Isenção -->
                <div class="report-card" data-report="cargas-isencao">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('cargas-isencao')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Cargas com Isenção</h4>
                        <p>Relatório de cargas com isenção fiscal</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-percentage text-success"></i>
                                Campos: 001*,002,003*,018,006,008
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('cargas-isencao')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('cargas-isencao')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Cargas Entregues -->
                <div class="report-card" data-report="cargas-entregues">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('cargas-entregues')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Cargas Entregues</h4>
                        <p>Relatório de cargas entregues aos clientes</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-check-circle text-success"></i>
                                Campos: 001*,002*,003*,004,006,008,009,014,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('cargas-entregues')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('cargas-entregues')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Cargas Entregues (Processo) -->
                <div class="report-card" data-report="cargas-entregues-processo">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('cargas-entregues-processo')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Cargas Entregues (Processo)</h4>
                        <p>Relatório de cargas entregues por processo</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-tasks text-primary"></i>
                                Campos: 001*,002*,003*,004,006,008,009,014,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('cargas-entregues-processo')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('cargas-entregues-processo')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Cargas Entregues DTA -->
                <div class="report-card" data-report="cargas-entregues-dta">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('cargas-entregues-dta')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Cargas Entregues DTA</h4>
                        <p>Relatório de cargas entregues com DTA</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-file-signature text-info"></i>
                                Campos: 001*,002*,003,004,006,008,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('cargas-entregues-dta')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('cargas-entregues-dta')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Clientes Correntistas -->
                <div class="report-card" data-report="clientes-correntistas">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('clientes-correntistas')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Clientes Correntistas</h4>
                        <p>Relatório de clientes correntistas</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-users text-primary"></i>
                                Campos: 001*,002*,003,006,008,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('clientes-correntistas')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('clientes-correntistas')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Custódia -->
                <div class="report-card" data-report="custodia">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('custodia')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Custódia</h4>
                        <p>Relatório de cargas em custódia</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-lock text-warning"></i>
                                Campos: 001*,002,003*,018,006,008,009
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('custodia')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('custodia')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- DAPES Sem Carga em Aberto -->
                <div class="report-card" data-report="dapes-sem-carga">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('dapes-sem-carga')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>DAPES Sem Carga em Aberto</h4>
                        <p>Relatório de DAPES sem carga em aberto</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-exclamation text-danger"></i>
                                Campos: 001*,002*,003,006,008,007,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('dapes-sem-carga')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('dapes-sem-carga')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Demonstrativo Cargas Analítico -->
                <div class="report-card" data-report="demonstrativo-cargas">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('demonstrativo-cargas')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Demonstrativo Cargas Analítico</h4>
                        <p>Demonstrativo analítico de cargas</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-chart-line text-info"></i>
                                Campos: 001*,002,003*,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('demonstrativo-cargas')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('demonstrativo-cargas')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Descontos -->
                <div class="report-card" data-report="descontos">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-percent"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('descontos')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Descontos</h4>
                        <p>Relatório de descontos aplicados</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-tag text-success"></i>
                                Campos: 001*,002,003,018,006,008
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('descontos')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('descontos')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Exportações -->
                <div class="report-card" data-report="exportacoes">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-ship"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('exportacoes')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Exportações</h4>
                        <p>Relatório de operações de exportação</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-globe text-primary"></i>
                                Campos: 001*,002*,003,006,008,018,027
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('exportacoes')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('exportacoes')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Perfil de Cliente -->
                <div class="report-card" data-report="perfil-cliente">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('perfil-cliente')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Perfil de Cliente</h4>
                        <p>Relatório de perfil dos clientes</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-id-card text-info"></i>
                                Campos: 001*,002,003,006,008,018,024,025
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('perfil-cliente')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('perfil-cliente')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Serviços x Faturamento -->
                <div class="report-card" data-report="servicos-faturamento">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('servicos-faturamento')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Serviços x Faturamento</h4>
                        <p>Relatório de serviços versus faturamento</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-balance-scale text-success"></i>
                                Campos: 001*,002*,003,006,007,008,009,018
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('servicos-faturamento')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('servicos-faturamento')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>

                <!-- Vistorias -->
                <div class="report-card" data-report="vistorias">
                    <div class="report-header">
                        <div class="report-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <button class="btn-favorite" onclick="toggleFavorite('vistorias')" title="Adicionar aos favoritos">
                            <i class="far fa-star"></i>
                        </button>
                    </div>
                    <div class="report-content">
                        <h4>Vistorias</h4>
                        <p>Relatório de vistorias realizadas</p>
                        <div class="report-stats">
                            <span class="stat-item">
                                <i class="fas fa-clipboard-check text-warning"></i>
                                Campos: 001*,002,003,018,006,008,021
                            </span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="openReport('vistorias')">
                            <i class="fas fa-eye"></i> Visualizar
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport('vistorias')">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<!-- Modal de Visualização de Relatório -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>
                    <span id="reportTitle">Relatório</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros do Relatório -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="dateFrom" class="form-label">Data Inicial</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label for="dateTo" class="form-label">Data Final</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    <div class="col-md-3">
                        <label for="filterField" class="form-label">Filtro Adicional</label>
                        <select class="form-select" id="filterField">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <!-- Informações do Relatório (removido) -->

                <!-- Tabela de Dados -->
                <div class="table-responsive" id="reportTableContainer" style="display: none;">
                    <table class="table table-striped table-hover" id="reportTable">
                        <thead class="table-dark" id="reportTableHead">
                            <!-- Cabeçalhos serão preenchidos dinamicamente -->
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Dados serão preenchidos dinamicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Gráficos -->
                <div class="row mt-4" id="chartsContainer" style="display: none;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Gráfico de Barras</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="barChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Gráfico de Pizza</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="pieChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div class="text-center py-5" id="loadingState" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3">Gerando relatório...</p>
                </div>

                <!-- Empty State -->
                <div class="text-center py-5" id="emptyState" style="display: none;">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum dado encontrado</h5>
                    <p class="text-muted">Ajuste os filtros e tente novamente</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" onclick="exportCurrentReport()" id="exportBtn" disabled>
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let currentReportType = null;
let reportModal = null;

// Dados dos relatórios (simulados)
const reportsData = {
    'cargas-armazenadas-60': {
        name: 'Cargas Armazenadas +60 Dias',
        description: 'Relatório de cargas armazenadas há mais de 60 dias no terminal',
        fields: ['003*', '006', '008', '018'],
        icon: 'fa-warehouse',
        color: 'warning',
        columns: ['ID', 'Consignatário', 'Data Entrada', 'Dias Armazenado', 'Status'],
        sampleData: [
            ['001', 'Empresa ABC Ltda', '2024-01-15', '75', 'Aguardando Retirada'],
            ['002', 'Comércio XYZ S/A', '2024-01-20', '70', 'Aguardando Retirada'],
            ['003', 'Indústria DEF Ltda', '2024-01-25', '65', 'Aguardando Retirada']
        ]
    },
    'cargas-consignatario': {
        name: 'Cargas Armazenadas por Consignatário',
        description: 'Análise de cargas agrupadas por consignatário',
        fields: ['003*', '006', '008', '009'],
        icon: 'fa-building',
        color: 'info',
        columns: ['Consignatário', 'Total Cargas', 'Valor Total', 'Última Entrada'],
        sampleData: [
            ['Empresa ABC Ltda', '15', 'R$ 45.000,00', '2024-01-25'],
            ['Comércio XYZ S/A', '8', 'R$ 32.000,00', '2024-01-20'],
            ['Indústria DEF Ltda', '12', 'R$ 28.500,00', '2024-01-18']
        ]
    },
    'cargas-isencao': {
        name: 'Cargas com Isenção',
        description: 'Relatório de cargas com isenção fiscal aplicada',
        fields: ['001*', '002', '003*', '018', '006', '008'],
        icon: 'fa-gift',
        color: 'success',
        columns: ['ID', 'Tipo Isenção', 'Consignatário', 'Valor Isento', 'Data', 'Status'],
        sampleData: [
            ['001', 'Isenção Tributária', 'Empresa ABC Ltda', 'R$ 5.000,00', '2024-01-15', 'Aprovada'],
            ['002', 'Isenção de ICMS', 'Comércio XYZ S/A', 'R$ 3.200,00', '2024-01-20', 'Aprovada'],
            ['003', 'Isenção de IPI', 'Indústria DEF Ltda', 'R$ 7.800,00', '2024-01-25', 'Pendente']
        ]
    },
    'cargas-entregues': {
        name: 'Cargas Entregues',
        description: 'Relatório de cargas entregues aos clientes',
        fields: ['001*', '002*', '003*', '004', '006', '008', '009', '014', '018'],
        icon: 'fa-truck',
        color: 'success',
        columns: ['ID', 'Cliente', 'Data Entrega', 'Valor', 'Transportadora', 'Status'],
        sampleData: [
            ['001', 'Empresa ABC Ltda', '2024-01-20', 'R$ 15.000,00', 'Transportadora A', 'Entregue'],
            ['002', 'Comércio XYZ S/A', '2024-01-22', 'R$ 8.500,00', 'Transportadora B', 'Entregue'],
            ['003', 'Indústria DEF Ltda', '2024-01-25', 'R$ 12.300,00', 'Transportadora A', 'Entregue']
        ]
    },
    'clientes-correntistas': {
        name: 'Clientes Correntistas',
        description: 'Relatório de clientes correntistas do sistema',
        fields: ['001*', '002*', '003', '006', '008', '018'],
        icon: 'fa-user-tie',
        color: 'primary',
        columns: ['Cliente', 'CNPJ', 'Última Movimentação', 'Saldo', 'Status'],
        sampleData: [
            ['Empresa ABC Ltda', '12.345.678/0001-90', '2024-01-25', 'R$ 15.000,00', 'Ativo'],
            ['Comércio XYZ S/A', '98.765.432/0001-10', '2024-01-20', 'R$ 8.500,00', 'Ativo'],
            ['Indústria DEF Ltda', '11.222.333/0001-44', '2024-01-18', 'R$ 12.300,00', 'Ativo']
        ]
    },
    'cargas-entregues-processo': {
        name: 'Cargas Entregues (Processo)',
        description: 'Relatório de cargas entregues por processo',
        fields: ['001*', '002*', '003*', '004', '006', '008', '009', '014', '018'],
        icon: 'fa-cogs',
        color: 'primary',
        columns: ['ID', 'Processo', 'Cliente', 'Data Entrega', 'Status'],
        sampleData: [
            ['001', 'PROC-2024-001', 'Empresa ABC Ltda', '2024-01-20', 'Concluído'],
            ['002', 'PROC-2024-002', 'Comércio XYZ S/A', '2024-01-22', 'Em Andamento'],
            ['003', 'PROC-2024-003', 'Indústria DEF Ltda', '2024-01-25', 'Concluído']
        ]
    },
    'cargas-entregues-dta': {
        name: 'Cargas Entregues DTA',
        description: 'Relatório de cargas entregues com DTA',
        fields: ['001*', '002*', '003', '004', '006', '008', '018'],
        icon: 'fa-file-alt',
        color: 'info',
        columns: ['ID', 'DTA', 'Cliente', 'Data Entrega', 'Valor'],
        sampleData: [
            ['001', 'DTA-2024-001', 'Empresa ABC Ltda', '2024-01-20', 'R$ 15.000,00'],
            ['002', 'DTA-2024-002', 'Comércio XYZ S/A', '2024-01-22', 'R$ 8.500,00'],
            ['003', 'DTA-2024-003', 'Indústria DEF Ltda', '2024-01-25', 'R$ 12.300,00']
        ]
    },
    'custodia': {
        name: 'Custódia',
        description: 'Relatório de cargas em custódia',
        fields: ['001*', '002', '003*', '018', '006', '008', '009'],
        icon: 'fa-shield-alt',
        color: 'warning',
        columns: ['ID', 'Cliente', 'Data Entrada', 'Tipo Custódia', 'Status'],
        sampleData: [
            ['001', 'Empresa ABC Ltda', '2024-01-15', 'Custódia Judicial', 'Ativa'],
            ['002', 'Comércio XYZ S/A', '2024-01-20', 'Custódia Administrativa', 'Ativa'],
            ['003', 'Indústria DEF Ltda', '2024-01-25', 'Custódia Fiscal', 'Ativa']
        ]
    },
    'dapes-sem-carga': {
        name: 'DAPES Sem Carga em Aberto',
        description: 'Relatório de DAPES sem carga em aberto',
        fields: ['001*', '002*', '003', '006', '008', '007', '018'],
        icon: 'fa-exclamation-triangle',
        color: 'danger',
        columns: ['DAPES', 'Cliente', 'Data Emissão', 'Status', 'Observações'],
        sampleData: [
            ['DAPES-001', 'Empresa ABC Ltda', '2024-01-15', 'Pendente', 'Aguardando documentação'],
            ['DAPES-002', 'Comércio XYZ S/A', '2024-01-20', 'Pendente', 'Em análise'],
            ['DAPES-003', 'Indústria DEF Ltda', '2024-01-25', 'Pendente', 'Aguardando liberação']
        ]
    },
    'demonstrativo-cargas': {
        name: 'Demonstrativo Cargas Analítico',
        description: 'Demonstrativo analítico de cargas',
        fields: ['001*', '002', '003*', '018'],
        icon: 'fa-chart-pie',
        color: 'info',
        columns: ['Período', 'Total Cargas', 'Valor Total', 'Crescimento'],
        sampleData: [
            ['Janeiro 2024', '150', 'R$ 450.000,00', '+15%'],
            ['Fevereiro 2024', '180', 'R$ 520.000,00', '+12%'],
            ['Março 2024', '165', 'R$ 480.000,00', '+8%']
        ]
    },
    'descontos': {
        name: 'Descontos',
        description: 'Relatório de descontos aplicados',
        fields: ['001*', '002', '003', '018', '006', '008'],
        icon: 'fa-percent',
        color: 'success',
        columns: ['ID', 'Cliente', 'Tipo Desconto', 'Valor', 'Data'],
        sampleData: [
            ['001', 'Empresa ABC Ltda', 'Desconto por Volume', 'R$ 2.500,00', '2024-01-15'],
            ['002', 'Comércio XYZ S/A', 'Desconto Promocional', 'R$ 1.200,00', '2024-01-20'],
            ['003', 'Indústria DEF Ltda', 'Desconto Fidelidade', 'R$ 3.000,00', '2024-01-25']
        ]
    },
    'exportacoes': {
        name: 'Exportações',
        description: 'Relatório de operações de exportação',
        fields: ['001*', '002*', '003', '006', '008', '018', '027'],
        icon: 'fa-ship',
        color: 'primary',
        columns: ['ID', 'Cliente', 'Destino', 'Data Exportação', 'Valor'],
        sampleData: [
            ['001', 'Empresa ABC Ltda', 'China', '2024-01-15', 'R$ 25.000,00'],
            ['002', 'Comércio XYZ S/A', 'EUA', '2024-01-20', 'R$ 18.500,00'],
            ['003', 'Indústria DEF Ltda', 'Alemanha', '2024-01-25', 'R$ 32.000,00']
        ]
    },
    'perfil-cliente': {
        name: 'Perfil de Cliente',
        description: 'Relatório de perfil dos clientes',
        fields: ['001*', '002', '003', '006', '008', '018', '024', '025'],
        icon: 'fa-user-circle',
        color: 'info',
        columns: ['Cliente', 'Segmento', 'Última Compra', 'Faturamento Total'],
        sampleData: [
            ['Empresa ABC Ltda', 'Grande Porte', '2024-01-25', 'R$ 150.000,00'],
            ['Comércio XYZ S/A', 'Médio Porte', '2024-01-20', 'R$ 85.000,00'],
            ['Indústria DEF Ltda', 'Grande Porte', '2024-01-18', 'R$ 120.000,00']
        ]
    },
    'servicos-faturamento': {
        name: 'Serviços x Faturamento',
        description: 'Relatório de serviços versus faturamento',
        fields: ['001*', '002*', '003', '006', '007', '008', '009', '018'],
        icon: 'fa-calculator',
        color: 'success',
        columns: ['Serviço', 'Quantidade', 'Valor Unitário', 'Total'],
        sampleData: [
            ['Armazenagem', '150', 'R$ 50,00', 'R$ 7.500,00'],
            ['Movimentação', '300', 'R$ 25,00', 'R$ 7.500,00'],
            ['Inspeção', '75', 'R$ 100,00', 'R$ 7.500,00']
        ]
    },
    'vistorias': {
        name: 'Vistorias',
        description: 'Relatório de vistorias realizadas',
        fields: ['001*', '002', '003', '018', '006', '008', '021'],
        icon: 'fa-search',
        color: 'warning',
        columns: ['ID', 'Cliente', 'Data Vistoria', 'Tipo', 'Status'],
        sampleData: [
            ['001', 'Empresa ABC Ltda', '2024-01-15', 'Vistoria de Entrada', 'Aprovada'],
            ['002', 'Comércio XYZ S/A', '2024-01-20', 'Vistoria de Saída', 'Pendente'],
            ['003', 'Indústria DEF Ltda', '2024-01-25', 'Vistoria de Segurança', 'Aprovada']
        ]
    }
};

// Funções específicas para relatórios comerciais
function openReport(reportType) {
    console.log('Abrindo relatório comercial:', reportType);
    
    currentReportType = reportType;
    
    // Primeiro, tentar obter do sistema centralizado
    let report = null;
    if (window.ALL_REPORTS_DATA && window.ALL_REPORTS_DATA[reportType]) {
        const reportData = window.ALL_REPORTS_DATA[reportType];
        report = {
            name: reportData.name,
            description: reportData.description || 'Relatório personalizado',
            fields: reportData.fields,
            icon: reportData.icon,
            color: reportData.color,
            columns: getDefaultColumns(reportType),
            sampleData: getDefaultSampleData(reportType)
        };
    } else {
        // Fallback para dados locais
        report = reportsData[reportType];
    }
    
    if (!report) {
        alert('Relatório não encontrado!');
        return;
    }
    
    // Configurar modal
    setupReportModal(report);
    
    // Abrir modal
    if (!reportModal) {
        reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    }
    reportModal.show();
}

// Funções utilitárias movidas para reports-utils.js

function setupReportModal(report) {
    // Atualizar título
    document.getElementById('reportTitle').textContent = report.name;
    
    // Configurar filtros específicos do relatório
    setupReportFilters(report);
    
    // Limpar dados anteriores
    clearReportData();
}

function setupReportFilters(report) {
    const filterField = document.getElementById('filterField');
    filterField.innerHTML = '<option value="">Selecione...</option>';
    
    // Adicionar opções específicas baseadas no tipo de relatório
    const filterOptions = {
        'cargas-armazenadas-60': [
            { value: 'status', text: 'Status' },
            { value: 'consignatario', text: 'Consignatário' }
        ],
        'cargas-consignatario': [
            { value: 'consignatario', text: 'Consignatário' },
            { value: 'periodo', text: 'Período' }
        ],
        'cargas-isencao': [
            { value: 'tipo-isencao', text: 'Tipo de Isenção' },
            { value: 'status', text: 'Status' }
        ],
        'cargas-entregues': [
            { value: 'cliente', text: 'Cliente' },
            { value: 'transportadora', text: 'Transportadora' }
        ],
        'clientes-correntistas': [
            { value: 'status', text: 'Status' },
            { value: 'saldo', text: 'Faixa de Saldo' }
        ]
    };
    
    const options = filterOptions[currentReportType] || [];
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        filterField.appendChild(optionElement);
    });
    
    // Configurar datas padrão
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('dateFrom').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
}

function clearReportData() {
    document.getElementById('reportTableContainer').style.display = 'none';
    document.getElementById('chartsContainer').style.display = 'none';
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('exportBtn').disabled = true;
}

function generateReport() {
    const report = reportsData[currentReportType];
    if (!report) return;
    
    // Mostrar loading
    clearReportData();
    document.getElementById('loadingState').style.display = 'block';
    
    // Simular carregamento
    setTimeout(() => {
        loadReportData(report);
    }, 1500);
}

function loadReportData(report) {
    // Esconder loading
    document.getElementById('loadingState').style.display = 'none';
    
    // Verificar se há dados
    if (!report.sampleData || report.sampleData.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    
    // Preencher tabela
    populateReportTable(report);
    
    // Mostrar tabela
    document.getElementById('reportTableContainer').style.display = 'block';
    
    // Habilitar exportação
    document.getElementById('exportBtn').disabled = false;
    
    // Gerar gráficos (opcional)
    if (report.sampleData.length > 0) {
        generateCharts(report);
    }
}

function populateReportTable(report) {
    const tableHead = document.getElementById('reportTableHead');
    const tableBody = document.getElementById('reportTableBody');
    
    // Limpar tabela
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    
    // Criar cabeçalho
    const headerRow = document.createElement('tr');
    report.columns.forEach(column => {
        const th = document.createElement('th');
        th.textContent = column;
        headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);
    
    // Preencher dados
    report.sampleData.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

function generateCharts(report) {
    // Mostrar container de gráficos
    document.getElementById('chartsContainer').style.display = 'block';
    
    // Simular geração de gráficos
    console.log('Gerando gráficos para:', report.name);
    // TODO: Implementar Chart.js ou similar
}

function exportCurrentReport() {
    if (!currentReportType) return;
    
    const report = reportsData[currentReportType];
    if (!report) return;
    
    // Simular exportação
    alert(`Exportando relatório: ${report.name}\n\nFormatos disponíveis:\n- PDF\n- Excel\n- CSV\n\nEsta funcionalidade será implementada em breve.`);
}

function exportReport(reportType) {
    console.log('Exportando relatório comercial:', reportType);
    
    // Mapear tipos de relatório para nomes amigáveis
    const reportNames = {
        'cargas-armazenadas-60': 'Cargas Armazenadas +60 Dias',
        'cargas-consignatario': 'Cargas Armazenadas por Consignatário',
        'cargas-isencao': 'Cargas com Isenção',
        'cargas-entregues': 'Cargas Entregues',
        'cargas-entregues-processo': 'Cargas Entregues (Processo)',
        'cargas-entregues-dta': 'Cargas Entregues DTA',
        'clientes-correntistas': 'Clientes Correntistas',
        'custodia': 'Custódia',
        'dapes-sem-carga': 'DAPES Sem Carga em Aberto',
        'demonstrativo-cargas': 'Demonstrativo Cargas Analítico',
        'descontos': 'Descontos',
        'exportacoes': 'Exportações',
        'perfil-cliente': 'Perfil de Cliente',
        'servicos-faturamento': 'Serviços x Faturamento',
        'vistorias': 'Vistorias'
    };
    
    const reportName = reportNames[reportType] || reportType;
    
    // Por enquanto, mostrar um alerta
    alert(`Exportando relatório: ${reportName}\n\nFormatos disponíveis:\n- PDF\n- Excel\n- CSV\n\nEsta funcionalidade será implementada em breve.`);
    
    // TODO: Implementar exportação real
    // Exemplo: window.location.href = `/api/reports/comercial/${reportType}/export?format=pdf`;
}

// ========================================
// SISTEMA DE FAVORITOS
// ========================================

// Carregar favoritos do localStorage
function loadFavorites() {
    const favorites = JSON.parse(localStorage.getItem('reportFavorites') || '[]');
    return favorites;
}

// Salvar favoritos no localStorage
function saveFavorites(favorites) {
    localStorage.setItem('reportFavorites', JSON.stringify(favorites));
}

// Alternar favorito
function toggleFavorite(reportType) {
    const favorites = loadFavorites();
    const index = favorites.indexOf(reportType);
    
    if (index > -1) {
        // Remover dos favoritos
        favorites.splice(index, 1);
        updateFavoriteButton(reportType, false);
    } else {
        // Adicionar aos favoritos
        favorites.push(reportType);
        updateFavoriteButton(reportType, true);
    }
    
    saveFavorites(favorites);
    updateFavoritesSection();
}

// Atualizar botão de favorito
function updateFavoriteButton(reportType, isFavorite) {
    const button = document.querySelector(`[data-report="${reportType}"] .btn-favorite i`);
    if (button) {
        if (isFavorite) {
            button.className = 'fas fa-star';
            button.parentElement.title = 'Remover dos favoritos';
        } else {
            button.className = 'far fa-star';
            button.parentElement.title = 'Adicionar aos favoritos';
        }
    }
}

// Atualizar seção de favoritos
function updateFavoritesSection() {
    const favorites = loadFavorites();
    updateFavoritesSectionCentral(favorites, 'favorites-container', 'comercial');
}

// Função createFavoriteCard movida para reports-utils.js

// Limpar todos os favoritos
function clearAllFavorites() {
    if (confirm('Tem certeza que deseja remover todos os favoritos?')) {
        saveFavorites([]);
        updateFavoritesSection();
        
        // Atualizar todos os botões de favorito
        document.querySelectorAll('.btn-favorite i').forEach(icon => {
            icon.className = 'far fa-star';
            icon.parentElement.title = 'Adicionar aos favoritos';
        });
    }
}

// ========================================
// SISTEMA DE SELEÇÃO RÁPIDA
// ========================================

// Selecionar relatório do dropdown
function selectReportFromDropdown() {
    const select = document.getElementById('reportSelect');
    const openBtn = document.getElementById('openReportBtn');
    
    if (select.value) {
        openBtn.disabled = false;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    } else {
        openBtn.disabled = true;
        openBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Abrir Relatório';
    }
}

// Abrir relatório selecionado
function openSelectedReport() {
    const select = document.getElementById('reportSelect');
    const reportType = select.value;
    
    if (reportType) {
        openReport(reportType);
        // Scroll para o card do relatório
        const reportCard = document.querySelector(`[data-report="${reportType}"]`);
        if (reportCard) {
            reportCard.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Destacar o card temporariamente
            reportCard.style.border = '2px solid #007bff';
            reportCard.style.boxShadow = '0 0 15px rgba(0, 123, 255, 0.3)';
            
            setTimeout(() => {
                reportCard.style.border = '';
                reportCard.style.boxShadow = '';
            }, 2000);
        }
    }
}

// Inicializar página
document.addEventListener('DOMContentLoaded', function() {
    // O sistema de sincronização automática já carrega os relatórios
    // Apenas inicializar funcionalidades específicas do módulo
    
    // Carregar favoritos
    const favorites = loadFavorites();
    
    // Atualizar botões de favorito
    favorites.forEach(reportType => {
        updateFavoriteButton(reportType, true);
    });
    
    // Atualizar seção de favoritos
    updateFavoritesSection();
    
    // Inicializar dropdown
    selectReportFromDropdown();
});

</script>

<!-- Estilos movidos para reports.css -->

{% endblock %}

