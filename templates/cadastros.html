{% extends "base.html" %}

{% block title %}Cadastros - Sistema Aduaneiro{% endblock %}

{% block body_class %}main-body{% endblock %}

{% block content %}
<aside class="sidebar">
    <nav>
        <img src="{{ url_for('static', filename='img/logo_paclog_branco_tela_principal.png') }}" alt="Logo Paclog" class="logo-sidebar">
        <ul class="sidebar-links">
            <li><a href="{{ url_for('dashboard') }}" class="nav-link"><i class="fas fa-home"></i> <span>Home</span></a></li>
            <li><a href="#operacional" class="nav-link"><i class="fas fa-tasks"></i> <span>Operacional</span></a></li>
            <li><a href="#faturamento" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> <span>Faturamento</span></a></li>
            <li><a href="#web-cliente" class="nav-link"><i class="fas fa-user-tie"></i> <span>Web Cliente</span></a></li>
            <li><a href="#portal-adm" class="nav-link"><i class="fas fa-user-shield"></i> <span>Portal ADM</span></a></li>
            <li><a href="{{ url_for('cadastros') }}" class="nav-link active"><i class="fas fa-edit"></i> <span>Cadastros</span></a></li>
            <li><a href="#relatorios" class="nav-link"><i class="fas fa-chart-line"></i> <span>Relatórios</span></a></li>
            <li><a href="#" class="nav-link" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></a></li>
        </ul>
    </nav>
</aside>

<main class="content main-content--shifted">
    <div class="content-section active">
        <div class="container-fluid">
            <h2>Cadastro de Usuário</h2>

            <div id="user-list-view">
                <div class="actions-container">
                    <form method="GET" class="search-group">
                        <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="Pesquisar por nome, sobrenome, email ou CPF...">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Pesquisar</button>
                        {% if search %}
                        <a href="{{ url_for('cadastros') }}" class="btn btn-secondary"><i class="fas fa-times"></i> Limpar</a>
                        {% endif %}
                    </form>
                    <button id="add-user-btn" class="btn btn-success"><i class="fas fa-plus"></i> Adicionar Usuário</button>
                </div>

                <div class="user-table-container">
                    <h3>Usuários Cadastrados</h3>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome</th>
                                    <th>Sobrenome</th>
                                    <th>CPF</th>
                                    <th>E-mail</th>
                                    <th>Grupo</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                {% for user in users.items %}
                                <tr>
                                    <td>{{ user.name }}</td>
                                    <td>{{ user.lastname }}</td>
                                    <td>{{ user.cpf }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ user.group }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if user.status == 'active' else 'danger' }}">
                                            {{ 'Ativo' if user.status == 'active' else 'Bloqueado' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <button class="dropdown-item edit-user" data-user-id="{{ user.id }}">
                                                        <i class="fas fa-edit me-2"></i>Editar
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item toggle-status" data-user-id="{{ user.id }}">
                                                        <i class="fas fa-{{ 'lock' if user.status == 'active' else 'unlock' }} me-2"></i>
                                                        {{ 'Bloquear' if user.status == 'active' else 'Desbloquear' }}
                                                    </button>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <button class="dropdown-item text-danger delete-user" data-user-id="{{ user.id }}">
                                                        <i class="fas fa-trash me-2"></i>Excluir
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    {% if users.pages > 1 %}
                    <nav aria-label="Paginação de usuários">
                        <ul class="pagination justify-content-center">
                            {% if users.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('cadastros', page=users.prev_num, search=search) }}">Anterior</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in users.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != users.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('cadastros', page=page_num, search=search) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if users.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('cadastros', page=users.next_num, search=search) }}">Próximo</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    
                    <div class="text-center">
                        <small class="text-muted">
                            Mostrando {{ users.items|length }} de {{ users.total }} usuários
                        </small>
                    </div>
                </div>
            </div>

            <!-- Modal para Adicionar/Editar Usuário -->
            <div class="modal fade" id="userModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalTitle">Adicionar Novo Usuário</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form id="user-form">
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Nome *</label>
                                            <input type="text" class="form-control" id="name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="lastname" class="form-label">Sobrenome *</label>
                                            <input type="text" class="form-control" id="lastname" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cpf" class="form-label">CPF *</label>
                                            <input type="text" class="form-control" id="cpf" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">E-mail *</label>
                                            <input type="email" class="form-control" id="email" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="password" class="form-label">Senha *</label>
                                            <input type="password" class="form-control" id="password">
                                            <div class="form-text">Deixe em branco para manter a senha atual (apenas para edição)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="group" class="form-label">Grupo *</label>
                                            <select class="form-select" id="group" required>
                                                <option value="">Selecione um grupo</option>
                                                <option value="Paclog Faturamento">Paclog Faturamento</option>
                                                <option value="Paclog ADM">Paclog ADM</option>
                                                <option value="Paclog Operacional">Paclog Operacional</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Status do Usuário</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status-active" value="active" checked>
                                        <label class="form-check-label" for="status-active">Ativado</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="status" id="status-blocked" value="blocked">
                                        <label class="form-check-label" for="status-blocked">Bloqueado</label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Permissões</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="permission" value="cadastrar-processo" id="perm-cadastrar">
                                                <label class="form-check-label" for="perm-cadastrar">Cadastrar Processo</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="permission" value="editar-processo" id="perm-editar">
                                                <label class="form-check-label" for="perm-editar">Editar Processos</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="permission" value="visualizar-processo" id="perm-visualizar">
                                                <label class="form-check-label" for="perm-visualizar">Visualizar Processos</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="permission" value="cancelar-processo" id="perm-cancelar">
                                                <label class="form-check-label" for="perm-cancelar">Cancelar Processo</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="permission" value="alterar-senha" id="perm-alterar-senha">
                                                <label class="form-check-label" for="perm-alterar-senha">Alterar Senha</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Salvar Usuário
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let currentUserId = null;

// Event listeners
document.getElementById('add-user-btn').addEventListener('click', () => {
    currentUserId = null;
            document.getElementById('modalTitle').textContent = 'Adicionar Novo Usuário';
            document.getElementById('user-form').reset();
            document.getElementById('password').required = true;
            document.getElementById('password').placeholder = 'Digite a senha';
            new bootstrap.Modal(document.getElementById('userModal')).show();
});

document.getElementById('user-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Get permissions
    const permissions = Array.from(document.querySelectorAll('input[name="permission"]:checked')).map(cb => cb.value);
    data.permissions = JSON.stringify(permissions);
    
    try {
        const url = currentUserId ? `/api/users/${currentUserId}` : '/api/users';
        const method = currentUserId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert(error.error || 'Erro ao salvar usuário');
        }
    } catch (error) {
        alert('Erro ao salvar usuário');
    }
});

// Edit user
document.addEventListener('click', async (e) => {
    if (e.target.closest('.edit-user')) {
        const userId = e.target.closest('.edit-user').dataset.userId;
        currentUserId = userId;
        
        try {
            const response = await fetch(`/api/users/${userId}`);
            const user = await response.json();
            
            document.getElementById('modalTitle').textContent = 'Editar Usuário';
            document.getElementById('name').value = user.name;
            document.getElementById('lastname').value = user.lastname;
            document.getElementById('cpf').value = user.cpf;
            document.getElementById('email').value = user.email;
            document.getElementById('group').value = user.group;
            document.getElementById('password').required = false;
            document.getElementById('password').placeholder = 'Deixe em branco para manter a senha atual';
            
            // Set status
            document.querySelector(`input[name="status"][value="${user.status}"]`).checked = true;
            
            // Set permissions
            const permissions = JSON.parse(user.permissions);
            document.querySelectorAll('input[name="permission"]').forEach(cb => {
                cb.checked = permissions.includes(cb.value);
            });
            
            new bootstrap.Modal(document.getElementById('userModal')).show();
        } catch (error) {
            alert('Erro ao carregar dados do usuário');
        }
    }
});

// Delete user
document.addEventListener('click', async (e) => {
    if (e.target.closest('.delete-user')) {
        if (confirm('Tem certeza que deseja excluir este usuário?')) {
            const userId = e.target.closest('.delete-user').dataset.userId;
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Erro ao excluir usuário');
                }
            } catch (error) {
                alert('Erro ao excluir usuário');
            }
        }
    }
});

// Toggle status
document.addEventListener('click', async (e) => {
    if (e.target.closest('.toggle-status')) {
        const userId = e.target.closest('.toggle-status').dataset.userId;
        
        try {
            const response = await fetch(`/api/users/${userId}`);
            const user = await response.json();
            const newStatus = user.status === 'active' ? 'blocked' : 'active';
            
            const updateResponse = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ...user,
                    status: newStatus
                })
            });
            
            if (updateResponse.ok) {
                location.reload();
            } else {
                alert('Erro ao alterar status do usuário');
            }
        } catch (error) {
            alert('Erro ao alterar status do usuário');
        }
    }
});
</script>
{% endblock %}

